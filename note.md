# ç¯å¢ƒ

æ²¡å¿…è¦ç”¨vimã€‚

å…³äºIntelliSenseï¼ŒVSCodeéœ€è¦å®‰è£…`c/c++`ã€`Makefile Tools`æ’ä»¶ï¼Œè‡³å°‘è¿™åœ¨PA1ä¸­è¿˜æœ‰ç‚¹ç”¨ã€‚åˆ°PA2çš„abstract machineä¸­ï¼Œè¿™ä¸ªæ’ä»¶è²Œä¼¼å°±æ²¡æ³•è¯†åˆ«å‡º`gcc -D`å®šä¹‰çš„ä¸€å †defineäº†â“

> å› ä¸ºæ˜¯ç”¨makeè¿›è¡Œç¼–è¯‘çš„å¤æ‚é¡¹ç›®ï¼Œ`c/c++` IntelliSense éœ€è¦çŸ¥é“å…·ä½“æ˜¯æ€ä¹ˆmakeçš„ï¼Œæ‰€ä»¥å¿…é¡»å®‰è£…`Makefile Tools`æ‰ä¸ä¼šå‡ºç°ä¸€å †"Identifier not found"çº¢çº¿ï¼Œè§[Configure C/C++ IntelliSense - Configuration providers](https://code.visualstudio.com/docs/cpp/configure-intellisense#_configuration-providers)ï¼š`Ctrl+Shift+P` `C/C++ Change Configuration provider` -> Select `Makefile Tools`ï¼Œ"If it identifies only one custom configuration provider, this configuration provider is automatically configured for IntelliSense"

## è°ƒè¯•NEMU

å¯ä»¥é…ç½®åˆ°VSCodeé‡Œè°ƒè¯•ï¼Œä¼ å…¥`-nb`æ‰“å°å‡ºmake gdbæ—¶äº§å‡ºçš„gdbå‘½ä»¤ï¼Œé…ç½®vscodeçš„`launch.json`ã€‚

> ä»¥nemuéƒ¨åˆ†çš„è°ƒè¯•ä¸ºä¾‹ï¼Œ`make gdb`ç»™å‡ºäº†`gdb -s /home/hc/ics-pa-2023/nemu/build/riscv32-nemu-interpreter --args /home/hc/ics-pa-2023/nemu/build/riscv32-nemu-interpreter --log=/home/hc/ics-pa-2023/nemu/build/nemu-log.txt`ï¼Œäºæ˜¯åœ¨vscodeä¸­ç”Ÿæˆè°ƒè¯•é…ç½®æ–‡ä»¶`launch.json`ï¼ŒAdd Configuationï¼Œé€‰æ‹©`Nemu GDB`
> 
> ```json
> {
>     "version": "0.2.0",
>     "configurations": [
>         {
>             "name": "Nemu GDB",
>             "type": "cppdbg",
>             "preLaunchTask": "Make",
>             "request": "launch",
>             "program": "${workspaceFolder}/build/riscv32-nemu-interpreter",
>             "args": [
>                 "--log=${workspaceFolder}/build/nemu-log.txt",
>             ],
>             "stopAtEntry": false,
>             "cwd": "${fileDirname}",
>             "environment": [],
>             "externalConsole": false,
>             "MIMode": "gdb",
>             "setupCommands": [
>                 {
>                     "description": "Enable pretty-printing for gdb",
>                     "text": "-enable-pretty-printing",
>                     "ignoreFailures": true
>                 },
>                 {
>                     "description": "Set Disassembly Flavor to Intel",
>                     "text": "-gdb-set disassembly-flavor intel",
>                     "ignoreFailures": true
>                 }
>             ]
>         },
>     ]
> }
> ```

å…¶å®ç”¨æƒ¯äº†gdbï¼Œä¹Ÿå°±`b func` `n` `s` `layout split` `p EXPR`ï¼Œç›´æ¥åœ¨Terminalé‡Œè°ƒè¯•ä¹ŸæŒºæ–¹ä¾¿çš„ã€‚

## è°ƒè¯•AM+å®¢æˆ·ç¨‹åº

è§[PA2.4](#2.4)

# ï¼ˆéœ€è¦è¡¥ä¹ çš„ï¼‰å‰ç½®çŸ¥è¯†

- RISC-Vï¼šPA2æ˜¯unprivilegedï¼ŒCS61Cå°±å¤Ÿç”¨äº†ã€‚PA3ã€PA4æ¶‰åŠprivilegedï¼ŒPA3è¦trapï¼ŒPA4è¦åˆ†é¡µï¼Œéœ€è¦è¡¥ä¹ ã€‚ç¬”è®°è§[Notes](https://github.com/Holence/Notes/blob/main/Arch/RISC-V/RISC-V.md)
- Makefileï¼šè™½ç„¶PA1ä¸­å¯ä»¥ä¸ç”¨ç†è§£Makefileï¼Œä½†PA2é‡Œå°±éœ€è¦å…¨éƒ¨è¯»æ‡‚Makefileäº†ï¼Œæ‰€ä»¥æœ€å¥½ä¸€å¼€å§‹å°±æŒæ¡makeçš„è¯­æ³•ã€‚ç¬”è®°è§[Notes](https://github.com/Holence/Notes/blob/main/Tools/Make/Make.md)
- ELFï¼šPA2.4å’ŒPA3.3ä¸­éƒ½è¦æ‰‹å†™è§£æELFï¼Œå¯ä»¥çœ‹çœ‹ã€ŠSystem V generic ABIã€‹ç¬¬å››äº”ç« ï¼Œç¬”è®°è§[Notes](https://github.com/Holence/Notes/blob/main/OS/ELF.md)

# é‡è¦ä¿¡æ¯

## å…³äºAM

å‚è€ƒé˜…è¯»: [ä¸€ç”Ÿä¸€èŠ¯ - Abstract Machineè£¸æœºè¿è¡Œæ—¶ç¯å¢ƒ](https://www.bilibili.com/video/BV1Vu4y1s73Y/)

AMæœ€åˆæ˜¯ä¸ºäº†æŠŠISAå’ŒOSè§£è€¦ï¼Œè®©å­¦ç”Ÿè‡ªåˆ¶çš„å„ç§ISAçš„CPUå¯ä»¥è·‘å„ç§ä¸Šå±‚ç³»ç»Ÿï¼ŒAMä¸­æŠŠå„ç§ä¸åŒå‹å·çš„ç¡¬ä»¶æ¥å£è¿›è¡ŒæŠ½è±¡ï¼Œè€Œä¸Šå±‚ç³»ç»Ÿéƒ½ä½¿ç”¨AMæä¾›çš„æ¥å£ã€‚

nemuç›¸å½“äºæ˜¯ä¸€ä¸ªå¯ä»¥ä¸€æ¬¡æ€§æ‰§è¡Œå®Œä¸€æ®µç¨‹åºæœ€åè¿”å›ä¸€ä¸ªreturnå€¼çš„cpuï¼Œä»…ä»…æ˜¯ä¸€ä¸ªå›¾çµæœºï¼Œè¿è¡Œå®Œå°±ç»“æŸäº†ã€‚

nemuæ˜¯çº¯â€œç¡¬ä»¶â€çš„â€œè£¸æœºâ€ï¼Œam-kernelsé‡Œçš„ç¨‹åºã€ä»¥åŠnanoséƒ½æ˜¯ä¸Šå±‚çš„å®¢æˆ·ç¨‹åºï¼Œabstract-machineæ˜¯ä¸¤è€…ä¹‹é—´çš„æ¡¥æ¢ï¼Œæ˜¯â€œè£¸æœºâ€çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚

AMçš„äº”ä¸ªæ¨¡å—ï¼Œä»å‰å¾€åå¯¹åº”ç€è®¡ç®—æœºå†å²å‘å±•çš„è¿›ç¨‹ï¼š

- TRM (Turing Machine) æœ€ç®€å•çš„è¿è¡Œæ—¶ç¯å¢ƒ
  - init / halt
  - putch: æœ€åŸºç¡€çš„æ‰“å°å­—ç¬¦
  - heap: è§„å®šå †çš„åŒºé—´
  - klib: ä¸€äº›é€šç”¨ï¼ˆISAæ¶æ„æ— å…³ï¼‰çš„åº“å‡½æ•° stdio, stdlib, string
- IOE (I/O Extension) è®¿é—®å¤–è®¾çš„æ¥å£: å¯¹æ¥åˆ°ä¸åŒISAä¸‹CPUè®¿é—®å¤–è®¾çš„æ–¹æ³•
- CTE (Context Extension) ä¸Šä¸‹æ–‡æ‰©å±•: trapï¼ˆç³»ç»Ÿè°ƒç”¨ï¼Œä¸­æ–­ï¼Œå¼‚å¸¸ï¼‰
- VME (Virtual Memory Extension) è™šå­˜æ‰©å±•
- MPE (Multi-Processor Extension) å¤šå¤„ç†å™¨æ‰©å±•

## å…³äºfceuxçº¢ç™½æœºæ¨¡æ‹Ÿå™¨ç”»é¢æ— æ˜¾ç¤º

åšå®Œå£°å¡åè¿è¡Œçº¢ç™½æœºæ¨¡æ‹Ÿå™¨è·‘marioï¼Œå‘ç°ç¨‹åºåœ¨è·‘ï¼Œå¸§ç‡ä¹Ÿæœ‰ï¼ŒæŒ‰Ié”®è¿›å…¥æ¸¸æˆï¼Œä¹Ÿå¯ä»¥å¬åˆ°å£°éŸ³ï¼Œä½†å°±æ˜¯VGAæ²¡æœ‰ä»»ä½•æ˜¾ç¤ºã€‚

è§£å†³æ–¹æ³•ï¼š`/fceux-am/src/drivers/sdl/sdl.cpp`çš„`FCEUD_Update()`ä¸­ï¼ŒæŠŠå…³äºåˆ·æ–°å±å¹•çš„å‡½æ•°è°ƒç”¨`BlitScreen()`ä»¥åŠåŒ…è£¹å®ƒçš„åˆ¤æ–­éƒ½åˆ äº†ï¼Œåœ¨å‡½æ•°çš„æœ€å‰é¢è¿™æ ·è°ƒç”¨å°±è¡Œäº†ã€‚ï¼ˆnemuçš„å£°å¡å¼€å¯åï¼Œé‚£äº›åˆ¤æ–­éƒ½æ— æ³•æ»¡è¶³ï¼Œä¸æ‡‚åŸç†â“ï¼‰

```c
if(XBuf && (inited&4)) {
  BlitScreen(XBuf);
}
```

## PA4ä¹‹å‰çš„å†…å­˜åˆ†å¸ƒ

`/abstract-machine/scripts/linker.ld`ä¸­è§„å®šäº†å‡ ä¸ªåœ°å€ï¼Œæ€ä¹ˆå †åœ¨æ ˆçš„ä¸Šé¢â“è·Ÿæ™®éçš„å†…å­˜ç»“æ„æ¨¡å‹ä¸ä¸€æ ·å•Šï¼Ÿï¼Ÿ

```
PMEM_END:       0x88000000
                ğŸ‘†HEAP
_heap_start:    0x81C1A000
_stack_pointer: 0x81C1A000
                ğŸ‘‡STACK
_stack_top:     0x81C12000
lut[128]:       0x81C11230
_pmem_start:    0x80000000
```

è¿˜æœ‰ï¼Œä¹Ÿæ²¡è§`_stack_top`åœ¨å“ªé‡Œè¢«ä½¿ç”¨å•Šï¼Ÿç¡®å®åº”è¯¥æ·»åŠ ä¸€ä¸ªæ£€æŸ¥æ˜¯å¦è¶…è¿‡æ ˆé¡¶çš„ä»£ç ï¼Œä¸ç„¶éšæ‰‹åœ¨å‡½æ•°å†…è®¾ä¸ªå¤§æ•°ç»„ï¼Œå°±æŠŠå…¨å±€å˜é‡ç»™æŠ¹æ²¡äº†ã€‚ä½†è¿™æ€ä¹ˆå®ç°ï¼Œnemuå¹¶ä¸çŸ¥é“_stack_topçš„å­˜åœ¨ï¼ˆé™¤éè§£æelfæ–‡ä»¶ï¼‰ï¼Œè€Œè¿™ç§æ£€æµ‹ä¹Ÿç¡®å®ä¸åº”è¯¥åœ¨ç¡¬ä»¶å±‚é¢å®ç°â“

> PA3.2: å¦ä¸€ç§ä½ å¯èƒ½ä¼šç¢°åˆ°çš„UBæ˜¯æ ˆæº¢å‡º, å¯¹, å°±æ˜¯stackoverflowçš„é‚£ä¸ª. æ£€æµ‹æ ˆæº¢å‡ºéœ€è¦ä¸€ä¸ªæ›´å¼ºå¤§çš„è¿è¡Œæ—¶ç¯å¢ƒ, AMè‚¯å®šæ˜¯æ— èƒ½ä¸ºåŠ›äº†, äºæ˜¯å°±UBå§.

> bad-appleçš„æ¡ˆä¾‹
>
> è¿™é‡Œä¸èƒ½ç”¨æ ˆæ¥å­˜å¤§æ•°ç»„ï¼ï¼ï¼
>
> `uint32_t buffer[VIDEO_ROW * VIDEO_COL];`
>
> å› ä¸º`/abstract-machine/scripts/linker.ld`ä¸­æŠŠå®¢æˆ·ç¨‹åºçš„æ ˆåŒºå†™æ­»äº†ï¼Œä¸º0x8000ä¸ªå­—èŠ‚ï¼ˆ32KBï¼‰
>
> ```
> _stack_top = ALIGN(0x1000);
> . = _stack_top + 0x8000;
> _stack_pointer = .;
> ```
>
> `0x8000 == 32768 Bytes`
>
> è€Œå¦‚æœæ˜¯`128x96`çš„å°ºå¯¸ï¼Œ`96 * 128 * 4 == 49152 Bytes`
>
> `buffer`çš„åœ°å€ä¸º`0x81C0DFB0`ï¼Œå·²ç»è·¨è¶Šäº†_stack_topçš„åº•çº¿ï¼Œè·‘åˆ°äº†å…¨å±€å˜é‡åŒº
>
> å¯¼è‡´`buffer`æ¯”`lut`çš„åœ°å€è¿˜ä½ï¼Œç”±äºbuffer[index]æ˜¯å¾€é«˜å¤„å†™ï¼Œå°±æŠŠå…¨å±€å˜é‡åŒºéƒ½æŠ¹äº†ï¼Œæ‰€ä»¥è°ƒç”¨`ioe_write`æ—¶å‡½æ•°éƒ½æ‰¾ä¸åˆ°äº†

## å…³äºä¼˜åŒ–

åšå®Œå…¨éƒ¨çš„PAå†æ¥ä¼˜åŒ–ä¹Ÿä¸è¿Ÿ

- çœ‹å®ä¸é¡ºçœ¼ï¼Œæ‰‹è´±æŠŠnemuä¸­`pattern_decode`å’Œ`pattern_decode_hex`å†™æˆäº†å¾ªç¯çš„å½¢å¼ï¼Œå¯¼è‡´è¿è¡Œé€Ÿåº¦é™ä½äº†è‡³å°‘40å€ï¼Œå¯¼è‡´marioè¿è¡Œæ—¶FPSä¸º0ï¼Œè¿˜åŸä¸ºå®åFPSå¯ä»¥åˆ°10ï¼ˆ`NR_FRAMESKIP==1`çš„æƒ…å†µï¼‰ï¼
  > æŠŠå¾ªç¯æ¬¡æ•°å›ºå®šçš„éƒ¨åˆ†ç”¨å®å±•å¼€ï¼Œæ˜¯æœ€æè‡´çš„loop unrollingï¼ˆè¿™é‡Œå› ä¸ºå¯ä»¥ä¿è¯å¾ªç¯æ¬¡æ•°å°äº64æ¬¡ï¼Œå¯ä»¥å…¨éƒ¨å±•å¼€ã€‚è€Œè‹¥æ˜¯å¾ªç¯ä¸ç¡®å®šçš„æ¬¡æ•°ï¼Œloop unrollingåšçš„æ˜¯æŠŠ4æ¬¡å¾ªç¯è¦åšçš„æ”¾åœ¨ä¸€æ¬¡å¾ªç¯å†…ï¼Œå‡å°‘æ‰§è¡Œè·³è½¬ä¸åˆ¤æ–­æŒ‡ä»¤çš„æ•°é‡ï¼‰
- nemuä¸­`inst.c`çš„æŒ‡ä»¤åŒ¹é…`INSTPAT`æ˜¯ä¸€æ¡æ¡è¿›è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡ç»Ÿè®¡æŒ‡ä»¤ä½¿ç”¨çš„é¢‘åº¦è°ƒæ•´åŒ¹é…çš„é¡ºåºã€‚åœ¨menuconfigä¸­æ‰“å¼€`INST_STATISTIC`é€‰é¡¹ï¼ˆè‡ªå·±å®ç°å»ï¼‰ï¼Œè§‚å¯Ÿä½¿ç”¨nanosä¸€æ®µæ—¶é—´çš„[æŒ‡ä»¤é¢‘åº¦](.asset/nanos_inst-statistic.txt)ï¼‰ï¼Œè°ƒæ•´åŒ¹é…é¡ºåºï¼Œå¯ä»¥è®©coremarkåœ¨ä¸­çš„åˆ†æ•°ä¸Šå‡20å·¦å³ï¼ˆä¸Šè¿°ç¯å¢ƒä¸ºâ€œåˆ†é¡µ+æ—¶é’Ÿä¸­æ–­çš„ä¸¤ä¸ªpcbå¹¶å‘â€çš„nanosï¼‰
- nanosè·‘ftraceï¼Œè§‚å¯Ÿnanoså’Œamä¸­çš„[å‡½æ•°è°ƒç”¨é¢‘åº¦](.asset/nanos_ftrace-statistic.txt)ï¼Œä½†å¥½åƒå¹¶æ²¡æœ‰å¾ˆå¤šéœ€è¦ä¼˜åŒ–çš„å‡½æ•°
- `make menuconfig`ä¸­Enable Debug Informationåï¼Œä¼šç”¨`-Og`è¿›è¡Œç¼–è¯‘ï¼Œä¼šä½¿æ€§èƒ½ä¸‹é™ï¼

è´´ä¸€ä¸‹è·‘åˆ†ï¼ˆç›´æ¥åœ¨am-kernelsä¸­è¿è¡Œï¼‰ï¼Œç®—å‡ºæ¥å¤§çº¦åªæœ‰çœŸæœºçš„0.5%ğŸ˜«
```
MicroBench naitve: 60913 Marks
======= Running MicroBench [input *ref*] =======
[qsort] Quick sort: * Passed.
  min time: 475.929 ms [925]
[queen] Queen placement: * Passed.
  min time: 990.505 ms [410]
[bf] Brainf**k interpreter: * Passed.
  min time: 6293.881 ms [267]
[fib] Fibonacci number: * Passed.
  min time: 9839.824 ms [204]
[sieve] Eratosthenes sieve: * Passed.
  min time: 12296.194 ms [283]
[15pz] A* 15-puzzle search: * Passed.
  min time: 1264.628 ms [423]
[dinic] Dinic's maxflow algorithm: * Passed.
  min time: 1435.807 ms [569]
[lzip] Lzip compression: * Passed.
  min time: 1635.268 ms [415]
[ssort] Suffix sort: * Passed.
  min time: 649.518 ms [616]
[md5] MD5 digest: * Passed.
  min time: 10388.583 ms [146]
==================================================
MicroBench PASS        425 Marks
                   vs. 100000 Marks (i9-9900K @ 3.60GHz)
Scored time: 45270.137 ms
Total  time: 52284.149 ms

CoreMark native:       64920 Marks
CoreMark riscv32-nemu: 324 Marks

Dhrystone native:       21485 Marks
Dhrystone riscv32-nemu: 111 Marks
```

# PA1

åˆ¶ä½œç®€æ˜“çš„è°ƒè¯•å™¨ï¼ˆå› ä¸ºç¡¬ä»¶éƒ½æ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œæ‰“å°å¯„å­˜å™¨ã€å†…å­˜ä¹Ÿå°±æ˜¯æ‰“å°å‡ºæ•°ç»„ä¸­çš„å€¼ï¼‰ã€‚è¯»ä»£ç ï¼Œæ‰¾åˆ°éœ€è¦è°ƒç”¨çš„å‡½æ•°æˆ–éœ€è¦è®¿é—®çš„staticå˜é‡ï¼ˆåº”è¯¥æ˜¯éœ€è¦æ‰‹åŠ¨æ·»åŠ includeçš„ï¼‰ã€‚

```
(nemu) x 8 $pc
0x80000000: 0x00000297 0x00028823 0x0102c503 0x00100073 
0x80000010: 0xdeadbeef 0x5a5a5a5a 0x5a5a5a5a 0x5a5a5a5a 
(nemu) px *($pc)
0x00000297
(nemu) px *($pc+4*4)
0xdeadbeef
```

## 1.3

å¤§è‡´å°±æ˜¯é€šè¿‡`make menuconfig`è¿è¡Œkconfigå·¥å…·åœ¨terminalçš„å›¾å½¢åŒ–ç•Œé¢ä¸­è¿›è¡Œä¸ªæ€§åŒ–é…ç½®ï¼Œäº§ç”Ÿçš„`include/config/auto.conf`å°†ä¼šç”¨äº`make`çš„ä¸ªæ€§åŒ–ç¼–è¯‘ï¼Œäº§ç”Ÿçš„`include/generated/autoconf.h`å°†ä¼šç”¨äºcè¯­è¨€ä»£ç ä¸­çš„`#ifdef`ã€‚

å¯¹äºé‚£äº›çœ‹ä¸æ‡‚çš„å®å®šä¹‰ï¼Œå¯ä»¥åœ¨makefileä¸­åŠ å…¥ä¸€è¡Œï¼Œè®©è¾“å‡ºé¢„ç¼–è¯‘çš„ä»£ç ï¼ˆå‡ºè‡ª[ç¬¬5è¯¾çš„PPT](http://why.ink:8080/static/slides/ICS2023/05.pdf)ï¼‰

```makefile
# ./nemu/scripts/build.mk
$(OBJ_DIR)/%.o: %.c
	@echo + CC $<
	@mkdir -p $(dir $@)
	@$(CC) $(CFLAGS) -c -o $@ $<
	
# gcc preprocessing file, æ–¹ä¾¿ç†è§£é‚£äº›çœ‹ä¸æ‡‚çš„å®å±•å¼€
	@$(CC) $(CFLAGS) -E -MF /dev/null $< | grep -ve '^#' | clang-format - > $(basename $@).i
	
	$(call call_fixdep, $(@:.o=.d), $@)
```

## 1.4

`p EXPR`æŒ‡ä»¤éœ€è¦è‡ªå·±å†™è¡¨è¾¾å¼æ±‚å€¼çš„å·¥å…·ã€‚

```
(nemu) p <expr>
å…¶ä¸­ <expr> ä¸º <decimal-number>
  | <hexadecimal-number>    # ä»¥"0x"å¼€å¤´
  | <reg_name>              # "$ra" / "$pc"
  | "(" <expr> ")"
  | <expr> "+" <expr>
  | <expr> "-" <expr>
  | <expr> "*" <expr>
  | <expr> "/" <expr>
  | <expr> "==" <expr>
  | <expr> "!=" <expr>
  | <expr> "&&" <expr>
  | "*" <expr>              # æŒ‡é’ˆè§£å¼•ç”¨ï¼ˆåªç”¨æ”¯æŒæ•°å€¼æˆ–å¯„å­˜å™¨çš„å€¼ä½œä¸ºåœ°å€ï¼Œä¸ç”¨æ”¯æŒgdbé‚£æ ·çš„å˜é‡ä½œä¸ºåœ°å€ï¼‰
```
 
æœ€åéšæœºç”Ÿæˆæµ‹è¯•ï¼Œæ˜¯å…ˆéšæœºå‡ºä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆä¸å¯„å­˜å™¨ã€å†…å­˜ç›¸å…³çš„ä¸ç”¨éšæœºæµ‹è¯•ï¼Œè‡ªå·±æ‰‹åŠ¨æµ‹å‡ ä¸ªå°±è¡Œäº†ï¼‰ï¼Œç„¶åå†™å…¥ä¸€ä¸ª`temp.c`çš„ä¸´æ—¶æ–‡ä»¶ï¼Œç¼–è¯‘ï¼Œå¼€è¿›ç¨‹è¿è¡Œï¼Œ`./gen-expr 1000 > input`ç”Ÿæˆå¤šç»„ç»“æœå’Œè¡¨è¾¾å¼

> è¿‡æ»¤é™¤ä»¥0çš„caseï¼Œå¯ä»¥ç”¨signalï¼Œä½†é‡åˆ°0ä¹˜ä»¥æ—¶`(1 / 0) * 0`ï¼Œè¿è¡Œå´æ²¡æœ‰å¼‚å¸¸ï¼Œè¿™ç§å®åœ¨æ²¡æ³•æ¢æµ‹
>
> å®Œå…¨å¯èƒ½æ˜¯å¾ˆå¤æ‚çš„å½¢æ€`(6-2*3)*(1 - 2/(1-1))`ï¼Œåˆ°nemué‡Œè¿è¡Œæ˜¯å…ˆè®¡ç®—å‡º`1-1`ä¸º0ï¼Œå†`2/0`ï¼Œè‚¯å®šä¼šæŠ¥é”™çš„ã€‚è¿™ç§åªèƒ½è¿è¡ŒæŠ¥é”™åæ‰‹åŠ¨åˆ æ‰è¿™ç§caseäº†

æœ€åä¿®æ”¹nemuçš„mainå‡½æ•°ï¼Œè¯»æ–‡ä»¶ï¼Œè°ƒç”¨`expr()`ï¼Œå¯¹æ¯”ç»“æœ

## 1.5

å›ºå®š32ä¸ªå¯ç”¨çš„watchpointï¼Œç”¨é“¾è¡¨åˆ†åˆ«å­˜å‚¨â€œä½¿ç”¨ä¸­â€ã€â€œç©ºé—²â€é˜Ÿåˆ—ã€‚

å¦‚æœ`wp_check_changed()`ä¸­å°±åªæ˜¯`nemu_state.state = NEMU_STOP`ï¼Œé‚£è¿è¡Œæ—¶è®¾ç½®`w $pc`ï¼Œç„¶åä¸€ç›´`c`è¿è¡Œåˆ°æœ€åï¼Œä¼šåˆ°`hostcall.c: invalid_inst()`ï¼Œè¯´æ˜æ˜¯å·²ç»åˆ°äº†æœ€åï¼Œå´æ²¡é€€å‡ºæˆåŠŸã€‚é€€å‡ºçš„æ—¶å€™æ˜¯`ebreak`æŒ‡ä»¤å»åš`set_nemu_state(NEMU_END, thispc, code)`ï¼Œè¿™æ—¶å€™å°±ä¸éœ€è¦å†`wp_check_changed()`äº†ã€‚æ‰€ä»¥åœ¨`wp_check_changed()`ä¸­è®¾ç½®`nemu_state.state = NEMU_STOP`æ—¶ï¼Œå¼„ä¸ªåˆ¤æ–­ï¼š

```c
if (nemu_state.state != NEMU_END) {
  nemu_state.state = NEMU_STOP;
}
```

## å¿…ç­”é¢˜

è¿‡

# PA2

## 2.2

ç¼–å†™RISC-V32I_Mçš„æ¨¡æ‹Ÿå™¨ï¼Œåœ¨å¤–éƒ¨ç”¨risc-vç¼–è¯‘å™¨ï¼Œç¼–è¯‘ä¸€äº›cè¯­è¨€å†™çš„rics-væœºå™¨ç ç”¨äºæµ‹è¯•ï¼Œä¹‹åç”¨nemuè¿è¡Œä¹‹ã€‚

> [!IMPORTANT]
> - æŒ‡ä»¤é›†è§ã€ŠThe RISC-V Instruction Set Manual Volume I Unprivileged Architectureã€‹ Instruction Set Listingsï¼Œå…¶å®UCBçš„green cardä¹Ÿéƒ½å¤Ÿç”¨äº†
> - immè§£æå¯ä»¥å‚è€ƒ[CS61CPU](https://cs61c.org/su24/projects/proj3/#task-7-2-immediate-generator)ï¼Œè¦è®°å¾—imméƒ½æ˜¯è¦sign-extendæˆ32/64ä½çš„ã€‚
> - loadè¿›æ¥çš„æ•°æ®ä¹Ÿè¦sign-extend
> - åš`mul`ã€`mulh`æ—¶éœ€è¦æŠŠ`uint32_t`è½¬æ¢ä¸º`int64_t`å»åšä¹˜æ³•ã€‚ä½†ç”±äºbit extendçš„ç‰¹æ€§ï¼Œä»`uint32_t`åˆ°æ›´å¤šä½çš„`int64_t`éœ€è¦å…ˆåˆ°`int32_t`å†åˆ°`int64_t`ï¼Œè¿™æ ·æ‰èƒ½è®©32ä½çš„è´Ÿæ•°æ­£ç¡®åœ°sign-extendæ‰©å±•ä¸º64ä½çš„è´Ÿæ•°ã€‚

> [!TIP]
> ecallä¸ç”¨åšï¼Œç­‰PA3å†è¯´

---

ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨`/abstract-machine/scripts/platform/nemu.mk`ä¸­çš„NEMUFLAGSåŠ ä¸Š`-b`ï¼Œè®©ä¼ å…¥nemuçš„å‚æ•°å¼€å¯batch modeï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡å¼€å§‹è¿è¡Œäº†è¿˜è¦æ‰‹åŠ¨`c`è¿è¡Œå’Œ`q`é€€å‡ºã€‚ä¹‹åç›´æ¥è¿è¡Œ`make ARCH=riscv32-nemu run`å°±èƒ½è¿è¡Œæ‰€æœ‰çš„æµ‹è¯•äº†ã€‚

> [!IMPORTANT]
>  - è‡³å°‘åœ¨åšcpu-testæ—¶ï¼ŒæŠŠ`/abstract-machine/Makefile`é‡ŒæŠŠ`CFLAGS   += -O2`æ”¹ä¸º`O0`ã€‚åœ¨`O2`ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œå‘ç°å¾ˆå¤šæµ‹è¯•ç¼–è¯‘å‡ºæ¥ç»™checkå‡½æ•°çš„`a0`ç›´æ¥å°±è®¾ä¸ºäº†ç¼–è¯‘å™¨é¢„æƒ³çš„å€¼ï¼Œæ ¹æœ¬æ²¡æœ‰è¿è¡Œnemuè®¡ç®—çš„æŒ‡ä»¤ï¼ï¼
>  - stringå’Œhello-strè¿˜éœ€è¦å®ç°é¢å¤–çš„å†…å®¹æ‰èƒ½è¿è¡Œï¼Œç°åœ¨è¿è¡Œä¼šæŠ¥é”™çš„ï¼Œè®°å¾—è·³è¿‡ï¼ˆæˆ‘å°±å¿˜äº†ï¼Œçœ‹åˆ°æ±‡ç¼–é‡Œ`sb a0,1016(a5) # a00003f8 <_end+0x1fff73f8>`å†™ç€è¶…å‡ºäº†_endçš„åœ°å€ï¼Œæ„è¯†åˆ°ä¸åº”è¯¥æ˜¯æˆ‘çš„é—®é¢˜ï¼Œæ‰åˆ°æ–‡æ¡£é‡ŒæŸ¥åˆ°éœ€è¦è·³è¿‡è¿™ä¸¤ä¸ªæµ‹è¯•ï¼‰

> [!TIP]
> am-kernelsï¼Œabstract-machineéƒ½æ˜¯å•¥ï¼Ÿä¸‹é¢ä¸¤ä¸ªå°èŠ‚ä¼šä»‹ç»çš„ã€‚

â“å¾ˆå¥‡æ€ªï¼Œå½“æˆ‘åœ¨nemuä¸­`make menuconfig`é€‰ä¸­äº†Enable Address Sanitizeråï¼Œæœ‰æ—¶å€™ç¼–è¯‘å°±ä¼šæŠ¥`AddressSanitizer:DEADLYSIGNAL`çš„é”™ã€‚

---

> [!NOTE]
> RTFSCç†è§£æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹
>
> `init_monitor()`çš„éƒ¨åˆ†å°±æ˜¯åˆå§‹åŒ–nemuï¼Œå¹¶è£…å…¥å®¢æˆ·ç¨‹åºçš„IMAGEåˆ°å†…å­˜pmemï¼Œå› ä¸ºæ˜¯raw binaryï¼Œpcçš„èµ·å§‹åœ°å€å°±æ˜¯0,å¯¹åº”åˆ°nemuä¸­çš„å†…å­˜åœ°å€ä¸º0x80000000ã€‚ä¹‹åä¾¿è¿›å…¥`engine_start()`ï¼Œè¿›å…¥sdbäº’åŠ¨ç•Œé¢æˆ–è€…`cpu_exec()`ï¼Œå®¢æˆ·ç¨‹åºæŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹å‘ç”Ÿåœ¨`cpu_exec()`ä¸­ã€‚
>
> `execute()`çš„å¾ªç¯ä¸­`exec_once()`, `s->pc`ä¸ºå½“å‰æŒ‡ä»¤çš„åœ°å€ï¼Œè¿›å…¥`isa_exec_once()`åï¼Œ`inst_fetch()`å–å›äºŒè¿›åˆ¶æŒ‡ä»¤ï¼Œé™æ€ä¸‹ä¸€è·³åœ°å€è®¾ç½®ä¸º`s->snpc = s->pc + 4`ï¼Œè¿›å…¥`decode_exec()`ï¼ŒåŠ¨æ€ä¸‹ä¸€è·³åœ°å€é»˜è®¤è®¾ä¸º`s->dnpc = s->snpc`ï¼Œåœ¨æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œé‚£äº›è·³è½¬æŒ‡ä»¤ä¼šæ”¹å˜`s->dnpc`çš„å€¼ã€‚åé¢æ˜¯ä¸€å †é™„å¸¦goto â€œINSTPAT_ENDâ€çš„blockï¼Œä¸€æ—¦`(((uint64_t)INSTPAT_INST(s) >> shift) & mask) == key`ï¼Œå³åŒ¹é…æˆåŠŸï¼Œè¿›å…¥`decode_operand()`è§£æç«‹å³æ•°å’Œè¯»å–å¯„å­˜å™¨src1å’Œsrc2ï¼Œæœ€åæ‰§è¡Œå¯¹åº”çš„`EXECUTE_EXPR`ã€‚å‡ºå»çš„æ—¶å€™`x0`å¯„å­˜å™¨è¦æ‰‹åŠ¨å½’é›¶ï¼ˆå› ä¸ºæ˜¯è½¯ä»¶å®ç°çš„ä¸ä½œåˆ¤æ–­ï¼Œå†™å…¥å°±å†™å…¥äº†ï¼Œç¡¬ä»¶å†™å…¥`x0`æ˜¯ä¸é€šçš„ï¼‰ã€‚å‡ºå»è®©cpuçš„ä¸‹ä¸€è·³è®¾ä¸º`cpu.pc = s->dnpc`ï¼Œæœ€åå¤„ç†traceçš„ä¿¡æ¯ã€å¤„ç†å¤–è®¾ã€‚åªè¦`nemu_state.state == NEMU_RUNNING`ï¼Œå°±ä»¥æ­¤å¾ªç¯å¾€å¤ã€‚
>
> ç›´åˆ°å®¢æˆ·ç¨‹åºå‘å‡ºebreakçš„æŒ‡ä»¤è€Œ`NEMU_END`ï¼ˆè¦ä¹ˆæ˜¯æ­£å¸¸è¿è¡Œç»“æŸ`ret==0`ï¼Œè¦ä¹ˆæ˜¯ä¸­é€”å¼‚å¸¸é€€å‡º`ret!=0`ï¼‰ï¼Œæˆ–è€…nemuå‡ºç°å†…éƒ¨é”™è¯¯è€Œ`NEMU_ABORT`ï¼Œç»“æŸ`execute()`çš„å¾ªç¯ï¼Œé€€å‡ºnemuã€‚

## Makefileè§£æ: am-kernels on abstract-machine

è¿è¡Œam-kernelsä¸­æµ‹è¯•çš„æ—¶å€™ï¼Œ`make ARCH=riscv32-nemu ALL=dummy run`ä¼šç”Ÿæˆ`Makefile.dummy`ï¼Œå…¶ä¸­çš„å†…å®¹ä¸º

```
NAME = dummy
SRCS = tests/dummy.c
include /abstract-machine/Makefile
```

æ¥ä¸‹æ¥ä¼š`make -s -f Makefile.dummy ARCH=$(ARCH) $(MAKECMDGOALS)`å»è¿è¡Œè¿™ä¸ªMakefileï¼Œå…¶å®å°±æ˜¯åœ¨å¼•ç”¨`/abstract-machine/Makefile`ä¸­çš„å†…å®¹ï¼ˆPA2.3ä¸­ä¼šè¦æ±‚ä»”ç»†é˜…è¯»ï¼‰ï¼Œå…¶ä¸­å…ˆç¼–è¯‘ç”Ÿæˆä¸€å †OBJSï¼Œå†`@$(LD) $(LDFLAGS) -o $(IMAGE).elf --start-group $(LINKAGE) --end-group`é“¾æ¥æˆELFæ–‡ä»¶ï¼Œæœ€åç”¨`@$(OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $(IMAGE).elf $(IMAGE).bin`æŠ½å–å‡ºéƒ¨åˆ†å†…å®¹æˆä¸ºè£¸äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™æ˜¯nemuéœ€è¦çš„ç¨‹åºæ–‡ä»¶IMAGEï¼ˆ.binï¼‰ï¼Œæœ€åé€šè¿‡`$(MAKE) -C $(NEMU_HOME) ISA=$(ISA) run ARGS="$(NEMUFLAGS)" IMG=$(IMAGE).bin`è¿è¡Œnemuä¸­Makefileçš„`make run`ã€‚

```makefile
image: $(IMAGE).elf
	@$(OBJDUMP) -d $(IMAGE).elf > $(IMAGE).txt
	@echo + OBJCOPY "->" $(IMAGE_REL).bin

# -S (--strip-all)
#    Do not copy relocation and symbol information from the source file.  Also deletes debug sections.
# -Sä¹‹ååªæ˜¯å°‘äº†äº›é™„åŠ ä¿¡æ¯ï¼Œä¾æ—§å¯ä»¥è¢«linuxè¿è¡Œã€è¢«readelfã€è¢«objdump
# -O binary æ˜¯ä¿ç•™raw binary fileï¼Œä¸èƒ½è¢«linuxè¿è¡Œã€è¢«readelfã€è¢«objdump
    @$(OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $(IMAGE).elf $(IMAGE).bin
```

## 2.3

å®ç°å‡ ä¸ªä¸ISAæ— å…³çš„é€šç”¨åº“å‡½æ•°ï¼Œç†è§£abstract machineä½œä¸ºnemu(cpu)ä¸OSä¹‹é—´çš„ä¸­é—´å±‚çš„å¥¥ä¹‰ã€‚

å®¢æˆ·ç¨‹åºä¾èµ–äºAMï¼Œè§[AMçš„äº”ä¸ªæ¨¡å—](#å…³äºAM)

nemuçš„è¿è¡Œæ˜¯ç›´æ¥è¯»å…¥ä¸€æ•´ä¸ªIMAGEï¼Œæ˜¯am-kernelsçš„å®¢æˆ·ç¨‹åºå’Œabstract-machineå…¨éƒ¨ç¼–è¯‘ã€é“¾æ¥åœ¨ä¸€èµ·çš„ç»“æœï¼Œåœ¨nemuçœ‹æ¥å°±æ˜¯ä¸€å †æŒ‡ä»¤ï¼Œç›¸å½“äºå¼€æœºåå°±åªè·‘è¿™ä¸€ä¸ªè¿è¡Œç¯å¢ƒä¸­çš„ä¸€ä¸ªç¨‹åºã€‚ä¹Ÿå°±æ˜¯è¯´å®¢æˆ·ç¨‹åºé€šè¿‡abstract-machineçš„åŠ æŒï¼Œå°±å¯ä»¥è·‘åœ¨ä»»æ„ä¸€ç§CPUä¸Šï¼ˆç‰©ç†ä¸–ç•Œçš„CPUä¹Ÿè¡Œï¼‰ã€‚

```c
// init: `start.S: _start()`ï¼Œè®¾ç½®æ ˆçš„èµ·å§‹ä½ç½®`sp = _stack_pointer`ï¼ˆ`/abstract-machine/scripts/linker.ld`ä¸­è®¾å®šçš„åœ°å€ï¼‰ï¼Œè·³è½¬åˆ°trm.cä¸­çš„`_trm_init`
void _trm_init() {
  int ret = main(mainargs);
  halt(ret);
}
// halt: å°†å®¢æˆ·ç¨‹åº`main()`çš„è¿”å›å€¼ï¼Œçº¦å®šä½¿ç”¨`a0`å¯„å­˜å™¨ä¼ è¿”å›å€¼ï¼Œé€šè¿‡`ebreak`æŒ‡ä»¤è®©nemuç»ˆæ­¢ï¼Œå¹¶å°†ä¼ å…¥çš„è¿”å›å€¼ä½œä¸º`nemu_state.halt_ret`ï¼Œä½œä¸ºåˆ¤æ–­`Good/Bad Trap`çš„ä¾æ®ï¼Œæœ€åé€€å‡ºnemuã€‚
```

> gccçš„è¾“å‡ºä¹Ÿèƒ½è¯´æ˜è¿™ç‚¹ï¼Œå•çº¯çš„ç¨‹åºæ–‡ä»¶çš„æœºå™¨ç å¹¶ä¸åŒ…å«`_start`å’Œ`ebreak`ï¼Œè¿™äº›éƒ½æ˜¯è¿è¡Œç¯å¢ƒï¼ˆæ“ä½œç³»ç»Ÿï¼‰é™„åŠ çš„ä¸œè¥¿
>
> ```bash
> cd /am-kernels/tests/cpu-tests
> 
> # ä»…è¾“å‡ºæ±‡ç¼–
> gcc -S tests/dummy.c -o dummy.s
> # æˆ–è¾“å‡ºæœºå™¨ç 
> gcc -c tests/dummy.c -o dummy.o
> objdump -d dummy.o
> # å‘ç°é‡Œé¢æ²¡æœ‰_startå’Œhlt (hltåº”è¯¥å°±æ˜¯å’ŒebreakåŒæ ·çš„å­˜åœ¨å§â“)
> # dummy.oæ˜¯ä¸èƒ½è¢«æ“ä½œç³»ç»Ÿè¿è¡Œçš„
> 
> # ç¼–è¯‘ï¼ˆå¹¶é“¾æ¥è¿è¡Œç¯å¢ƒï¼‰ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
> gcc tests/dummy.c -o dummy
> objdump -d dummy
> # å‘ç°åœ¨_startå‡½æ•°ä¸­æœ‰hltï¼Œè¿™å¹¶ä¸æ˜¯main()å‡½æ•°
> ```

## 2.4

itraceã€iringbufã€mtraceå°±åœ¨nemué‡ŒåŠ¨åŠ¨æ‰‹è„šå³å¯ã€‚

### ftrace

- è¦ftraceçš„è¯ï¼Œè¿è¡Œnemuå°±éœ€è¦é¢å¤–ä¼ å…¥elfæ–‡ä»¶ï¼ˆå› ä¸º`$(IMAGE).bin`æ–‡ä»¶æ˜¯raw binaryï¼Œå•¥éƒ½æ²¡äº†ï¼‰ï¼Œè‡ªå·±è§„å®šç”¨`-e xxx.elf`çš„æ ¼å¼ä¼ å…¥
- ftraceéœ€è¦è¯»å–elfï¼Œè¦æ‰¾å‡ºå½“å‰è¿è¡Œçš„æŒ‡ä»¤è¡Œå¯¹åº”åœ¨å“ªä¸ªå‡½æ•°å†…ï¼Œè¦æ‰¾çš„æ˜¯Sectioné‡Œçš„symtabå’Œstrtabä¸¤ä¸ªè¡¨ï¼Œsymtabä¸­æœ‰å‡½æ•°çš„åœ°å€ä¿¡æ¯ï¼Œstrtabé‡Œæœ‰æ‰€æœ‰å­—ç¬¦ä¸²çš„ä¿¡æ¯ã€‚æ‰€ä»¥éœ€è¦å®šä½åˆ°Section Header Tableï¼Œæ‰¾åˆ°å…¶ä¸­symtabå’Œstrtabä¸¤ä¸ªè¡¨çš„åœ°å€ã€‚è¿è¡Œç¨‹åºæ—¶ç¢°åˆ°`jalr`å’Œ`jal`ä¸¤ä¸ªæŒ‡ä»¤ï¼Œåˆ¤æ–­æ˜¯callè¿˜æ˜¯retï¼Œçœ‹å½“å‰æŒ‡ä»¤çš„pcä½äºsymtabä¸­å“ªä¸ªfunctionçš„åœ°å€èŒƒå›´å†…ï¼Œåˆ™æŸ¥æ‰¾åˆ°strtabä¸­è¯¥å‡½æ•°çš„åå­—ã€‚
- ftraceå®ç°å‡ºæ¥åªæ˜¯åœ¨å®æ—¶æ‰“å°å…¨éƒ¨çš„å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œç”¨ä¸ªint depthè®°å½•æ·±åº¦ç„¶åæ‰“å°ç¼©è¿›å³å¯ï¼Œæ„Ÿè§‰ä¹Ÿæ²¡å¤šå°‘æœºä¼šä¼šç”¨è¿™ä¸ªåŠŸèƒ½ã€‚è‹¥è¦å®ç°backtraceæ‰“å°æŸä¸ªæ—¶åˆ»çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œå¾—ç”¨æ ˆçš„æ•°æ®ç»“æ„pushã€popè®°å½•å‡½æ•°ï¼Œæ‡’å¾—åšäº†ã€‚

ä¿®æ”¹amä¸­çš„`/abstract-machine/scripts/platform/nemu.mk`ï¼Œæ·»åŠ ä¸€ä¸ªtargetæ–¹ä¾¿å¼€å¯ftraceæ¨¡å¼ï¼š

```makefile
# make ARCH=riscv32-nemu run_ftrace 
run_ftrace: image
	$(MAKE) -C $(NEMU_HOME) ISA=$(ISA) run ARGS="-e $(IMAGE).elf $(NEMUFLAGS)" IMG=$(IMAGE).bin
```

> [!NOTE]
> ä¸åŒ¹é…çš„å‡½æ•°è°ƒç”¨å’Œè¿”å›ï¼Œå°è¯•ç»“åˆåæ±‡ç¼–ç»“æœ, åˆ†æä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸€ç°è±¡ï¼šçœ‹åæ±‡ç¼–ä»£ç ï¼Œåœ¨f2ä¸­è°ƒç”¨f1çš„æ˜¯æ­£å¸¸çš„`jalr rs`ï¼ˆ`jalr ra, rs, 0`ï¼‰ï¼Œæ‰€ä»¥è§¦å‘æ‰“å°log`call f1`ï¼Œè€Œf1è·³å‘f0ç”¨çš„æ˜¯`jr`ï¼ˆ`jalr x0, rs, 0`ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸æŠŠpcå­˜åˆ°`ra`å°±è·³å‡ºå»ï¼Œå°†æ¥ä¸ç”¨è·³å›åˆ°è¿™æ¡æŒ‡ä»¤+4çš„åœ°æ–¹ï¼Œè€Œæ˜¯ç›´æ¥è·³å›åˆ°f1è¢«è°ƒç”¨çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯f2ä¸­è°ƒç”¨å¤„+4çš„åœ°æ–¹ã€‚`jr`æŒ‡ä»¤å› ä¸ºæ²¡æœ‰å­˜`ra`ï¼Œä¹Ÿå°±æ²¡è¢«monitorè§†ä¸ºæ˜¯åœ¨callï¼Œæ‰€ä»¥ä»f1è·³å…¥f0çš„æ—¶å€™å¹¶ä¸ä¼šè§¦å‘æ‰“å°`call f0`ï¼Œè€Œf0è¦è¿”å›äº†ï¼ŒretæŒ‡ä»¤ä¼šè§¦å‘æ‰“å°`ret f0`ï¼Œæ‰€ä»¥å°±å‡ºç°äº†`call f1`æ¥ç€`ret f0`çš„ç°è±¡ã€‚
>
> åŒç†ï¼Œä¸ºä»€ä¹ˆ`call f1`å¯¹åº”çš„æ˜¯`ret f3`ï¼Ÿæ˜¯å› ä¸ºf0ä¸­ä¹Ÿæ˜¯`jr`ï¼Œ`call f1`åéšè—åœ°`call f0`ï¼Œåˆéšè—åœ°`call f3`ï¼Œf3é‡Œæ­£å¸¸è°ƒç”¨f2ä¸¤æ¬¡ï¼Œå‡ºæ¥çš„æ—¶å€™è‡ªç„¶æ‰“å°äº†`ret f3`ã€‚
>
> è¿™é‡Œå¦‚æœæŠŠ`jr`è¿™ç§æƒ…å†µä¹Ÿç®—ä½œcallçš„è¯ï¼Œå¹¶ä¸èƒ½è§£å†³é—®é¢˜ï¼Œå› ä¸º`jr`æ²¡æœ‰å¯¹åº”çš„`ret`ï¼Œæ‰€ä»¥ä¼šåŒ¹é…ä¸ä¸Šçš„ã€‚
> 
> ```
>   Call f2
>     Call f1 # then call f0, call f3
>       Call f2
>         Call f1 # then call f0
>         Ret  f0
>       Ret  f2
>       Call f2
>         Call f1 # then call f0
>         Ret  f0
>       Ret  f2
>     Ret  f3
>   Ret  f2
> ```

### ç¼–å†™æ›´å¤šçš„æµ‹è¯•

è¦ç¼–å†™è¯¦å°½çš„testæ¥æµ‹è¯•klibï¼Œæ‡’å¾—è‡ªå·±å†™äº†ï¼Œçœ‹æœ‰äººå¼•ç”¨äº†glibcçš„æµ‹è¯•ï¼Œæˆ‘ä¹Ÿå¼•ç”¨ä¸€ä¸‹å§: https://github.com/alelievr/libft-unit-test/blob/master/hardcore-mode/

> [!IMPORTANT]
> ç”¨am-kernelsçš„æµ‹è¯•ç¨‹åºï¼š
>   - ä¿è¯am-kernelsæµ‹è¯•ç¨‹åºçš„æ­£ç¡®: native + glibc è·‘ am-kernels
>   - ä¿è¯klibæ­£ç¡®: native + klib è·‘ am-kernelsçš„klib-tests
>   - ä¿è¯amä¸nemuç¡¬ä»¶æ¥å£çš„æ­£ç¡®: native + klib è·‘ am-kernelsçš„am-test
>
>     åœ¨nativeä¸Šæµ‹è¯•klibï¼Œå¹¶ä¸èƒ½è·³å…¥klibé‡Œçš„å‡½æ•°â“åœ¨klibè¿˜æ²¡åšprintfçš„é˜¶æ®µï¼Œåªèƒ½ç”¨äºŒåˆ†æ³•æ‰¾åˆ°å‡ºé”™çš„ç”¨ä¾‹å®šä½åˆ°æ˜¯å“ªä¸ªklibé‡Œçš„å‡½æ•°æœ‰é—®é¢˜ï¼Œç„¶åæŠŠå¯¹åº”çš„klibå‡½æ•°å’Œæµ‹è¯•ç”¨ä¾‹å¤åˆ¶åˆ°ä¸€ä¸ªä¸´æ—¶cä¸­è°ƒè¯•ã€ä¿®æ”¹ï¼ˆæœ€å¥½æŠŠå‡½æ•°åä¿®æ”¹æ‰ï¼Œå¦‚æœå°±æ˜¯ä»€ä¹ˆstrcmpï¼Œå®ƒä¹Ÿä¸æŠ¥é”™ï¼Œç›´æ¥ç¥ä¸çŸ¥é¬¼ä¸è§‰åœ°å°±å»ç”¨cçš„åº“äº†ï¼Ÿï¼‰
>   - ä¿è¯nemuæ­£ç¡®: nemu + glibc è·‘ am-kernelsï¼ˆåé¢æœ‰difftestå°±æ›´å…¨é¢äº†ï¼‰

### difftest

difftestéƒ¨åˆ†ï¼Œ`/nemu/src/cpu/difftest/ref.c`æ²¡æœ‰ä»»ä½•ç”¨å¤„ï¼Œåœ¨`nemu/src/cpu/difftest/dut.c`çš„`init_difftest()`ä¸­å·²ç»ç”¨`dlsym()`å»`/nemu/tools/spike-diff/build/riscv32-spike-so`å»å¯»æ‰¾å‡½æ•°äº†ï¼Œå…¶å®å‡½æ•°åœ¨`/nemu/tools/spike-diff/difftest.cc`ä¸­ã€‚

å¯»æ‰¾spikeä¸­å®šä¹‰çš„å¯„å­˜å™¨é¡ºåºï¼Œåœ¨`/nemu/tools/spike-diff/repo/disasm/regnames.cc`ä¸­æœ‰ï¼Œå‘ç°å’Œnemuæ˜¯ä¸€è‡´çš„ã€‚

## 2.5

å†…å­˜æ˜ å°„ï¼šä¸åŒå¤–è®¾çš„å¯„å­˜å™¨è¢«åˆ†åˆ«è®¾å®šï¼ˆçº¦å®šï¼‰åˆ°nemuå†…å­˜ä¸­çš„ä¸åŒåŒºåŸŸï¼ˆå‡æ˜¯é«˜äº0xa0000000çš„ä¸€ä¸ªä¸ªç‰‡åŒºï¼‰ï¼Œç»™CPUçš„åŒæ ·æ˜¯è¯»å†™å†…å­˜çš„æŒ‡ä»¤ï¼Œä½†è‹¥å‘ç°åœ°å€ä¸æ˜¯æ™®é€šå†…å­˜çš„åœ°å€ï¼Œåˆ™è½¬è€Œè¯»å†™å„ç§å¤–è®¾å†…éƒ¨çš„å¯„å­˜å™¨ã€‚

CPUæ–¹é¢ï¼Œåœ¨nemuæ¶æ„ä¸­ï¼Œä¼šè¢«ç¼–è¯‘ä¸ºè®¿é—®å†…å­˜çš„æŒ‡ä»¤ï¼Œä»è€Œé€šè¿‡`paddr_read()`/`paddr_write()`åˆ¤æ–­ä¸ºä¸æ˜¯æ™®é€šå†…å­˜åœ°å€åï¼ˆnemuä¸­å¤–è®¾çš„çœŸå®å­˜å‚¨ç©ºé—´ä¸åœ¨`pmem`æ•°ç»„é‡Œï¼Œè€Œæ˜¯`init_map()`é‡Œ`malloc()`å‡ºæ¥çš„å †ç©ºé—´ã€‚æ¯•ç«Ÿè¿™åœ°å€æœ¬æ¥å°±æ˜¯è™šæ‹Ÿçš„ï¼Œè¯»å†™çš„åœ°æ–¹å°±æ˜¯è¦åˆ°å¤–è®¾çš„å¯„å­˜å™¨ï¼Œä¸åœ¨å†…å­˜é‡Œçš„ï¼‰ï¼Œè¿›å…¥`mmio_read`/`mmio_write`ï¼Œæ ¹æ®nemuå¼€æœºæ—¶`init_map()`è®¾å®šå¥½çš„`IOMap maps[NR_MAP]`ï¼Œé€šè¿‡å¤–è®¾å¯¹åº”çš„callbackå‡½æ•°ï¼Œåœ¨readçš„æ—¶å€™æ¨¡æ‹Ÿâ€œå¤–è®¾å‡†å¤‡å¯„å­˜å™¨çš„å€¼ï¼ŒCPUè¯»å–æ‰€éœ€çš„å¤–è®¾å¯„å­˜å™¨çš„å€¼â€ï¼Œåœ¨writeçš„æ—¶å€™æ¨¡æ‹Ÿâ€œCPUä¼ å€¼å…¥å¤–è®¾å¯„å­˜å™¨ï¼Œå¤–è®¾è¯»å–å€¼ä½œå‡ºåç»­å¤„ç†å·¥ä½œâ€ã€‚

å®¢æˆ·ç¨‹åºä¸è¿è¡Œç¯å¢ƒæ–¹é¢ï¼Œam-kernelé‡Œçš„ç¨‹åºä¼šé€šè¿‡ä¸‹é¢ä¸‰ä¸ªabstract-machineçš„IOE APIæ¥è®¿é—®å¤–è®¾ï¼Œ`io_read`/`io_write`é€šè¿‡`lut`ï¼ˆlook up tableï¼‰æŸ¥æ‰¾è¯»å†™å¤–è®¾â€œæŠ½è±¡â€å¯„å­˜å™¨`reg_index`å¯¹åº”çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ï¼ˆä»¥åŠ`putch`ï¼‰å†è°ƒç”¨`inb`/`outb`è¿›è¡Œâ€œå†…å­˜â€è¯»å†™ï¼Œæœ€ç»ˆè¿™æŒ‡ä»¤å°±ä¼šè§¦å‘nemué‡Œçš„`paddr_read()`/`paddr_write()`ã€‚

```c
// 
bool ioe_init();
io_read(reg_index) // æ˜¯åŒ…è£¹äº†void ioe_read(int reg, void *buf)çš„å®
io_write(reg_index, å†™å…¥çš„å†…å®¹) // æ˜¯åŒ…è£¹äº†void ioe_write(int reg, void *buf)çš„å®
// reg_indexï¼Œæ¯”å¦‚ AM_TIMER_CONFIGï¼Œåœ¨/abstract-machine/am/include/amdev.hä¸­å®šä¹‰çš„

// ä»¥åŠæ”¾åœ¨äº†`trm.c`ä¸­çš„`putch()`ä¸²å£ï¼ˆç»ˆç«¯æ‰“å°ï¼‰
```

åœ¨nativeä¸­I/Oæ˜¯æ€ä¹ˆå®ç°çš„â“

åœ¨é€šè¯»ä»¥åŠå®ç°è¿™éƒ¨åˆ†çš„ä»£ç æ—¶ï¼Œå…ˆè¯»am-kernelsä¸­åœ¨è°ƒç”¨çš„æ ·å­ï¼Œæ˜ç™½abstract-machineä¸­`ioe.c`â€œæŠ½è±¡â€å¯„å­˜å™¨å¯¹åº”çš„å‡½æ•°çš„åŠŸèƒ½æ˜¯å•¥ï¼Œå†å»çœ‹nemuä¸­ç¡¬ä»¶è¯»å†™è¦å®ç°çš„ã€‚

### ä¸²å£

åªå†™

> [!NOTE]
> ç†è§£mainargsï¼Œè¯·ä½ é€šè¿‡RTFSCç†è§£è¿™ä¸ªå‚æ•°æ˜¯å¦‚ä½•ä»makeå‘½ä»¤ä¸­ä¼ é€’åˆ°helloç¨‹åºä¸­çš„, `$ISA-nemu`å’Œ`native`é‡‡ç”¨äº†ä¸åŒçš„ä¼ é€’æ–¹æ³•ï¼š
>
> è¿™é‡Œ`make ARCH=$ISA-nemu mainargs=I-love-PA run`
>
> `$ISA-nemu`ï¼šé€šè¿‡MakefileæŠŠ`mainargs`ç¼–è¯‘åˆ°å®¢æˆ·ç¨‹åºçš„IMAGEä¸­ï¼šnemu.mkä¸­`-DMAINARGS=\"$(mainargs)\"`ï¼Œåœ¨`/am/src/platform/nemu/trm.c`ä¸­æŠŠ`mainargs`å­˜åœ¨`char mainargs[]`ä¸­ï¼Œå†åˆ°è°ƒç”¨`hello.c`é‡Œçš„`int main(const char *args)`æ—¶ï¼Œå°±ä¼ å…¥äº†ã€‚
>
> `native`ï¼šé€šè¿‡`getenv()`è·å–åˆ°è¾“å…¥çš„`mainargs`ï¼Œé€šè¿‡`static void init_platform() __attribute__((constructor))`ï¼Œåœ¨`hello.c`çš„`main()`è¿è¡Œä¹‹å‰ï¼Œåšäº†å¾ˆå¤šå…¶ä»–çš„æ“ä½œ
>
> ä¸€ä¸ªç¤ºä¾‹
> 
> ```c
> #include <stdio.h>
> #include <stdlib.h>
> 
> int main(char *name);
> 
> void __attribute__((constructor)) before_main() {
>   printf("I can get your name from env.\n");
>   char *name = getenv("NAME");
>   int ret = main(name ? name : "root");
>   printf("After main()\n");
>   exit(ret);
>   printf("Nothing goes here\n");
> }
> 
> int main(char *name) {
>   printf("Greetings! @%s is in main()\n", name);
>   return 0;
> }
> 
> void __attribute__((destructor)) before_exit() {
>   printf("Before exiting\n");
> }
> ```
>
> è¿è¡Œçš„æ—¶å€™`NAME=Lord ./FILE`å°±ä¼šè¾“å‡ºï¼š
>
> ```
> I can get your name from env.
> Greetings! @Holence is in main()
> After main()
> Before exiting
> ```

### æ—¶é’Ÿ

åªè¯»

> [!TIP]
> AM_TIMER_UPTIMEçš„å°å‘ï¼Œæ³¨æ„`rtc_io_handler()`é‡Œåœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹`get_time()`

### é”®ç›˜

åªè¯»

åœ¨`cpu-exec.c`çš„`execute()`è¿‡ç¨‹ä¸­ä¼šå°è¯•`device_update()`ï¼ŒSDL2åº“ä¼šè¯»å…¥é”®ç›˜çš„ä¿¡å·ï¼Œè§¦å‘`send_key()`ï¼Œç”¨é˜Ÿåˆ—è®°å½•æŒ‰é”®ä¿¡æ¯ã€‚å®¢æˆ·ç¨‹åºæ¯æ¬¡è¯»å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„ä¸€ä¸ªæŒ‰é”®ä¿¡æ¯ã€‚

çœ‹çœ‹é¢„ç¼–è¯‘åçš„ç»“æœç†è§£å®ï¼Œæ‰“å°`scancode`å’Œ`am_scancode`ï¼Œè¿è¡Œ`/am-kernels/tests/am-tests/src/main.c`ï¼Œè§‚å¯Ÿ`scancode`å’Œ`am_scancode`ã€‚

å¯ä»¥çœ‹åˆ°`abstact-machine/am/include/amdev.h`å’Œ`/am-kernels/tests/am-tests/src/tests/keyboard.c`ä¸­å¯¹é”®ç›˜ç çš„ç¼–å·`AM_KEYS`ï¼Œä¸`/nemu/src/device/keyboard.c`ä¸­çš„`NEMU_KEYS`æ˜¯ä¸€æ ·çš„ã€‚

### VGA

- vgaæ§åˆ¶ä¿¡æ¯: `0xa0000100`å¼€å§‹çš„2ä¸ª32bitå¯„å­˜å™¨
  - width-heightå¯„å­˜å™¨ï¼ˆåªè¯»ï¼‰
  - SYNCå¯„å­˜å™¨ï¼ˆåªå†™ï¼‰: å®¢æˆ·ç¨‹åºè°ƒç”¨`__am_gpu_fbdraw()`åœ¨fb(vmem)å†™å…¥å±å¹•pixelçš„æ•°æ®åï¼Œä¼šåœ¨SYNC REGå†™å…¥éé›¶å€¼ã€‚ä¹‹åcpu-execè‡ªåŠ¨vga_update_screenæ—¶ï¼Œä¾¿ä¼šå‘ç°SYNC REG!=0ï¼Œåˆ™è®©SDLå»æ›´æ–°çª—å£ç”»é¢ã€‚
- vga frame bufferï¼ˆåªå†™ï¼‰: `0xa1000000`å¼€å§‹çš„`width*height`ä¸ª32bitå¯„å­˜å™¨

### å£°å¡

æ•°æ®æµå•Šæµï¼šå®¢æˆ·ç¨‹åºbuf -> nemu audio sbuf -> SDL stream

ç¬¬ä¸€ä¸ªæµå…¥åœ¨AMä¸­å®ç°ï¼Œåªè¦sbufä¸æ»¡ï¼Œå³å¯æµå…¥

ç¬¬äºŒä¸ªæµå…¥åœ¨nemuä¸­å®ç°ï¼Œåªæœ‰åœ¨SDL audioçš„callbackè¢«è°ƒç”¨æ—¶ï¼Œæ‰å¼€å§‹æµã€‚

sbufç”¨ä¸€ç§å¤´å°¾å¾ªç¯çš„æ–¹å¼å»è¯»å†™

## å¿…ç­”é¢˜

TODO: ç¼–è¯‘ä¸é“¾æ¥
- åœ¨nemu/include/cpu/ifetch.hä¸­, ä½ ä¼šçœ‹åˆ°ç”±static inlineå¼€å¤´å®šä¹‰çš„inst_fetch()å‡½æ•°. åˆ†åˆ«å°è¯•å»æ‰static, å»æ‰inlineæˆ–å»æ‰ä¸¤è€…, ç„¶åé‡æ–°è¿›è¡Œç¼–è¯‘, ä½ å¯èƒ½ä¼šçœ‹åˆ°å‘ç”Ÿé”™è¯¯. è¯·åˆ†åˆ«è§£é‡Šä¸ºä»€ä¹ˆè¿™äº›é”™è¯¯ä¼šå‘ç”Ÿ/ä¸å‘ç”Ÿ? ä½ æœ‰åŠæ³•è¯æ˜ä½ çš„æƒ³æ³•å—?
- åœ¨nemu/include/common.hä¸­æ·»åŠ ä¸€è¡Œvolatile static int dummy; ç„¶åé‡æ–°ç¼–è¯‘NEMU. è¯·é—®é‡æ–°ç¼–è¯‘åçš„NEMUå«æœ‰å¤šå°‘ä¸ªdummyå˜é‡çš„å®ä½“? ä½ æ˜¯å¦‚ä½•å¾—åˆ°è¿™ä¸ªç»“æœçš„?
- æ·»åŠ ä¸Šé¢˜ä¸­çš„ä»£ç å, å†åœ¨nemu/include/debug.hä¸­æ·»åŠ ä¸€è¡Œvolatile static int dummy; ç„¶åé‡æ–°ç¼–è¯‘NEMU. è¯·é—®æ­¤æ—¶çš„NEMUå«æœ‰å¤šå°‘ä¸ªdummyå˜é‡çš„å®ä½“? ä¸ä¸Šé¢˜ä¸­dummyå˜é‡å®ä½“æ•°ç›®è¿›è¡Œæ¯”è¾ƒ, å¹¶è§£é‡Šæœ¬é¢˜çš„ç»“æœ.
- ä¿®æ”¹æ·»åŠ çš„ä»£ç , ä¸ºä¸¤å¤„dummyå˜é‡è¿›è¡Œåˆå§‹åŒ–:volatile static int dummy = 0; ç„¶åé‡æ–°ç¼–è¯‘NEMU. ä½ å‘ç°äº†ä»€ä¹ˆé—®é¢˜? ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰å‡ºç°è¿™æ ·çš„é—®é¢˜? (å›ç­”å®Œæœ¬é¢˜åå¯ä»¥åˆ é™¤æ·»åŠ çš„ä»£ç .)

# PA3

å¼€å§‹è¿›å…¥åŸå§‹çº§æ“ä½œç³»ç»Ÿçš„ä¸–ç•Œï¼

> ä¸ºäº†è®©æ“ä½œç³»ç»Ÿä½œä¸ºå¥¶å¦ˆï¼Œå®¢æˆ·ç¨‹åºä½œä¸ºå®å®ï¼Œå®¢æˆ·ç¨‹åºå°†åªè¢«å…è®¸æ‰§è¡Œéç‰¹æƒæŒ‡ä»¤(unprivileged)ï¼Œè€Œæ“ä½œç³»ç»Ÿæ‰èƒ½æ‰§è¡Œç‰¹æƒæŒ‡ä»¤(privileged)ã€‚ç¡¬ä»¶ä¸Šéœ€è¦ä¸€ä¸ªä¿å­˜modeçš„â€œçŠ¶æ€å¯„å­˜å™¨â€ï¼Œè§„å®šåªæœ‰å½“çŠ¶æ€å¯„å­˜å™¨è¡¨ç¤ºå¤„äºç‰¹æƒæ¨¡å¼æ—¶ï¼Œæ‰èƒ½è¿è¡Œç‰¹æƒæŒ‡ä»¤ã€‚
> 
> è¿™ä¸‰è€…çš„å·¥ä½œæ–¹å¼éƒ½å®Œå…¨ç›¸åŒâ“ï¼Œå¯ä»¥ç»Ÿç§°ä¸ºTrapã€‚ä¿®æ”¹çŠ¶æ€å¯„å­˜å™¨ä¸ºç‰¹æƒæ¨¡å¼ã€ä¿å­˜å½“å‰cpuçš„çŠ¶æ€ï¼Œçœ‹Trapçš„åŸå› ï¼ˆç±»å‹mcauseï¼‰ï¼Œè®©PCè·³è½¬åˆ°ä¸åŒçš„Trap Handler
> 
> - ä¸­æ–­ï¼šæ—¶é’Ÿä¸­æ–­é€ å°±äº†åˆ†æ—¶å¹¶å‘ï¼ŒI/Oä¸­æ–­è®©CPUä¸ç”¨ç­‰å¾…é¾Ÿé€Ÿçš„I/Oè®¾å¤‡
> 
>   å¾…ç»†èŠ‚â“
> 
> - ç³»ç»Ÿè°ƒç”¨ï¼šè®©å®¢æˆ·ç¨‹åºä¹–ä¹–åœ°ç­‰å¾…è¢«æœåŠ¡
>   
>   å®¢æˆ·ç¨‹åºéœ€è¦è°ƒç”¨æ“ä½œç³»ç»Ÿçš„å„ç§ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨å‡½æ•°ä¼šé€šè¿‡cpuçš„è‡ªé™·æŒ‡ä»¤ï¼ˆæ¯”å¦‚risc-vä¸­çš„ecallï¼‰ï¼Œå¬å”¤ç±»å‹ä¸ºSyscallçš„Trap Handlerï¼Œå¹¶é™„åŠ ä¸Šä¸åŒçš„syscall numberï¼ˆæ¯”å¦‚risc-vä¸­çš„a7å¯„å­˜å™¨ï¼‰ï¼Œè®©Syscallçš„Trap Handleræ ¹æ®syscall numberå†è·³è½¬åˆ°æ“ä½œç³»ç»Ÿä¸­æ‰€å¯¹åº”çš„å„ç§å¤„ç†å‡½æ•°ã€‚
> 
> - å¼‚å¸¸ï¼šè®¡ç®—å‡ºé”™ï¼Œè®©å®¢æˆ·ç¨‹åºcrashï¼Œè€Œä¸æ˜¯æ•´ä¸ªæœºå™¨crash
> 
>   å¾…ç»†èŠ‚â“

## 3.2

æœ€å¥½è¿˜æ˜¯èƒ½å…ˆçœ‹çœ‹å®¢æˆ·ç¨‹åºã€æ“ä½œç³»ç»Ÿè°ƒç”¨æ—¶çš„æ¥å£ï¼Œå†å»AMé‡Œå†™å®ç°

```c
Context *simple_trap(Event ev, Context *ctx); // å¯è‡ªå®šä¹‰çš„ user_handler

cte_init(simple_trap);
// è®¾ç½® exception entry åœ°å€: asm volatile("csrw mtvec, %0" : : "r"(__am_asm_trap)); ï¼ˆç”¨mtvecå¯„å­˜å™¨å­˜å‚¨ï¼‰
// è®¾ç½® __am_asm_trap ä¸­åç»­ä¼šè°ƒç”¨çš„ user_handler

yield();
// å®¢æˆ·ç¨‹åºè°ƒç”¨amä¸­çš„yield()ã€‚è¿™ä¸œè¥¿ç°åœ¨æ²¡å¤šå°‘ç”¨ï¼Œåˆ°PA4.3ä¸­ä¼šè¢«ç”¨äºè¿›ç¨‹é—´çš„åˆ‡æ¢ï¼ˆç”¨æˆ·è¿›ç¨‹å®šæœŸæ‰§è¡Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸»åŠ¨åœ°è®©å‡ºCPUçš„æ§åˆ¶æƒ, ä»è€Œè®©å…¶å®ƒè¿›ç¨‹å¾—åˆ°è¿è¡Œçš„æœºä¼šã€‚æ³¨æ„è¿™æ˜¯ä¸»åŠ¨çš„é€€è®©ï¼Œä¸æ˜¯å¤–éƒ¨æ¥çš„çš„æ—¶é’Ÿä¸­æ–­ï¼‰
// asm volatile("li a7, -1; ecall"); è°ƒç”¨è‡ªé™·æŒ‡ä»¤ecallï¼Œè§¦å‘ç³»ç»Ÿè°ƒç”¨è¿™ç§trap handlerï¼Œa7æ˜¯ä¼ å…¥çš„ç³»ç»Ÿè°ƒç”¨syscall numberï¼Œè¿™é‡Œçº¦å®šyieldä¸º-1ï¼Œä¹‹åæ ¹æ®syscall numberè·³è½¬çš„æ“ä½œç³»ç»Ÿä¸­ä¸åŒå‡½æ•°
// ä½¿ç”¨ecallæŒ‡ä»¤ï¼ŒæŠŠnemuå¼•å¯¼åˆ°mtvecæŒ‡å‘çš„__am_asm_trapä¸­ï¼Œä¿å­˜ä¸Šä¸‹æ–‡ï¼ˆå…¨éƒ¨çš„å¯„å­˜å™¨ï¼Œä»¥åŠmcauseã€mstatusã€mepcï¼‰ï¼Œç„¶åè¿›å…¥__am_irq_handleæ ¹æ®a7è¿›è¡Œäº‹ä»¶åˆ†å‘ï¼Œè·³åˆ°å¯¹åº”çš„ç”¨æˆ·å®šä¹‰çš„handlerï¼Œæœ€åå›åˆ°_am_asm_trapå»æ¢å¤ä¸Šä¸‹æ–‡ï¼Œæœ€åmretåˆ°æ­£ç¡®çš„mepcå¤„ã€‚
// åšå®Œä¹‹åmretæŒ‡ä»¤é€€å‡ºï¼Œå›åˆ°amå±‚çš„yield()ï¼Œyield()ç»“æŸåå›åˆ°å®¢æˆ·ç¨‹åº
```

> [!IMPORTANT]
> æ³¨æ„åŒºåˆ†`mcause`å’Œ`a7`ï¼ï¼
>
> `mcause`æ˜¯trapçš„ç§ç±»ï¼Œåœ¨trapä¹‹åå°±è¢«å¤–éƒ¨æˆ–å†…éƒ¨ç¡¬ä»¶è®¾ç½®å¥½çš„å€¼ï¼Œå¤„ç†trapçš„æ—¶å€™ç”¨`mcause`æ¥å¼•å¯¼`pc`åˆ°ä¸åŒçš„trap handlerã€‚åˆ†ä¸ºä¸­æ–­å’Œéä¸­æ–­ï¼Œä¸­æ–­æ˜¯æŒ‡å¤–ç•Œé€ æˆçš„å¼‚æ­¥äº‹ä»¶ï¼ˆæ—¶é’Ÿä¸­æ–­ã€IOä¸­æ–­ï¼‰ï¼Œéä¸­æ–­æ˜¯ç”±ä»£ç æ‰§è¡Œé€ æˆçš„åŒæ­¥æ—¶é—´ï¼ˆç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸ï¼‰ã€‚
>
> `a7`æ˜¯ç³»ç»Ÿè°ƒç”¨è¿™ç§trap handlerçš„ä¸€ä¸ªå‚æ•°ï¼Œå«syscall numberã€‚`ecall`è‡ªé™·æŒ‡ä»¤ä¼šå°†PCå¼•å¯¼åˆ°trapç±»å‹ä¸ºsyscallçš„trap handlerï¼Œ`a7`ç”¨æ¥å¼•å¯¼è¿™ä¸ªtrap handlerè·³è½¬åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°ï¼Œ`a0-a5`æ˜¯ä¼ å…¥å‡½æ•°çš„å‚æ•°

> çœ‹åˆ°æ‰‹å†Œé‡Œ"3.3.1. Environment Call and Breakpoint"ä¸­è¯´ä¼šç”Ÿæˆ`environment-call-from-M-mode`çš„exceptionï¼Œå¯ä»¥å¯¹åº”åˆ°`mcause`ä¸­`Interrupt==0`ä¸­çš„ç¬¬11ä¸ª
> 
> ![mcause](./.asset/mcause.png)
> 
> ![exception_code](./.asset/exception_code.png)

### å®ç°å¼‚å¸¸å“åº”æœºåˆ¶

åœ¨nemuä¸­å®ç°csrå¯„å­˜å™¨çš„å®šä¹‰ï¼Œä»¥åŠcsrçš„åŸºç¡€æŒ‡ä»¤`CSRRW`ã€`CSRRS`ï¼Œä»¥åŠä¸­æ–­ç›¸å…³çš„æŒ‡ä»¤`ecall`å’Œ`mret`ã€‚

ecall
- æŠŠ`mcause`è®¾ç½®11
- æŠŠå½“å‰ecallè¿™å¥æŒ‡ä»¤çš„åœ°å€å†™å…¥`mepc`å¯„å­˜å™¨
- pcè®¾ä¸º`mtvec`å¯„å­˜å™¨çš„å€¼ï¼ˆ`cte_init`åœ¨æœ€åˆå·²ç»å°†`mtvec`è®¾ç½®ä¸º`__am_asm_trap`çš„åœ°å€äº†ï¼‰

mret
- æ¢å¤pcä¸º`mepc`å¯„å­˜å™¨çš„å€¼å³å¯

å¦å¤–è®°å¾—è¦å†nemuä¸­æ‰¾ä¸ªåœ°æ–¹åˆå§‹åŒ–`mstatus`ä¸º0x1800ï¼ˆé€šè¿‡difftestçš„æŠ¥é”™ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œä½†å…·ä½“è¿™ä¸ªå€¼æ˜¯å•¥â“ï¼‰

> [!TIP]
> åˆ°æ­¤è¿è¡Œ`am-tests`çš„`intr.c`æ—¶ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œï¼ˆdifftestä¸æŠ¥é”™ï¼Œæ— æœªå®ç°çš„æŒ‡ä»¤ï¼‰åˆ°`AM Panic: Unhandled event`

### ä¿å­˜ä¸Šä¸‹æ–‡

`trap.S`åŒæ ·æ˜¯çœ‹ä¸æ‡‚çš„å®ï¼Œåœ¨Makefileé‡Œæ·»åŠ è¾“å‡ºpreprocessçš„ç»“æœï¼Œå°±èƒ½çœ‹æ‡‚äº†ã€‚

å°±æ˜¯å¼€äº†`(32+3)*4 bytes`çš„æ ˆç©ºé—´æ–°å»ºäº†ä¸€ä¸ªContextç»“æ„ä½“ï¼Œç”¨äºä¼ å…¥`__am_irq_handle`ã€‚ä½åœ°å€å¤„ä¸ºContextç»“æ„ä½“çš„å¼€å¤´ï¼Œé«˜åœ°å€å¤„ä¸ºç»“å°¾ï¼Œå¯ä»¥çœ‹åˆ°å…ˆå­˜äº†gprï¼ˆè·³è¿‡äº†`x0`å’Œ`sp`ï¼‰ï¼Œç„¶åå­˜`mcause`ï¼Œ`mstatus`ï¼Œ`mepc`ã€‚è¦æ±‚â€œå°†åœ°å€ç©ºé—´ä¿¡æ¯ä¸0å·å¯„å­˜å™¨å…±ç”¨å­˜å‚¨ç©ºé—´â€ï¼Œä¹Ÿå°±æ˜¯å“ªä¸ª`void* pdir`ï¼ˆè¿™ä¸œè¥¿åœ¨`abstract-machine/am/src/riscv/nemu/vme.c`ä¸­ä¼šä»Contextç»“æ„ä½“ä¸­è¢«ç´¢è¦çš„ï¼Œç­‰åˆ°[PA4.3](#åœ¨åˆ†é¡µæœºåˆ¶ä¸Šè¿è¡Œç”¨æˆ·è¿›ç¨‹)ä¼šç”¨ï¼‰ï¼Œå› ä¸ºæ˜¯åœ°å€æ•°æ®ï¼Œé•¿åº¦ä¹Ÿæ˜¯4ä¸ªå­—èŠ‚ï¼Œé‚£å°±ç”¨ä¸ªunionæŠŠ`gpr[32]`å’Œ`pdir`æ”¾åœ¨ä¸€èµ·å°±è¡Œäº†ï¼Œå­˜å–`pdir`çš„æ—¶å€™è®¿é—®çš„å°±æ˜¯`gpr[0]`çš„æ ¼å­ã€‚

æœ€åè®°å¾—éªŒè¯ï¼šç”¨nemuçš„sdbåœ¨__am_asm_trapå¤„è®¾ç½®æ–­ç‚¹ï¼Œæ‰“å°æ‰€æœ‰å¯„å­˜å™¨ï¼ˆåŒ…æ‹¬csrï¼‰çš„å€¼ï¼Œä¸__am_irq_handleä¸­printfå‡ºæ¥çš„æ‰€æœ‰ä¿¡æ¯ï¼Œè¿›è¡Œæ¯”è¾ƒã€‚

> [!TIP]
> åˆ°æ­¤è¿è¡Œ`am-tests`çš„`intr.c`æ—¶ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œï¼ˆdifftestä¸æŠ¥é”™ï¼Œæ— æœªå®ç°çš„æŒ‡ä»¤ï¼‰åˆ°`AM Panic: Unhandled event`

### äº‹ä»¶åˆ†å‘

__am_irq_handleä¸­åˆ¤æ–­`mcause`ä¸º11ä¸”`a7`ä¸º-1ï¼Œåˆ†é…`ev.event=EVENT_YIELD`ï¼Œå¦åˆ™`ev.event = EVENT_ERROR`

> [!TIP]
> åˆ°æ­¤è¿è¡Œ`am-tests`çš„`intr.c`æ—¶ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œï¼ˆdifftestä¸æŠ¥é”™ï¼Œæ— æœªå®ç°çš„æŒ‡ä»¤ï¼‰ï¼Œä¸è¿‡è¯¡å¼‚çš„æ˜¯ç­‰å¾ˆé•¿ä¸€æ®µæ—¶é—´åï¼Œè¿ç»­åœ°è¾“å‡º`y`
>
> ç°åœ¨çš„çŠ¶å†µæ˜¯è¿è¡Œå®Œ`for (volatile int i = 0; i < 10000000; i++);`åï¼Œ`yield()`é‡Œ`ecall`ï¼Œç„¶å`mret`å‡ºæ¥åˆåˆ°äº†`ecall`ï¼Œä»è€Œ`ecall`ï¼Œ`ecall`ï¼Œ`ecall`â€¦â€¦
>
> ä¸‹ä¸€å°èŠ‚é‡Œä¿®è¿™ä¸ªbug

### æ¢å¤ä¸Šä¸‹æ–‡

> äº‹å®ä¸Š, è‡ªé™·åªæ˜¯å…¶ä¸­ä¸€ç§å¼‚å¸¸ç±»å‹. æœ‰ä¸€ç§æ•…éšœç±»å¼‚å¸¸, å®ƒä»¬è¿”å›çš„PCå’Œè§¦å‘å¼‚å¸¸çš„PCæ˜¯åŒä¸€ä¸ª, ä¾‹å¦‚ç¼ºé¡µå¼‚å¸¸, åœ¨ç³»ç»Ÿå°†æ•…éšœæ’é™¤å, å°†ä¼šé‡æ–°æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤è¿›è¡Œé‡è¯•, å› æ­¤å¼‚å¸¸è¿”å›çš„PCæ— éœ€åŠ 4. æ‰€ä»¥æ ¹æ®å¼‚å¸¸ç±»å‹çš„ä¸åŒ, æœ‰æ—¶å€™éœ€è¦åŠ 4, æœ‰æ—¶å€™åˆ™ä¸éœ€è¦åŠ .

ä½œä¸ºRISCï¼Œ`mret`çš„ä½œç”¨ä»…ä»…å°±æ˜¯æ¢å¤`mepc`ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨è½¯ä»¶ï¼ˆæ“ä½œç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºamï¼‰ä¸­ï¼Œæ ¹æ®eventçš„ä¸åŒç±»å‹ï¼Œä¿®æ”¹`mepc`ä¸ºæ­£ç¡®çš„å€¼ã€‚

## Makefileè§£æ: navy on nanos

navyï¼Œé€šè¿‡`/navy-apps/libs/libos/src/syscall.c`çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–åŒ…è£¹äº†ç³»ç»Ÿè°ƒç”¨çš„åº“å‡½æ•°`/navy-apps/libs/libc`ï¼ˆå¯ä»¥ä¸ç”¨çŸ¥é“ç»†èŠ‚ï¼‰ï¼Œä¸ç¡¬ä»¶äº¤äº’ã€‚ä»`_start()`å¼€å§‹è¿è¡Œï¼Œåˆ°`call_main()`ï¼Œæœ€åä»`_exit()`é€šè¿‡`ecall`è¿›è¡Œç³»ç»Ÿè°ƒç”¨SYS_exité€€å‡ºã€‚
- é»˜è®¤`make app`ï¼Œå°±æ˜¯æŠŠ`tests`é‡Œçš„cç¨‹åºé“¾æ¥ä¸Š`/navy-apps/libs`ï¼Œç”¨riscv64-linux-gnu-gccç¼–è¯‘å‡ºçš„executableçš„elfå¯æ‰§è¡Œæ–‡ä»¶ã€‚
- `make install`ï¼Œ`make app`åå¤åˆ¶åˆ°`$(NAVY_HOME)/fsimg/bin`ä¸­ï¼Œç”¨äºPA3.4çš„æ–‡ä»¶ç³»ç»Ÿ
- `make fsimg`ï¼Œå¯¹APPSå’ŒTESTSå˜é‡ä¸­æŒ‡å®šçš„æ‰€æœ‰appè¿›è¡Œ`make install`ï¼Œç„¶åæŠŠ`$(NAVY_HOME)/fsimg`ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶concatåˆ°ä¸€ä¸ªå¤§å°ä¸º512bytesæ•´æ•°å€çš„æ–‡ä»¶`ramdisk.img`ï¼Œä»¥åŠç»Ÿè®¡æ–‡ä»¶å¤§å°å’Œoffsetçš„`ramdisk.h`ï¼Œæœ€åè½¯é“¾æ¥åˆ°nanosçš„ç›®å½•ä¸‹

nanosï¼Œ`src`é‡Œçš„cç¨‹åºï¼ˆåŒ…æ‹¬`/nanos-lite/build/ramdisk.img`ã€`/nanos-lite/resources/logo.txt`ï¼‰ä½œä¸ºå®¢æˆ·ç¨‹åºï¼Œå’Œam-kernelsçš„makeæ–¹å¼ä¸€æ ·æ‰“åŒ…æˆä¸ºä¸€æ•´ä¸ªIMAGEè®©nemuè¿è¡Œã€‚ä¸è¿‡å°±æ˜¯ä¸ªâ€œèƒ½è¿è¡Œåœ¨abstract-machineåŠ æŒçš„nemuè£¸æœºä¸Šçš„å®¢æˆ·ç¨‹åºâ€ç½¢äº†ã€‚

> â“nanosè¦æloderå»è¯»elfæ˜¯æœ€å®¹æ˜“çš„æ–¹æ³•ï¼Ÿå¦‚æœç›´æ¥ç»™ä¸ªï¼ˆå’Œnemuè¯»å…¥çš„ä¸€æ ·çš„ï¼‰è£¸äºŒè¿›åˆ¶æ–‡ä»¶çš„navyç¨‹åºï¼Œéœ€è¦é¢å¤–åšå“ªäº›å·¥ä½œæ‰èƒ½åœ¨nanosè¿è¡Œï¼Ÿ

## 3.3

navy`make app`ç¼–è¯‘å‡ºçš„elfä¼šè¢«ä½œä¸º`/nanos-lite/build/ramdisk.img`ï¼Œè¢«nanosç¼–è¯‘æ—¶ä½œä¸ºresourceï¼ˆdataï¼‰å­˜å…¥elfä¸­ï¼Œç®—æ˜¯åœ¨æ¨¡æ‹Ÿå¤–å­˜ã€‚è¿è¡Œæ—¶ä¼šè¢«nanosçš„loaderç¨‹åºï¼ŒæŒ‰ç…§elfæ–‡ä»¶çš„æ ‡å‡†ï¼ŒåŠ è½½è¿›å…¥å†…å­˜ï¼Œå°±æˆä¸ºäº†å†…å­˜ä¸­çš„ç¨‹åºï¼Œç›®å‰nanosåªæ˜¯æŠŠå®ƒä½œä¸ºä¸€ä¸ªä¸éœ€è¦å‚æ•°çš„å‡½æ•°å»è°ƒç”¨`((void (*)())entry)()`ï¼Œnavyç¨‹åºçš„å‡½æ•°æ ˆå°±ç›´æ¥é•¿åœ¨nanosçš„æ ˆä¹‹ä¸Šã€‚ç­‰åˆ°åˆ°[PA4.1](#ç”¨æˆ·è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢)ï¼Œnavyç¨‹åºæ‰èƒ½æ‹¥æœ‰å±äºè‡ªå·±çš„å‡½æ•°æ ˆã€‚

### å®ç°loader

ç›´æ¥æŠŠç¨‹åºè£…å…¥åˆ°elf segmentçš„vaddræŒ‡å®šçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯0x83000000å¾€é«˜çš„åŒºå—ã€‚

> [!TIP]
> ä½†æ˜¯åœ¨[å†…å­˜åˆ†å¸ƒ](#PA4ä¹‹å‰çš„å†…å­˜åˆ†å¸ƒ)æ‰“å°çš„ä¿¡æ¯ä¸­å¯ä»¥çœ‹åˆ°å †åŒºæ˜¯ä»`_heap_start`å¾€ä¸Šçš„ï¼Œå²‚ä¸æ˜¯ä¼šè¢«è¦†ç›–ï¼Ÿ
>
> navyçš„ç¨‹åºå¦‚æœè¦è¿›è¡Œ`malloc()`ï¼Œé‚£ä¹Ÿæ˜¯ç”¨çš„`/navy-apps/libs/libc`çš„å®ç°ï¼Œç›®å‰æ˜¯ä¸è®©è°ƒç”¨çš„ï¼Œæ‰€ä»¥ç›®å‰ä¸ä¼šå‡ºé—®é¢˜ã€‚è€Œåé¢ä¼šè®©navyç¨‹åºçš„å †ç”³è¯·åœ¨å®ƒè‡ªå·±çš„.bssæ®µçš„ä¸Šæ–¹ã€‚ï¼ˆè€Œnavyç¨‹åºçš„å‡½æ•°æ ˆç›´æ¥å°±é•¿åœ¨nanosçš„æ ˆä¹‹ä¸Šï¼‰
>
> nanosçš„å †åŒºä»æ—§æ˜¯amçš„klibé‡Œçš„`malloc()`å‡½æ•°ï¼Œ`[_heap_start, 0x83000000]`éƒ½æ˜¯å®‰å…¨çš„éƒ¨åˆ†ï¼Œnanosä¸­æ²¡ä»€ä¹ˆéœ€è¦mallocçš„ï¼Œæ‰€ä»¥ä¸å¤ªå¯èƒ½ä¼šè¦†ç›–åˆ°è£…å…¥çš„navyç¨‹åºã€‚ï¼ˆå¯ä»¥åœ¨klibçš„`malloc`ä¸­åŠ ä¸ª`assert(addr < 0x83000000)`ï¼‰

### æ“ä½œç³»ç»Ÿçš„è¿è¡Œæ—¶ç¯å¢ƒ

> [!NOTE]
> ç³»ç»Ÿè°ƒç”¨çš„å¿…è¦æ€§
>
> å¯¹äºæ‰¹å¤„ç†ç³»ç»Ÿæ¥è¯´, ç³»ç»Ÿè°ƒç”¨æ˜¯å¿…é¡»çš„å—? å¦‚æœç›´æ¥æŠŠAMçš„APIæš´éœ²ç»™æ‰¹å¤„ç†ç³»ç»Ÿä¸­çš„ç¨‹åº, ä¼šä¸ä¼šæœ‰é—®é¢˜å‘¢?
>
> åº”è¯¥ä¸èƒ½å§ã€‚æŸä¸ªç¨‹åºè°ƒç”¨`halt()`ä¸å°±æŠŠnemuå¹²æ­»äº†å—ï¼Œæ“ä½œç³»ç»Ÿè¿˜æ´»ä»€ä¹ˆ

### ç³»ç»Ÿè°ƒç”¨

a7ä¸º-1æ—¶`ev.event = EVENT_YIELD`ï¼Œå…¶ä»–å€¼æ—¶æ˜¯`ev.event = EVENT_SYSCALL`

è¿›å…¥nanosçš„do_eventåæ ¹æ®`ev.event`åˆ†é…ï¼Œå…¶ä¸­`do_syscall`è¦ç»§ç»­æ ¹æ®`a7`çš„å€¼è¿›è¡Œåˆ†é…ã€‚

> [!TIP]
> navyç¨‹åºéœ€è¦é€šè¿‡`_syscall_`è¿›è¡Œ`yield`ï¼Œå…¶å®æ¶‰åŠåˆ°ä¸¤å±‚åµŒå¥—è°ƒç”¨ecallï¼šé¦–å…ˆ`li a7, 1; ecall`åˆ°`do_event`å†åˆ°`do_syscall`ï¼Œè¿™é‡Œé¢å†è°ƒç”¨äº†amä¸­çš„`yield()`å‡½æ•°ï¼Œå°±å†æ¬¡`li a7, -1; ecall`ï¼Œå†æ¬¡è¿›å…¥`do_event`ï¼Œç„¶åé€å±‚é€€å‡ºã€‚ï¼ˆæŒºç»•çš„ï¼Œå°±æ˜¯ä¸ºäº†ç»Ÿä¸€ä¸ºç³»ç»Ÿè°ƒç”¨çš„æ¥å£ï¼‰

### æ ‡å‡†è¾“å‡º

> [!TIP]
> è®°å¾—`/navy-apps/libs/libos/src/syscall.c`çš„`_write()`ä¹Ÿè¦è¿”å›æ­£ç¡®çš„è¿”å›å€¼ã€‚ä¸ç„¶ä¼šå‘ç°`write()`å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œè€Œ`printf()`å°±åªä¼šæ‰“å°ç¬¬1ä¸ªå­—ç¬¦ï¼Œå› ä¸ºç›®å‰`libc`ä¸­çš„`printf()`ä¸­æ˜¯é€å­—ç¬¦è°ƒç”¨`_write()`çš„ï¼Œå®ƒå‘ç°å†™äº†ç¬¬ä¸€ä¸ªå­—ç¬¦å¾—åˆ°çš„è¿”å›å€¼ä¸å¯¹åï¼Œå°±ä¸å†™ç¬¬äºŒä¸ªå­—ç¬¦äº†ã€‚

### å †åŒºç®¡ç†

è¿™é‡Œè¯´çš„`_end`ä¸æ˜¯nanosè£…å…¥nemuå†…å­˜çš„`_end`åœ°å€ï¼ˆ`/abstract-machine/scripts/linker.ld`ï¼‰ï¼Œè€Œæ˜¯navyè£…å…¥å†…å­˜çš„`_end`åœ°å€ï¼ˆelf segment loadè¿›å…¥å†…å­˜å.bssçš„é¡¶éƒ¨åœ°å€ï¼Œè§`man end`ï¼‰ã€‚navyçš„å †ç©ºé—´æ˜¯ä»`_end`åˆ°é¡¶ä¸Šçš„æ‰€æœ‰ç©ºé—´`[_end, PMEM_END]`

### æ”¯æŒå¤šä¸ªELFçš„ftrace

ä¹‹å‰nemuåªçŸ¥é“nanos+amçš„functionä¿¡æ¯ï¼Œnavyç¨‹åºçš„ä¿¡æ¯éœ€è¦é¢å¤–ä¼ å…¥ã€‚nemué‡Œ`init_ftrace`å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œæ¯æ¬¡è°ƒç”¨å°±æ˜¯åŠ å…¥ä¸€ä¸ªelfæ–‡ä»¶çš„functionä¿¡æ¯ï¼Œæ‰€ä»¥åªéœ€è¦è¿è¡Œæ—¶ä¼ å…¥å¤šæ¬¡`-e`å‚æ•°å°±è¡Œã€‚

```makefile
# /abstract-machine/scripts/platform/nemu.mk
# make ARCH=riscv32-nemu run_ftrace NAVY_ELF=$NAVY_HOME/apps/bird/build/bird-riscv32
ELF_ARGS = -e $(IMAGE).elf
ifneq ($(NAVY_ELF), )
	ELF_ARGS := $(ELF_ARGS) -e $(NAVY_ELF)
endif
run_ftrace: image
	$(MAKE) -C $(NEMU_HOME) ISA=$(ISA) run ARGS="$(ELF_ARGS) $(NEMUFLAGS)" IMG=$(IMAGE).bin
```

> å› ä¸ºæ‰¹å¤„ç†ç³»ç»Ÿä¸­æ‰€æœ‰navyç¨‹åºçš„functionåœ°å€åŒºé—´éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥ä¸èƒ½ä¼ å…¥å¤šä¸ªnavy elfï¼åé¢å®ç°åˆ†é¡µåä¹Ÿä¸€æ ·ï¼Œæ‰€æœ‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´éƒ½æ˜¯ä»`0x40000000`å¼€å§‹ã€‚æ‰€ä»¥åªèƒ½ç”¨ftraceè§‚å¯Ÿä¸€ä¸ªnavyç¨‹åºçš„è¿è¡Œã€‚
>
> è€Œä¸”æ³¨æ„åˆ«ä¼ é”™äº†ï¼Œnanoså¼€æœºåç«‹åˆ»æ‰§è¡Œçš„æ˜¯å“ªä¸ªnavyç¨‹åºå°±ä¼ å…¥å“ªä¸ªelfã€‚ä¸ç„¶å¯èƒ½å› ä¸ºæ‰¾ä¸åˆ°è¿›å…¥çš„å‡½æ•°ï¼Œå¯¼è‡´è·³å‡ºå¤šäºè¿›å…¥ï¼Œè¾“å‡ºçš„indentçš„ä¸ªæ•°éƒ½æˆè´Ÿæ•°äº†ã€‚

## 3.4

### ç®€æ˜“æ–‡ä»¶ç³»ç»Ÿ

ä¸éœ€è¦è€ƒè™‘æƒé™ã€äº’æ–¥ï¼Œæ‰“å¼€ä¸å…³é—­çš„çŠ¶æ€ï¼Œç®€æ˜“æ–‡ä»¶ç³»ç»Ÿå˜›ï¼Œè¯»ã€å†™ã€seekéƒ½éšæ„è¿›è¡Œï¼Œåªè¦æ–‡ä»¶æ“ä½œçš„å‡½æ•°çš„è¾“å…¥è¾“å‡ºèƒ½è®©libcæ­£å¸¸è¿è¡Œå°±è¡Œäº†ã€‚

- fdå°±æ˜¯file_tableçš„ä¸‹æ ‡
- éœ€è¦è‡ªå·±å¢åŠ ä¸€ä¸ªè®°å½•open_offsetçš„åœ°æ–¹ï¼ˆç›´æ¥åŠ åœ¨file_tableä¸­å°±è¡Œäº†ï¼‰
- read/writeä¼ å…¥çš„lenï¼Œå¦‚æœ`open_offset+len`ä¼šè¶…å‡º`size`ï¼Œä¸ç®—é”™è¯¯ï¼Œåªéœ€è¦è¯»/å†™åˆ°æ–‡ä»¶ç»“å°¾å°±è¡Œäº†ï¼Œè¿”å›è¯»/å†™çš„å­—èŠ‚æ•°ã€‚
- lseekå…è®¸è¶…å‡ºè¾¹ç•Œï¼Œç…§æ ·è¿”å›æœ€ç»ˆçš„open_offset
  > lseek() allows the file offset to be set beyond the end of the file (but this does not change the size of the file). 

### è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ

- ramdiskå’Œç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œæ”¯æŒlseekæ“ä½œ, å­˜å‚¨è¿™äº›æ–‡ä»¶çš„è®¾å¤‡ç§°ä¸º"å—è®¾å¤‡"
- ä¸€äº›ç‰¹æ®Šçš„å­—èŠ‚åºåˆ—, ä¾‹å¦‚é”®å…¥æŒ‰é”®çš„å­—èŠ‚åºåˆ—æ˜¯"æµåŠ¨"çš„ï¼Œä¸æ”¯æŒlseekæ“ä½œ, ç›¸åº”çš„è®¾å¤‡ç§°ä¸º"å­—ç¬¦è®¾å¤‡

### æ“ä½œç³»ç»Ÿä¹‹ä¸Šçš„IOE

`NDL.c`ä¸­è°ƒç”¨libcçš„APIï¼Œlibcè°ƒç”¨`_syscall_`

é”®ç›˜éƒ¨åˆ†ï¼š`NDL_PollEvent()`éœ€è¦è¯»â€œæ–‡ä»¶â€`/dev/events`ï¼Œæ‰€ä»¥å°±éœ€è¦åœ¨æ–°å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ï¼Œå®ƒçš„readå‡½æ•°ä¸º`events_read()`ï¼Œåœ¨é‡Œé¢ç”¨`io_read()`è·å–æŒ‰é”®ä¿¡æ¯ï¼Œç”¨å­—ç¬¦ä¸²å‡½æ•°æ‹¼æ¥æˆäº‹ä»¶å­—ç¬¦ä¸²`kd XXXX`ï¼Œè¿™æ ·å°±æ¨¡æ‹Ÿäº†ä»â€œæ–‡ä»¶â€`/dev/events`ä¸­è¯»å‡ºäº†äº‹ä»¶å­—ç¬¦ä¸²ã€‚

VGAéƒ¨åˆ†ï¼š
- è§„å®š`fb_write()`è¦è¿›è¡Œåˆ·æ–°ï¼Œè€Œé™äº`size_t fb_write(void *buf, size_t offset, size_t len)`çš„æ¥å£å½¢å¼ï¼Œæ²¡æ³•é€šè¿‡lenç®—å‡ºä¸€ä¸ªRECTçš„`w*h`ç»™VGAï¼Œå¯¼è‡´`fb_write()`åªèƒ½å®ç°è®©VGAå†™ä¸€è¡Œæ•°æ®ã€‚æœ€åå±•ç°å‡ºæ¥çš„å½¢å¼æ˜¯ä»ä¸Šå¾€ä¸‹çš„å¹•å¸ƒã€‚
- ç”¨lseekæŒ‡å®šç»˜ç”»çš„èµ·å§‹åœ°å€

> å’±èƒ½ä¸èƒ½`fb_write()`é‡Œä¸åˆ·æ–°ï¼Œå†™å®Œæ‰€æœ‰è¡Œåï¼Œå†ç”¨å¦ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å»åˆ·æ–°å±å¹•`io_write(AM_GPU_FBDRAW, 0, 0, NULL, 0, 0, true);`â“

## 3.5

### å®šç‚¹ç®—æœ¯

```
1.25 = 1<<0 + 1>>2             -> 0000 0000 0000 0001.0100 0000
1.25 * 2 ^ 8 = 320             -> 0000 0000 0000 0001 0100 0000
0000 0000 0000 0001.0100 0000  -> 1 + (64)/(2*8) = 1.25

1.2 = 1<<0 + 0.001100110011... -> 0000 0000 0000 0001.0011 0011
1.2 * 2 ^ 8 = 307.2 = 307      -> 0000 0000 0000 0001 0011 0011
0000 0000 0000 0001.0011 0011  -> 1 + (51)/(2*8) = 1.19921875
```
- å¯¹äºå°æ•°éƒ¨åˆ†å¯ä»¥ç²¾ç¡®åˆ†å‰²ä¸º$2^{-n}$çš„æ•°ï¼Œå¯ä»¥ç”¨å®šç‚¹æ•°ç²¾ç¡®è¡¨ç¤º
- å¯¹äºå°æ•°éƒ¨åˆ†ä¸å¯ç²¾ç¡®åˆ†å‰²ä¸º$2^{-n}$çš„æ•°ï¼Œå¯ä»¥ç”¨å®šç‚¹æ•°è¿‘ä¼¼è¡¨ç¤º

å¦å¤–è§„å®šè´Ÿæ•°ä¸ºæ­£æ•°å½¢å¼çš„è¡¥ç ï¼ˆæ­£è´Ÿè½¬æ¢ï¼šå–ååŠ ä¸€ï¼‰

```
-(1.2 * 2^8) = -0x133 = 0xfffffecd
0xfffffecdï¼Œå› ä¸ºç¬¬0ä½ä¸º1ï¼Œæ‰€ä»¥ä¸ºè´Ÿæ•°ï¼Œå–åå¾—0x00000132ï¼Œå†åŠ 1å¾—0x133
```

---

è®¾ä¸¤ä¸ªå®æ•°çš„çœŸå®å€¼ä¸ºaã€bï¼Œå®šç‚¹æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºAã€Bï¼Œå…¶ä¸­$A=a*(2^8)$ã€$B=b*(2^8)$ï¼Œåˆ™ä¸‹é¢çš„è®¡ç®—å‡å¯ç”¨æ•´æ•°è¡¥ç çš„è®¡ç®—ä»£æ›¿
```
(a+b) * (2^8) == A+B
(a-b) * (2^8) == A-B
(a*b) * (2^8) == A*B / (2^8)
(a/b) * (2^8) == A/B * (2^8)
a < b == A < B
```

> [!NOTE]
> ç¥å¥‡çš„fixedpt_rconstï¼Œé˜…è¯»fixedpt_rconst()çš„ä»£ç , ä»è¡¨é¢ä¸Šçœ‹, å®ƒå¸¦æœ‰éå¸¸æ˜æ˜¾çš„æµ®ç‚¹æ“ä½œ, ä½†ä»ç¼–è¯‘ç»“æœæ¥çœ‹å´æ²¡æœ‰ä»»ä½•æµ®ç‚¹æŒ‡ä»¤. ä½ çŸ¥é“å…¶ä¸­çš„åŸå› å—?
>
> `#define fixedpt_rconst(R) ((fixedpt)((R) * FIXEDPT_ONE + ((R) >= 0 ? 0.5 : -0.5)))`
>
> çœ‹åˆ°ç¼–è¯‘å‡ºæ¥çš„æŒ‡ä»¤ä¸­ï¼Œæ²¡æœ‰è¿›è¡Œä»»ä½•è®¡ç®—ï¼Œç›´æ¥å­˜å…¥äº†äºŒè¿›åˆ¶çš„æ•°å€¼ï¼ˆå³ä½¿æ˜¯-O0ä¼˜åŒ–ï¼‰ï¼Œè¯´æ˜æ˜¯ä¾èµ–äº†ç¼–è¯‘å™¨é¢„å¤„ç†çš„åŠŸèƒ½

> [!NOTE]
> å¦‚ä½•å°†æµ®ç‚¹å˜é‡è½¬æ¢æˆfixedptç±»å‹? å‡è®¾æœ‰ä¸€ä¸ªvoid *pçš„æŒ‡é’ˆå˜é‡, å®ƒæŒ‡å‘äº†ä¸€ä¸ª32ä½å˜é‡, è¿™ä¸ªå˜é‡çš„æœ¬è´¨æ˜¯floatç±»å‹, å®ƒçš„çœŸå€¼è½åœ¨fixedptç±»å‹å¯è¡¨ç¤ºçš„èŒƒå›´ä¸­. å¦‚æœæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„å‡½æ•°fixedpt fixedpt_fromfloat(void *p), å¦‚ä½•åœ¨ä¸å¼•å…¥æµ®ç‚¹æŒ‡ä»¤çš„æƒ…å†µä¸‹å®ç°å®ƒ?
>
> æ ¹æ®IEEE745æ ‡å‡†ï¼Œæ‰‹åŠ¨è§£æç®—å‡ºçœŸå€¼ï¼Œç„¶åå†`fixedpt_rconst(R)`è½¬æ¢ä¸ºfixedpt

### Navyä½œä¸ºåŸºç¡€è®¾æ–½

navyä¸­é™„å¸¦äº†æ¨¡æ‹Ÿnanosçš„nativeè¿è¡Œç¯å¢ƒï¼Œæ–¹ä¾¿æ£€æµ‹navy appç¨‹åºï¼ˆåŒ…æ‹¬NDLã€miniSDLçš„å®ç°ï¼‰çš„æ­£ç¡®æ€§

å›é¡¾[2.4](#2.4)ä¸­am nativeæ¨¡æ‹Ÿamå’Œnemuçš„ç¯å¢ƒï¼Œæ–¹ä¾¿æ£€æµ‹am-kernelsç¨‹åºçš„æ­£ç¡®æ€§

- birdä¸­`make run`ï¼Œæ˜¯ç”¨å¯é çš„ç¬¬ä¸‰æ–¹ï¼ˆå°±æ˜¯ä½ çš„LinuxçœŸæœºï¼‰ä»£æ›¿nemuã€amã€nanosã€navyåº“ï¼Œè¢«æ£€æµ‹çš„æ˜¯navyç¨‹åºçš„æ­£ç¡®æ€§
- navyä¸­`make ISA=native`ï¼Œæ˜¯ç”¨å¯é çš„ç¬¬ä¸‰æ–¹ä»£æ›¿nemuã€amã€nanosï¼Œè¢«æ£€æµ‹çš„æ˜¯navyåº“çš„æ­£ç¡®æ€§
- nanosä¸­`make ARCH=native`ï¼Œæ˜¯ç”¨å¯é çš„ç¬¬ä¸‰æ–¹ä»£æ›¿äº†nemuã€amï¼Œè¢«æ£€æµ‹çš„æ˜¯nanosã€navyåº“ã€navyç¨‹åºçš„æ­£ç¡®æ€§
- nanosä¸­`make ARCH=riscv32-nemu`ï¼Œå°±æ˜¯åœ¨è·‘æ‰€æœ‰çš„éƒ¨ä»¶äº†

> [!TIP]
> make nativeè¿è¡Œ`bmp-test`æ‰“å¼€SDLçª—å£æ—¶ç›´æ¥å°±å´©äº†ï¼Œéœ€è¦æ›´æ–°navy-appsçš„repoï¼Œå°±å¥½äº†ã€‚
>
> è¿è¡Œ`event-text`å‡ºç°äº†ä¸‹é¢çš„é”™è¯¯ï¼Œæ˜¯æˆ‘åœ¨`NDL_PollEvent`ä¸­å¤šåŠ äº†ä¸€å¥`close(fd)`
> ```
> XIO:  fatal IO error 9 (Bad file descriptor) on X server ":1"
>       after 228 requests (228 known processed) with 0 events remaining.
> ```

> [!NOTE]
> ç¥å¥‡çš„LD_PRELOAD: bmp-testéœ€è¦æ‰“å¼€ä¸€ä¸ªè·¯å¾„ä¸º/share/pictures/projectn.bmpçš„æ–‡ä»¶, ä½†åœ¨Linux nativeä¸­, è¿™ä¸ªè·¯å¾„å¯¹åº”çš„æ–‡ä»¶å¹¶ä¸å­˜åœ¨. ä½†æˆ‘ä»¬è¿˜æ˜¯æŠŠbmp-testæˆåŠŸè¿è¡Œèµ·æ¥äº†, ä½ çŸ¥é“è¿™æ˜¯å¦‚ä½•å®ç°çš„å—? å¦‚æœä½ æ„Ÿå…´è¶£, å¯ä»¥åœ¨äº’è”ç½‘ä¸Šæœç´¢LD_PRELOADç›¸å…³çš„å†…å®¹.
>
> ```makefile
> # If you set LD_PRELOAD to the path of a shared object, that file will be loaded before any other library (including the C runtime, libc.so), and override symbols.
> run: app env
>	  @LD_PRELOAD=$(NAVY_HOME)/libs/libos/build/native.so $(APP) $(mainargs)
> 
> build/native.so: src/native.cpp
> 	mkdir -p build/
> 	g++ -std=c++11 -O1 -fPIC -shared -o build/native.so src/native.cpp -ldl -lSDL2
> ```
>
> ç”¨`native.so`è¦†ç›–å…¶ä»–æ ‡å‡†åº“çš„å‡½æ•°ï¼Œçš„`native.cpp`ä¸­`fopen`ã€`open`ã€`execve`éƒ½å»è°ƒç”¨äº†`redirect_path()`ï¼Œè®©èƒ½åœ¨`fsimg`ä¸­æ‰¾åˆ°å­˜åœ¨çš„éƒ½redirectåˆ°`fsimg`ä¸­ã€‚

### NSlider

```
sudo apt install imagemagick
sudo nano /etc/ImageMagick-6/policy.xml
# change from
# <policy domain="coder" rights="none" pattern="PDF" />
# to
# <policy domain="coder" rights="read|write" pattern="PDF" />
bash ./convert.sh
```

> [!TIP]
> æ–‡æ¡£è¯´çš„ä¸å…¨ï¼Œå®ç°`SDL_UpdateRect()`åè¿˜éœ€è¦å®ç°åœ¨`SDL_BlitSurface(slide, NULL, screen, NULL)`ä¸­æŠŠ`slide`èµ‹å€¼ç»™`screen`ï¼Œæ‰èƒ½æˆåŠŸå±•ç¤ºç¬¬ä¸€é¡µPPT

ç‹—å±`SDL_PollEvent()`ç«Ÿç„¶è¿˜å¾—éå†é”®ç›˜åç§°æ•°ç»„æ¥è·å–scancodeï¼Œå¤ªä½æ•ˆäº†ï¼Œå¯¼è‡´ftraceå‡ºæ¥å‘ç°`strcmp`çš„ä½¿ç”¨é¢‘åº¦è´¼é«˜â€¦â€¦ä¸ºä»€ä¹ˆä¸ç›´æ¥çº¦å®ševent stringä¸­ä¼ scancodeï¼Ÿï¼Ÿå¦‚æœè¯´æ˜¯AMä¸­çš„AM_KEYS enumå’Œnativeç”¨çš„SDLåº“ä¸­çš„ä¸ä¸€è‡´ï¼Œé‚£ä»ä¸€å¼€å§‹æ‰€æœ‰åœ°æ–¹éƒ½ç”¨SDLçš„æ ‡å‡†`SDL_Scancode`ä¸å°±å¥½äº†ï¼Ÿ

> `BMP_Load`è€æ…¢äº†ï¼Œnemuä¸Šéœ€è¦7ç§’æ‰èƒ½è¯»å…¥ä¸€é¡µpptã€‚BMPçš„è„‘æ®‹æ ¼å¼æ˜¯é€†å‘å­˜å‚¨çš„ï¼Œè€Œä¸”è¿˜æ˜¯24bitçš„æ ¼å¼ï¼Œæˆ‘ä»¬è¦çš„pixelæ˜¯32bitã€‚ä¼˜åŒ–äº†ä¸€ä¸‹å¯ä»¥åˆ°4ç§’å¤šã€‚
>
> ğŸ˜…é”™æ€ªä½ äº†ï¼Œæ˜¯æˆ‘æ²¡å…³difftestï¼Œå…³äº†ä¹‹åå¾ˆå¿«çš„

### Bird

è¯»å†™æ–‡ä»¶ï¼Œä¸«`fopen(filename, "r")`ç¬¬äºŒä¸ªå‚æ•°æ˜¯char*,ä¸æ˜¯charï¼ï¼ï¼å†™æˆ'r'çš„è¯æŠ¥é”™ç«Ÿç„¶æ˜¯Segmentation faultâ€¦â€¦

### Pal

dataæ–‡ä»¶ https://github.com/paldn/sdlpal/

nativeä¸Šè¿è¡Œ`Segmentation fault (core dumped)`ï¼Œåº”è¯¥æ˜¯æ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œåœ¨`native.cpp`çš„`redirect_path()`æ‰“å°æ‰“å¼€æ–‡ä»¶çš„åå­—

```
# pla/repo/dataä¸‹éœ€è¦çš„æ–‡ä»¶ï¼Œæ€»å…±26MBå·¦å³
1.rpg # è¿›å…¥è¯»æ¡£ã€å­˜æ¡£çš„ç•Œé¢éœ€è¦ç›®å½•é‡Œæœ‰è¿™5ä¸ªæ–‡ä»¶ï¼ˆè‡ªå·±æ–°å»ºå…¨ç©ºæ–‡ä»¶çš„ä¹Ÿè¡Œï¼‰
2.rpg
3.rpg
4.rpg
5.rpg
abc.mkf
ball.mkf
data.mkf
desc.dat
f.mkf
fbp.mkf
fire.mkf
gop.mkf
m.msg
map.mkf
mgo.mkf
mus.mkf
pat.mkf
rgm.mkf
rng.mkf
sdlpal.cfg <-- æ‰‹åŠ¨æ·»åŠ 
sss.mkf
voc.mkf
wor16.asc
wor16.fon
word.dat
```

é™¤äº†è¦ä¿®æ”¹`libminiSDL`çš„`video.c`ä¸­ä¸‰ä¸ªå‡½æ•°å¤–ï¼Œè¿˜éœ€è¦æ­£ç¡®å®ç°`event.c`ä¸­çš„`SDL_GetKeyState`ï¼Œæ‰èƒ½æ­£å¸¸å¯åŠ¨

### simulated abstract-machine on navy

åœ¨navyä¸­å®ç°amä¸­çš„æ¥å£åº“libamï¼Œè¿™æ ·å°±èƒ½æŠŠam-kernelsä¸­çš„ç¨‹åºå˜èº«ä¸ºnavyç¨‹åºï¼Œä»è€Œæ”¾åˆ°nanosä¸Šè·‘ã€‚

ç”¨libNDLå’Œlibcçš„å‡½æ•°å®ç°ï¼Œæ–‡æ¡£é‡Œä»€ä¹ˆéƒ½æ²¡è¯´ï¼Œæ‰€ä»¥éœ€è¦åŠ¨å¾ˆå¤šè„‘ç­‹ï¼

- nativeè¿è¡Œ: åœ¨`/navy-apps/apps/am-kernels`ä¸­`make ISA=native run`ï¼Œè¿è¡Œam-kernelsä¸­`benchmarks`å’Œ`kernels`æ–‡ä»¶å¤¹ä¸‹çš„ç¨‹åºï¼Œå¯ä»¥ç”¨`ALL=xxx`æŒ‡å®šè¿è¡Œå“ªä¸€ä¸ª
- nanosè¿è¡Œ: åœ¨`/navy-apps/Makefile`æ·»åŠ `APPS = am-kernels`åï¼Œåœ¨nanosä¸­`make ARCH=riscv32-nemu update`ï¼Œä¼šç”Ÿæˆ`xxx`ï¼Œæ‰€ä»¥éœ€è¦åˆ°`/nanos-lite/src/proc.c`ä¸­`naive_uload(NULL, "/bin/xxx");`ï¼Œå†`make ARCH=riscv32-nemu run`

heapè¯¥æ€ä¹ˆè®¾ç½®â“æŒ‰ç†è¯´åº”è¯¥æ˜¯[PA3.3 å †åŒºç®¡ç†](#å †åŒºç®¡ç†)ä¸­çš„`_end`åˆ°`PMEM_END`ï¼Œä½†`PMEM_END`æ˜¯nemuç‰¹æœ‰çš„ï¼Œnativeæ²¡æœ‰å•Šï¼Ÿ

#### microbench

> [!NOTE]
> microbenchä¸ºä»€ä¹ˆä¼šè¿è¡Œé”™è¯¯
>
> é¦–å…ˆæ˜¯å¯åŠ¨é˜¶æ®µçš„`Segmentation fault`: `int main(const char *args)`æ‰€è¦çš„`args`ï¼Œä¼šæ‹¿å»`strcmp`ã€‚ä¹‹å‰ç»“åˆabstract-machineç¼–è¯‘æ—¶æ˜¯ä¸¤è¾¹çº¦å®šå¥½å°±ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè§[PA2.5 ä¸²å£](#ä¸²å£)ã€‚
> - è€Œç°åœ¨åœ¨navyä¸­ç”¨nativeç¼–è¯‘ï¼Œæ²¡æœ‰äº†ä¹‹å‰çš„é‚£äº›æ“ä½œï¼ˆä¹‹å‰æ˜¯ä»envä¸­æå–`mainargs`å†è°ƒç”¨`main`å¹¶ä¼ å…¥ï¼‰ï¼Œç°åœ¨æ˜¯è¿è¡Œæ—¶åªæ˜¯ä½œä¸ºä¸€ä¸ªæ™®é€šçš„ç¨‹åºç›´æ¥ä»ç»ˆç«¯å¯åŠ¨ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±é»˜è®¤æˆäº†`int argc`ï¼ˆå³ä½¿æŒ‰ç…§`/navy-apps/scripts/native.mk`è¯´çš„åŠ ä¸Šäº†`mainargs=test`ä¹Ÿæ²¡ç”¨äº†ï¼‰ï¼Œæ‰“å°ä¸€ä¸‹çœ‹åˆ°æ˜¯å¤§äº0çš„å€¼ï¼ˆä¼ å…¥å‚æ•°çš„ä¸ªæ•°ï¼‰ï¼Œæ‰€ä»¥è¢«`strcmp`å½“ä½œåœ°å€æ—¶å°±`Segmentation fault`äº†
> - è‹¥æ˜¯åˆ°nanosä¸­ç”¨riscv32-nemuç¼–è¯‘ï¼Œè¿è¡Œæ—¶ç”¨å‡½æ•°è°ƒç”¨çš„æ–¹å¼å¯åŠ¨`main()`ï¼Œçœ‹åˆ°`argc`ä¸º0ï¼Œå°±è¢«å½“ä½œä¸ºNULLï¼Œäºæ˜¯å°±é¡ºåˆ©å¯åŠ¨
>
> å³ä½¿åˆ é™¤æ‰å¯åŠ¨é˜¶æ®µ`strcmp`ï¼Œç›´æ¥é»˜è®¤è·‘`test`æµ‹è¯•é›†ï¼Œåé¢ä¹Ÿä¼šè§¦å‘`Segmentation fault`ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯heapä½¿ç”¨çš„é—®é¢˜â“: microbenchä¸­çš„æ¯ä¸€ç»„æµ‹è¯•ï¼Œéƒ½æ˜¯ä»`heap.start`å¼€å§‹ç”¨å†…å­˜ï¼Œæ¯åšå®Œä¸€ç»„æµ‹è¯•ï¼Œä¹Ÿä¸è¿›è¡Œä»»ä½•çš„æ¸…ç†ï¼Œå°±æŠŠè‡ªå®šä¹‰çš„`hbrk`é‡ç½®åˆ°`heap.start`ï¼Œç„¶åè¦†å†™ã€‚
> - è‹¥è¦nativeèƒ½è¿™æ ·ç”¨ï¼Œé‚£å¾—è®©heapåœ¨ä¸€ä¸ªé¢„å…ˆç”³è¯·çš„ç©ºé—´ï¼Œæ‰€ä»¥heapè¯¥æ€ä¹ˆè®¾ç½®â“
> - nanos+am+riscv32-nemuå¯¹å†…å­˜è¯»å†™æ²¡ä»€ä¹ˆé™åˆ¶ï¼Œå€’æ˜¯èƒ½è·‘å‡ ä¸ªæµ‹è¯•ï¼Œä½†ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆ°A*æ—¶å°±`Segmentation fault`äº†â“

#### fceux

> [!TIP]
> å¦‚æœå‡ºç°`undefined reference to FCEUSND_Reset()`ï¼Œå»æ›´æ–°[è¿™ä¸ªcommit](https://github.com/NJU-ProjectN/fceux-am/commit/9b167e7e47240cd8ef9a910242242c28affb713a)

> [!TIP]
> éœ€è¦æŠŠ`/fceux-am/Makefile`ä¸­çš„`-D__NO_FILE_SYSTEM__`å»æ‰è®©`/fceux-am/src/drivers/sdl/sdl.cpp:main`å˜ä¸º`int main(int argc, char *argv[])`çš„å½¢å¼ã€‚
>
> åªæœ‰navyä¸­ç¼–è¯‘æ—¶éœ€è¦å»æ‰`-D__NO_FILE_SYSTEM__`ï¼Œç›´æ¥åœ¨amä¸­ç¼–è¯‘åˆ™ä¸èƒ½å»æ‰ï¼Œå¦åˆ™æ— æ³•ç¼–è¯‘ã€‚

> [!TIP]
> å› ä¸ºåœ¨navyä¸­ç¼–è¯‘æ—¶æ²¡æœ‰define `__ARCH_NATIVE` `__PLATFORM_QEMU` `__PLATFORM_NEMU`ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œæ‰€ä»¥åœ¨`/fceux-am/src/config.h`ä¸­ä¼šé€‰æ‹©`PERF_CONFIG=PERF_LOW`ï¼Œä»è€Œ`SOUND_CONFIG=SOUND_NONE`
>
> è·‘`mario3`ä¼šåœ¨`RegisterBWrite`ä¸­å‡ºé”™ï¼ŒåŸå› æ˜¯`PERF_CONFIG=PERF_LOW`ä¸­`define FUNC_IDX_MAX16`ï¼Œ`RegisterBWrite`ä¸­ä¼š`assert(i < FUNC_IDX_MAX);`ã€‚è¿™é‡Œæ‰‹åŠ¨æ”¹ä¸º`define FUNC_IDX_MAX256`å¥½åƒä¹Ÿæ²¡äº‹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆâ“

- nativeä¸­è¿è¡Œ: åœ¨`/navy-apps/apps/fceux`ä¸­`make ISA=native run mainargs=mario.nes`ï¼Œè¿™æ¬¡å°±èƒ½é€šè¿‡`mainargs`ä¼ å…¥`argv[0]`äº†ï¼
- nanosè¿è¡Œ: `naive_uload`é‡Œæ˜¯æ²¡æ³•ä¼ å…¥å‚æ•°çš„ï¼ˆè·³åˆ°çš„entryå¹¶ä¸æ˜¯`main`ï¼Œè€Œæ˜¯`_start`ï¼‰ï¼Œè¦é€‰æ‹©è¿è¡Œçš„romï¼Œåªèƒ½å»`/fceux-am/src/drivers/sdl/sdl.cpp:main`ä¸­ä¿®æ”¹é»˜è®¤èµ‹å€¼`romname = "mario.nes"`

> TODO: å¦‚ä½•åœ¨Navyä¸Šè¿è¡ŒNanos-lite?
>
> æ—¢ç„¶ä¹‹å‰åœ¨amä¸Šè¿è¡Œè¿‡nemuï¼Œé‚£ç°åœ¨åº”è¯¥ä¹Ÿèƒ½åœ¨Navyä¸Šè¿è¡Œnemuï¼Œå†åœ¨å…¶ä¸Šè¿è¡Œnanosâ“å¾…å®éªŒ

#### oslab0

å°±161220016å’Œ171240511è¿™ä¸¤ä¸ªåŒå­¦çš„åœ¨navy nativeä¸Šè·‘ä¸äº†

- 161220016: åº”è¯¥è¿˜æ˜¯ä¹±ä½¿ç”¨heapçš„é—®é¢˜
- 171240511: "SDLTimer" received signal SIGSEGV

### å£°éŸ³

#### NPlayer

nanoså’ŒNDLéƒ¨åˆ†åšå®Œåï¼ŒæŠŠ`/am-kernels/tests/am-tests/src/tests/audio.c`çš„å°æ˜Ÿæ˜Ÿç§»æ¤è¿‡æ¥åšä¸ªæµ‹è¯•

> [!TIP]
> `NDL_CloseAudio()`æ²¡è¯´æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘å°±è‡ªå·±å‘æŒ¥äº†ï¼Œè§„å®šå†™å…¥`__am_audio_ctrl`å››ä¸ªå¯„å­˜å™¨æ—¶ï¼ˆä¹Ÿå°±æ˜¯nemuä¸­`audio_io_handler`å¤„ï¼‰ï¼Œå½“freqã€channelsã€sampleä¸‰ä¸ªæ•°éƒ½æ˜¯0æ—¶ï¼Œè¡¨æ˜ç¡¬ä»¶å±‚é¢è¦`SDL_CloseAudio`ï¼Œä»¥ä¾¿ä¹‹åå…¶ä»–è½¯ä»¶å¯ä»¥é‡æ–°`SDL_OpenAudio`è®¾ç½®ä¸åŒçš„å‚æ•°
>
> å…·ä½“ç¡¬ä»¶è¦åšçš„ï¼š
> ```c
> // /nemu/src/device/audio.c
> SDL_CloseAudio();
> sbuf_index = 0;            // reset index
> audio_base[reg_count] = 0; // reset count
> 
> // /abstract-machine/am/src/platform/nemu/ioe/audio.c
> sbuf_index = 0; // reset index
> ```
>
> å¦‚æœæ²¡æœ‰è¿™æ ·çš„é‡ç½®æ“ä½œï¼Œç”¨menuç•Œé¢ï¼Œè¿è¡Œå®Œé¢‘ç‡ä¸º11025çš„bad-appleåï¼Œæ¥ç€è¿è¡Œnplayeræ’­æ”¾é¢‘ç‡ä¸º44100çš„å°æ˜Ÿæ˜Ÿï¼Œå°±ä¼šæ’­æ”¾å‡ºç‰¹åˆ«ä½æ²‰ã€èˆ’ç¼“çš„æ°›å›´ä¹
>
> æ‰€ä»¥bad-appleæœ€åé€€å‡ºå‰ï¼Œä¹Ÿéœ€è¦`io_write(AM_AUDIO_CTRL, 0, 0, 0);`å»æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹
>
> ç‰¹åˆ«æ³¨æ„ï¼`io_write(AM_AUDIO_CTRL, 0, 0, 0);`å¯¹amä¸­çš„nativeç¯å¢ƒä¸å‹å¥½ï¼Œæ‰§è¡Œè¿™å¥åï¼Œå†ç¬¬äºŒæ¬¡OpenAudio`io_write(AM_AUDIO_CTRL, freq, channel, sample);`æ—¶ï¼Œå°±å†ä¹Ÿæ²¡æœ‰å£°éŸ³äº†ã€‚æ‰€ä»¥ä¸€æ—¦æ¥å—äº†æˆ‘è¿™ç§è®¾å®šï¼Œnanosä¸­æ‰§è¡Œ`make ARCH=native`å°†ä¸èƒ½å¤šæ¬¡è®¾å®š`AM_AUDIO_CTRL`

æ¥ç€å»libamæŠŠaudioçš„éƒ¨åˆ†è¡¥ä¸Šï¼Œç°åœ¨å°±å¯ä»¥åœ¨nanosä¸­è¿è¡Œæœ‰å£°éŸ³çš„bad-appleäº†ï¼ï¼ˆä¸ºäº†è®©ramdisk.imgä¸è¶…è¿‡48MBï¼Œå¹¶ä¸”åŒæ—¶åŒ…å«palå’Œbad-appleï¼Œï¼Œbad-appleçš„å£°éŸ³é¢‘ç‡å’Œç”»å¹…å¤§å°éƒ½éœ€è¦å¼„å°ä¸€äº›ï¼‰

---

miniSDLçš„éƒ¨åˆ†ï¼Œéœ€è¦æ¨¡æ‹Ÿâ€œcallbackå‡½æ•°ä¼ é€æ•°æ®åˆ°SDLå†…éƒ¨bufï¼Œå†ä¼ é€åˆ°ç¡¬ä»¶æ’­æ”¾â€çš„è¡Œä¸ºã€‚

å¾—ææ¸…æ¥šsampleã€freqæ˜¯ä»€ä¹ˆï¼Œ[SDL :: View topic - SDL_OpenAudio() and callback frequency](https://forums.libsdl.org/viewtopic.php?p=28652)

æ‰€ä»¥ï¼ŒæŒ‰ç†æ¥è¯´ï¼Œcallbackä¼šé€è¿›æ¥sampleé•¿åº¦çš„æ•°æ®ï¼Œæ¯ç§’æ›´æ–°`freq / sample`æ¬¡ï¼Œä¹Ÿå°±æ˜¯æ¯ç»è¿‡`sample / freq`ç§’å°±è°ƒç”¨ä¸€æ¬¡callbackï¼ˆ`SDL_Audio_interval_ms = sample * 1000 / freq`æ¯«ç§’ï¼‰ã€‚

ä¸çŸ¥é“ä¸ºä»€ä¹ˆâ“è¿™æ ·åœ¨nativeè¿è¡Œåªèƒ½å¬åˆ°æ–­æ–­ç»­ç»­çš„å£°éŸ³ï¼Œæ’­æ”¾ç‰¹åˆ«ç‰¹åˆ«æ…¢ã€‚è€ŒæŠŠä¹˜1000æ”¹æˆä¹˜100åï¼Œæ‰èƒ½æ­£å¸¸æ’­æ”¾ï¼Œåˆ°nanos+nemué‡Œä¹Ÿè¿˜è¡Œï¼ˆ1000æ¯«ç§’æ˜¯1ç§’å•Šï¼Œæ²¡é”™å•Šï¼Ÿï¼Ÿï¼‰

é€‰æ‹©ä¼šè¢«é¢‘ç¹è°ƒç”¨çš„miniSDL APIå¡`CallbackHelper()`ï¼Œå¯ä»¥é€‰`SDL_BlitSurface`ã€`SDL_Delay`ã€`SDL_PollEvent`è¿™ä¸‰ä¸ª

åˆ°è¿™é‡Œå·²ç»å¯ä»¥ç”¨naitveè·‘palæ’­æ”¾éŸ³ä¹äº†ï¼ï¼

#### PAL (å¸¦éŸ³ä¹å’ŒéŸ³æ•ˆ)

æ„Ÿè°¢chatgptè€å¸ˆçš„ç‚¹æ‹¨ã€‚

å…¶å®å°±æ˜¯è¦navyç¨‹åºè¿è¡Œ`main()`ä¹‹å‰è¿è¡Œ`__libc_init_array()`ï¼Œè§‚å¯Ÿåˆ°`/navy-apps/libs/libos/Makefile`æ˜¯åœ¨énativeçš„ç¯å¢ƒæ—¶ç”¨`/navy-apps/libs/libos/src/crt0/start.S`è¿›è¡Œå¼•å¯¼ï¼Œæ‰€ä»¥å°±åªéœ€è¦åœ¨`/navy-apps/libs/libos/src/crt0/crt0.c`è°ƒç”¨`main()`ä¹‹å‰è°ƒç”¨`__libc_init_array()`å°±è¡Œäº†ã€‚

åœ¨nanos+nemuä¸Šè·‘å¤ªæ…¢äº†ï¼Œåº”è¯¥è¿˜æ˜¯åˆ·æ–°ç”»é¢è€—æ—¶å¤ªå¤š

#### Flappy Bird (å¸¦éŸ³æ•ˆ)

ä¸å¥½ç©ï¼Œä¸åšäº†

### åŸºç¡€è®¾æ–½(3)

#### è‡ªç”±å¼€å…³DiffTestæ¨¡å¼

TODO

#### å¿«ç…§

TODO

### å±•ç¤ºä½ çš„æ‰¹å¤„ç†ç³»ç»Ÿ

> [!NOTE]
> æ¯æ¬¡éƒ½è°ƒç”¨`naive_uload()`ç„¶åç”¨è°ƒç”¨çš„æ–¹å¼è·³å…¥`entry()`ï¼Œå‡½æ•°æ ˆæ˜¯ä¸€ç›´å¢é•¿æ²¡æœ‰é‡Šæ”¾çš„ã€‚å¯ä»¥åœ¨nemuçš„ebreakæŒ‡ä»¤ä¸­ç›‘è§†è¿™ä¸€ç‚¹ï¼Œå¤šæ¬¡æ‰“å¼€navyè½¯ä»¶å†é€€å‡ºï¼Œçœ‹åˆ°spä¸€ç›´åœ¨å‡å°
>
> ```c
> if (cpu.gpr[17] == 0 || cpu.gpr[17] == 13) { // if a7 == SYS_exit || a7 == SYS_execve
>   printf("%x\n", cpu.gpr[2]); // print sp
> }
> ```

menuã€nterméƒ½è¡Œï¼Œä¸è¿‡ç°åœ¨å°±æ²¡æ³•é€šè¿‡exitè¿›è¡Œhaltå…³æœºäº†

ä¾æ—§æ²¡æ³•ä¼ å‚æ•°ç»™navyç¨‹åºçš„mainï¼Œæ‰€ä»¥ç°åœ¨è¿˜æ˜¯ä¸èƒ½è®©fceuxé€‰æ‹©romã€‚åˆ°[PA4.1](#ç”¨æˆ·è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢)ä¸­å°±èƒ½å®ç°äº†ã€‚

#### æ·»åŠ å¼€æœºéŸ³ä¹

å› ä¸ºæ¯æ¬¡ç»“æŸç¨‹åºåéƒ½ä¼šè¿”å›menuï¼Œæ‰€ä»¥æˆ‘ä¸æƒ³æŠŠå¼€æœºéŸ³ä¹æ”¾åˆ°menuä¸­ï¼Œå°±æ”¾åœ¨nanosä¸­äº†ï¼Œç›´æ¥è°ƒç”¨amçš„æ¥å£æ’­æ”¾éŸ³ä¹

## å¿…ç­”é¢˜

- ç†è§£ä¸Šä¸‹æ–‡ç»“æ„ä½“çš„å‰ä¸–ä»Šç”Ÿã€ç†è§£ç©¿è¶Šæ—¶ç©ºçš„æ—…ç¨‹ï¼šä»yield testè°ƒç”¨yield()å¼€å§‹, åˆ°ä»yield()è¿”å›çš„æœŸé—´, è¿™ä¸€è¶Ÿæ—…ç¨‹å…·ä½“ç»å†äº†ä»€ä¹ˆ? è½¯(AM, yield test)ç¡¬(NEMU)ä»¶æ˜¯å¦‚ä½•ç›¸äº’ååŠ©æ¥å®Œæˆè¿™è¶Ÿæ—…ç¨‹çš„?
  
  è§[PA3.2](#3.2)
- helloç¨‹åºæ˜¯ä»€ä¹ˆ, å®ƒä»è€Œä½•æ¥, è¦åˆ°å“ªé‡Œå»ï¼šæˆ‘ä»¬çŸ¥é“navy-apps/tests/hello/hello.cåªæ˜¯ä¸€ä¸ªCæºæ–‡ä»¶, å®ƒä¼šè¢«ç¼–è¯‘é“¾æ¥æˆä¸€ä¸ªELFæ–‡ä»¶. é‚£ä¹ˆ, helloç¨‹åºä¸€å¼€å§‹åœ¨å“ªé‡Œ? å®ƒæ˜¯æ€ä¹ˆå‡ºç°å†…å­˜ä¸­çš„? ä¸ºä»€ä¹ˆä¼šå‡ºç°åœ¨ç›®å‰çš„å†…å­˜ä½ç½®? å®ƒçš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨å“ªé‡Œ? ç©¶ç«Ÿæ˜¯æ€ä¹ˆæ‰§è¡Œåˆ°å®ƒçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„? helloç¨‹åºåœ¨ä¸æ–­åœ°æ‰“å°å­—ç¬¦ä¸², æ¯ä¸€ä¸ªå­—ç¬¦åˆæ˜¯ç»å†äº†ä»€ä¹ˆæ‰ä¼šæœ€ç»ˆå‡ºç°åœ¨ç»ˆç«¯ä¸Š?
  
  è§[PA3.3](#3.3)
- ä»™å‰‘å¥‡ä¾ ä¼ ç©¶ç«Ÿå¦‚ä½•è¿è¡Œï¼šè¿è¡Œä»™å‰‘å¥‡ä¾ ä¼ æ—¶ä¼šæ’­æ”¾å¯åŠ¨åŠ¨ç”», åŠ¨ç”»é‡Œä»™é¹¤åœ¨ç¾¤å±±ä¸­é£è¿‡. è¿™ä¸€åŠ¨ç”»æ˜¯é€šè¿‡navy-apps/apps/pal/repo/src/main.cä¸­çš„PAL_SplashScreen()å‡½æ•°æ’­æ”¾çš„. é˜…è¯»è¿™ä¸€å‡½æ•°, å¯ä»¥å¾—çŸ¥ä»™é¹¤çš„åƒç´ ä¿¡æ¯å­˜æ”¾åœ¨æ•°æ®æ–‡ä»¶mgo.mkfä¸­. è¯·å›ç­”ä»¥ä¸‹é—®é¢˜: åº“å‡½æ•°, libos, Nanos-lite, AM, NEMUæ˜¯å¦‚ä½•ç›¸äº’ååŠ©, æ¥å¸®åŠ©ä»™å‰‘å¥‡ä¾ ä¼ çš„ä»£ç ä»mgo.mkfæ–‡ä»¶ä¸­è¯»å‡ºä»™é¹¤çš„åƒç´ ä¿¡æ¯, å¹¶ä¸”æ›´æ–°åˆ°å±å¹•ä¸Š? æ¢ä¸€ç§PAçš„ç»å…¸é—®æ³•: è¿™ä¸ªè¿‡ç¨‹ç©¶ç«Ÿç»å†äº†äº›ä»€ä¹ˆ? (Hint: åˆç†ä½¿ç”¨å„ç§traceå·¥å…·, å¯ä»¥å¸®åŠ©ä½ æ›´å®¹æ˜“åœ°ç†è§£ä»™å‰‘å¥‡ä¾ ä¼ çš„è¡Œä¸º)

  é“ç†å¤§åŒï¼Œæ‡’å¾—traceã€æ‡’å¾—å›ç­”äº†

# PA4

## 4.1

### yield-os

å¼€å§‹å®ç°å¤šè¿›ç¨‹çš„åˆ‡æ¢ï¼Œåªè¦ä¸€å¼€å§‹ä¸¤ä¸ªè¿›ç¨‹å†…å­˜ç©ºé—´ç›¸äº’ç‹¬ç«‹ï¼Œåˆ©ç”¨ä¹‹å‰çš„`__am_asm_trap`ï¼Œåœ¨`__am_irq_handle`ä¸­ç”¨`user_handler`è¿”å›å¦ä¸€ä¸ªè¿›ç¨‹çš„Contextï¼Œåˆ°`__am_asm_trap`ä¸­æ¢å¤Contextæ—¶ä¹Ÿå°±æŠŠCPUçš„çŠ¶æ€åˆ·åˆ°äº†å¦ä¸€ä¸ªè¿›ç¨‹çš„çŠ¶æ€

ä¸ºäº†è®©`user_handler`èƒ½å¤Ÿé…åˆå·¥ä½œï¼ˆé€‰æ‹©æ¥ä¸‹æ¥è¿”å›å“ªä¸ªè¿›ç¨‹çš„Contextï¼‰ï¼Œå°±å¿…é¡»è®©`user_handler`äº†è§£æ‰€æœ‰è¿›ç¨‹çš„ä¿¡æ¯ï¼Œè¿™è¯´çš„å°±æ˜¯â€”â€”æ“ä½œç³»ç»Ÿéœ€è¦ç»´æŠ¤æ‰€æœ‰è¿›ç¨‹çš„PCBï¼ŒPCBä¸­æœ‰æŒ‡å‘â€œè¿›ç¨‹æŒ‚èµ·æ—¶æ‰€ä¿å­˜çš„Contextâ€çš„æŒ‡é’ˆã€‚

åœ¨æœ€ä¸€å¼€å§‹æ—¶è¿›ç¨‹å¹¶ä¸å­˜åœ¨ï¼Œä¹Ÿå°±æ²¡æœ‰â€œæŒ‚èµ·æ—¶æ‰€ä¿å­˜çš„Contextâ€ï¼Œæ‰€ä»¥å°±å¾—æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç©ºç™½Contextï¼Œä»¥ä¾¿å…¼å®¹ç”¨trapçš„æ–¹å¼è°ƒåº¦è®©è¿™ä¸ªå…¨æ–°çš„è¿›ç¨‹â€œç»§ç»­â€è¿è¡Œï¼Œè¿™å°±æ˜¯`kcontext()`å‡½æ•°è¦åšçš„ã€‚

```
PCBç»“æ„
æ•´ä¸ªkstackç»™äº†8ä¸ªé¡µï¼ˆ8ä¸ª4KBï¼‰çš„ç©ºé—´ï¼Œå¯¹äºå†…æ ¸çº¿ç¨‹æ¥è¯´åº”è¯¥ä¸ä¼šè¦†ç›–åˆ°æœ€ä¸‹é¢çš„ä¸‰ä¸ªå˜é‡
|                   |
+-------------------+ <---- kstack.end
|                   |
|      Context      |
|                   |
+-------------------+ <--+
|  ğŸ‘‡Kernel Stack   |    |
|                   |    |
|                   |    |
|                   |    |
|                   |    |
|                   |    |
|                   |    |
|                   |    |
+-------------------+    |
| uintptr_t max_brk |    |
+-------------------+    |
|   AddrSpace as    |    |
+-------------------+    |
|   Context *cp     | ---+
+-------------------+ <---- kstack.start
|                   |
```


### OSä¸­çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

#### RT-Thread

TODO

#### Nanos-Liteçš„ä¸Šä¸‹æ–‡åˆ‡æ¢

ç»†èŠ‚éå¸¸ç»•ï¼Œæœ€å¥½èƒ½æœ‰ä¸ªåŠ¨ç”»æ¼”ç¤ºï¼Œå¯èƒ½æˆ‘ç°åœ¨ç†æ¸…äº†ï¼Œä¹‹åä¹Ÿä¼šå¿˜æ‰

ä¸¤ä¸ªå†…æ ¸çº¿ç¨‹çš„äº¤é”™ï¼š
```c
context_kload(&pcb[0], hello_fun, (void *)0);
context_kload(&pcb[1], hello_fun, (void *)1);
```

- ä¸»çº¿ç¨‹æ ˆä¸­ï¼Œåˆ†åˆ«ç”¨`kcontext()`æ„å»ºåˆå§‹åŒ–ç”¨çš„Contextï¼ˆæ”¾åœ¨å„è‡ªPCBçš„stackçš„å°¾éƒ¨ï¼Œä¹Ÿå°±æ˜¯é«˜åœ°å€çš„æ ˆåº•å¤„ï¼‰ï¼Œå„è‡ªçš„pcb->cpæŒ‡å‘Contextï¼Œå„è‡ªçš„pcb->cp->mepcæŒ‡å‘å†…æ ¸ä¸­çš„`hello_fun`å‡½æ•°
- ä¸»çº¿ç¨‹æ ˆä¸­`switch_boot_pcb()`åˆå§‹åŒ–å…¨å±€å˜é‡currentï¼Œå›åˆ°`main()`ä¸­`yield()`ï¼Œä¸»çº¿ç¨‹æ ˆå¼€å‡º`__am_asm_trap -> __am_irq_handle() -> schedule()`ï¼Œå…¨å±€å˜é‡`current = &pcb[0]`ï¼Œå¹¶è¿”å›`pcb[0].cp`çš„å€¼ç»™`__am_asm_trap`ï¼Œè¿™æ—¶**é­”æ³•**å‘ç”Ÿäº†ï¼š**â€œä¸»çº¿ç¨‹æ ˆç»§ç»­è¿è¡Œ__am_asm_trapå‰©ä¸‹çš„æŒ‡ä»¤ï¼Œè®©`sp`è·³è½¬ä¸º`pcb[0].cp`ï¼Œå°†CPUä¿®æ”¹å˜ä¸ºæ¥ä¸‹æ¥è¦è¿è¡Œçš„çº¿ç¨‹çš„Contextï¼Œæœ€å`mret`è®©`pc`è·³è½¬ä¸º`hello_fun`â€ï¼Œä¸»çº¿ç¨‹æ ˆä¸­çš„__am_asm_trapç»“æŸäº†ï¼Œè€Œ`pc`å’Œ`sp`éƒ½å°±ä½åˆ°çº¿ç¨‹0ä¸­**ï¼Œä¾¿æ–°å»ºå‡ºäº†çº¿ç¨‹0
- çº¿ç¨‹0çš„æ ˆï¼ˆspåœ¨`pcb[0].stack`ä¸­ä»åˆå§‹Contextçš„ä¸‹æ–¹ï¼Œå‘ä¸‹ç”Ÿé•¿ï¼‰ï¼Œ`yield`æ—¶ï¼Œçº¿ç¨‹0çš„æ ˆä¸­å¼€å‡º`__am_asm_trap`ï¼Œä¿å­˜å½“å‰çš„Contextåœ¨è‡ªå·±çš„æ ˆé¡¶ï¼Œå†`__am_irq_handle() -> schedule()`ï¼Œè®¾ç½®`pcb->cp`æŒ‡å‘æ ˆé¡¶ä¿å­˜çš„Contextï¼ˆç”¨äºä»¥ååˆ‡æ¢å›æ¥æ—¶æ¢å¤spï¼‰ï¼Œä¿®æ”¹å…¨å±€å˜é‡`current = &pcb[1]`ï¼ŒåŒç†åˆç”¨**é­”æ³•**æ–°å»ºå‡ºçº¿ç¨‹1
- çº¿ç¨‹1åœ¨è‡ªå·±çš„æ ˆä¸­è¿è¡Œï¼Œ`yield`æ—¶åŒæ ·ä¿å­˜å½“å‰çš„Contextåœ¨è‡ªå·±çš„æ ˆé¡¶ï¼Œ`schedule()`ååˆç”¨**é­”æ³•**ï¼š**â€œçº¿ç¨‹1æ ˆç»§ç»­è¿è¡Œ__am_asm_trapå‰©ä¸‹çš„æŒ‡ä»¤ï¼Œè®©`sp`è·³è½¬ä¸º`pcb[0].cp`ï¼Œå°†CPUä¿®æ”¹å˜ä¸ºæ¥ä¸‹æ¥è¦è¿è¡Œçš„çº¿ç¨‹çš„Contextï¼Œæœ€å`mret`è®©`pc`è·³è½¬ä¸ºContextä¸­ä¿å­˜çš„`mepc`ï¼ˆçº¿ç¨‹1è¦æ¢å¤è¿è¡Œçš„åœ°å€ï¼‰â€ï¼Œçº¿ç¨‹1æ ˆä¸­çš„__am_asm_trapç»“æŸäº†ï¼Œè€Œ`pc`å’Œ`sp`éƒ½å°±ä½åˆ°çº¿ç¨‹0ä¸­**ï¼Œè¿”å›åˆ°çº¿ç¨‹0
- å¾ªç¯å¾€å¤

å½“CPUå‡ºå»å¿™å…¶ä»–çº¿ç¨‹æ—¶ï¼Œä¸»çº¿ç¨‹æ ˆã€çº¿ç¨‹0æ ˆã€çº¿ç¨‹1æ ˆï¼Œéƒ½ç»´æŒç€è¿™æ ·çš„å‡½æ•°æ ˆï¼šCPUå›æ¥çš„æ—¶å€™ï¼Œå€Ÿç”¨é€€å‡ºè€…çš„__am_asm_trapçš„ååŠéƒ¨åˆ†æ¢å¤spã€Contextã€pcã€‚é¢‡æœ‰ä¸€ç§NTRçš„ç¾æ„Ÿã€‚

```
çº¿ç¨‹å‡½æ•°
yield() ï¼ˆæ­¤åœ°å€å­˜åœ¨Context.mepcä¸­ï¼Œç”¨äºä»¥åè¢«mretæ¢å¤pcï¼‰
ä¿å­˜äº†æŒ‚èµ·æ—¶çš„Context ï¼ˆæ­¤åœ°å€å­˜åœ¨pcb->cpä¸­ï¼Œç”¨äºä»¥åæ¢å¤spï¼‰
```

### ç”¨æˆ·è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

ç”¨æˆ·è¿›ç¨‹ä¸å†…æ ¸çº¿ç¨‹é—´çš„åˆ‡æ¢åŸç†æ²¡å•¥å˜åŒ–ï¼Œåªä¸è¿‡ç”¨æˆ·è¿›ç¨‹çš„æ ˆå°±ä¸èƒ½ç”Ÿæ´»åœ¨PCBé‡Œäº†ï¼Œå¾—åœ¨å †ä¸Šæ‰¾ä¸ªå¤§ä¸€ç‚¹çš„åœ°æ–¹ä½ï¼Œæ‰€ä»¥è¿˜éœ€è¦æŠŠspæŒ‡é’ˆå¼•å¯¼åˆ°é‚£é‡Œã€‚

ç°åœ¨è¦æ±‚navyç¨‹åºæ‹¥æœ‰å±äºè‡ªå·±çš„å‡½æ•°è°ƒç”¨æ ˆï¼

- å†…æ ¸æ ˆ: pcbä¸­å­˜å‚¨åˆå§‹åŒ–ç”¨çš„Contextï¼Œåªæœ‰è¿›ç¨‹è¢«åˆ›å»ºæ—¶ä¼šè¢«__am_asm_trapè¿›è¡Œâ€œæ¢å¤â€æ—¶ç”¨åˆ°ã€‚å†…æ ¸æ ˆå¯¹äºç”¨æˆ·è¿›ç¨‹æ¥è¯´è¿˜æœ‰ä»€ä¹ˆç”¨â“
- ç”¨æˆ·æ ˆ: è¿è¡Œæ—¶çš„å‡½æ•°æ ˆï¼Œå½“è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œè¦è¢«æŒ‚èµ·æ—¶ï¼Œå°±åœ¨__am_asm_trapä¸­å°†Contextå­˜åœ¨ç”¨æˆ·æ ˆä¸­ã€‚

æš‚æ—¶è®©ç”¨æˆ·æ ˆä»heap.endå¼€å§‹ï¼Œä»ä¸Šå¾€ä¸‹ç”Ÿé•¿ï¼Œè€Œç”¨æˆ·å †ä¾æ—§æ˜¯`_bss`ç»“å°¾å¤„ï¼ˆ`_end`å¤„ï¼‰ä»ä¸‹å¾€ä¸Šç”Ÿé•¿ã€‚

> [!NOTE]
> ä¸€å±±ä¸èƒ½è—äºŒè™?
>
> å› ä¸ºç›®å‰loaderåªæ˜¯æ ¹æ®elfç»™å‡ºçš„è™šæ‹Ÿåœ°å€è£…è½½å…¥å†…å­˜ï¼Œä¸¤ä¸ªnavyç¨‹åºä¾æ¬¡è£…è½½ï¼Œåè€…å°±è¦†ç›–äº†å‰è€…ã€‚è€Œä¸”ç›®å‰çš„æ ˆç©ºé—´éƒ½æ˜¯ä»heap.endå¼€å§‹å¾€ä¸‹ï¼Œä¸¤ä¸ªnavyç¨‹åºçš„æ ˆéƒ½æ··ç€äº†ã€‚

æ“ä½œç³»ç»Ÿä¸ç¼–è¯‘å™¨çš„çº¦å®šï¼ˆ`nanos:context_uload`ä¸`navy:_start`çš„çº¦å®šï¼‰
- åˆå§‹çš„spå€¼åœ¨a0ä¸­ï¼šä¸ºäº†è®©æ ˆå¼€è®¾åˆ°å †åŒºä¸Šç”³è¯·å‡ºæ¥çš„é¡µé‡Œï¼Œå°±å¾—ç­‰scheduleã€__am_asm_trapç”¨spå¾—åˆ°PCBä¸­Contextçš„åœ°å€å¹¶åˆå§‹åŒ–å®ŒContextåï¼Œmretè¿›å…¥è¿›ç¨‹å‡½æ•°åçš„ç¬¬ä¸€å¥æŒ‡ä»¤ï¼Œç«‹åˆ»è®¾ç½®spä¸ºé¡µä¸Šçš„åœ°å€ã€‚Nanos-liteå’ŒNavyä½œäº†ä¸€é¡¹çº¦å®š: Nanos-liteæŠŠè¿›ç¨‹çš„æ ˆé¡¶åœ°å€è®°å½•åˆ°GPRxä¸­, ç„¶åç”±Navyé‡Œé¢çš„_startä¸­æŠŠæ ˆé¡¶åœ°å€è®¾ç½®åˆ°spå¯„å­˜å™¨ä¸­
- ä¼ å…¥çš„å‚æ•°åœ¨åˆå§‹stackä¸­æ‘†æ”¾çš„æ ·å­ï¼š`nanos:context_uload`ä¸­è®©åˆå§‹æ ˆä»ä¸‹å¾€ä¸Šå­˜argcã€argvã€envpã€string areaï¼Œè®©åˆå§‹spæŒ‡å‘è¿™äº›å‚æ•°çš„æœ€åº•éƒ¨ï¼Œä¹Ÿå°±æ˜¯argcçš„åœ°å€ã€‚è¿™æ ·`navy:_start`åå°±èƒ½æ–¹ä¾¿åœ°é¡ºåºè¯»å–ï¼Œä¹‹åç”¨æˆ·æ ˆå¾€ä¸‹ç”Ÿé•¿å³å¯ï¼Œä¸å¿…ç†ä¼šæœ€ä¸Šé¢çš„è¿™äº›æ•°æ®ã€‚
  ```
  |               |
  +---------------+ <---- ustack.end
  |  Unspecified  |
  +---------------+
  |               | <----------+
  |    string     | <--------+ |
  |     area      | <------+ | |
  |               | <----+ | | |
  |               | <--+ | | | |
  +---------------+    | | | | |
  |  Unspecified  |    | | | | |
  +---------------+    | | | | |
  |     NULL      |    | | | | |
  +---------------+    | | | | |
  |    ......     |    | | | | |
  +---------------+    | | | | |
  |    envp[1]    | ---+ | | | |
  +---------------+      | | | |
  |    envp[0]    | -----+ | | |
  +---------------+        | | |
  |     NULL      |        | | |
  +---------------+        | | |
  | argv[argc-1]  | -------+ | |
  +---------------+          | |
  |    ......     |          | |
  +---------------+          | |
  |    argv[1]    | ---------+ |
  +---------------+            |
  |    argv[0]    | -----------+
  +---------------+
  |      argc     |
  +---------------+ <---- cp->GPRx
  |               |
  ```

è¿˜æ˜¯è¦åŠ¨æ€åœ°åˆ†é…ç”¨æˆ·æ ˆä¸ºæ“ä½œç³»ç»Ÿå †ä¸Š`new_page`ç”³è¯·å‡ºæ¥çš„32KBç©ºé—´ã€‚

> ä¸èƒ½å†åƒåˆšæ‰é‚£æ ·æ‰€æœ‰ç”¨æˆ·è¿›ç¨‹çš„å‡½æ•°æ ˆéƒ½ä»heap.endå¾€ä¸‹ç”Ÿé•¿
> - ä¸€æ˜¯å› ä¸ºç°åœ¨`execve`åœ¨`context_uload`éœ€è¦æ„å»ºæ–°è¿›ç¨‹çš„åˆå§‹æ ˆï¼Œè€Œä¼ å…¥`context_uload`çš„`argv`å¯èƒ½å°±åœ¨ä¹‹å‰è¿›ç¨‹çš„åˆå§‹å‡½æ•°æ ˆé‡Œï¼Œé‚£è¾¹è¯»è¾¹å†™åŒä¸€å—åŒºåŸŸï¼Œå¯èƒ½æ— æ³•ä¿è¯æ­£ç¡®
> - è€Œä¸”åé¢è¦å®ç°å¤šè¿›ç¨‹ï¼Œè‚¯å®šå¾—æå„è‡ªç‹¬ç«‹çš„page

> [!TIP]
> æ³¨æ„ï¼š`context_uload`ä¸­éœ€è¦å…ˆè®¾ç½®å‚æ•°å†loadè£…å…¥ä»£ç ï¼Œå› ä¸º`argv`å¯èƒ½æ˜¯ç”¨æˆ·ç¨‹åºç”¨mallocåˆ†é…åœ¨å †ä¸Šçš„ï¼ˆ`0x83000000`ä¹‹å`_bss`ä¸Šæ–¹çš„åŒºåŸŸï¼Œä¼šè¢«loaderè¦†ç›–ï¼‰

> [!TIP]
> åœ¨Açš„æ‰§è¡Œæµä¸­åˆ›å»ºç”¨æˆ·è¿›ç¨‹Bï¼Œç›´æ¥åœ¨Açš„ç”¨æˆ·æ ˆä¸­`context_uload(current, fname, argv, envp);`ã€`new_page`ç”³è¯·å±äºBçš„ç”¨æˆ·æ ˆï¼Œä¼ å…¥åˆå§‹å‚æ•°ï¼Œå†ç”¨`loader`è£…å…¥Bçš„æ•°æ®å’Œä»£ç ï¼ˆå°†Aæ¯å°¸ç­è¿¹ï¼‰ï¼ˆå› ä¸ºæ­¤æ—¶åœ¨è·‘çš„æ˜¯nanosçš„ä»£ç ï¼Œæ‰€ä»¥å¹¶ä¸å½±å“ç»§ç»­è¿è¡Œï¼‰ï¼Œå†è®©åŸæœ¬å±äºAçš„pcbå†™å…¥Bçš„åˆå§‹åŒ–Contextï¼ˆNTRï¼‰ï¼Œå”¯ç‹¬å‰©ä¸‹çš„æ˜¯Açš„ç”¨æˆ·æ ˆï¼ˆpageå¹¶ä¸ä¼šè¢«nanoså›æ”¶ï¼‰åœ¨å†…å­˜çš„ç©ºæ³¡ä¸­é—è‡­ä¸‡å¹´ï¼Œç„¶å`switch_boot_pcb()`æ˜¯ä¸ºäº†ä¸è®©`schedule()`ä¸­æŠŠ`current->cp`ï¼ˆBçš„pcbï¼‰èµ‹å€¼ä¸º`prev`ï¼ˆç°åœ¨Aç”¨æˆ·æ ˆä¸­è¿˜æœªæ­»å°½çš„å¹½çµContextä¸ContextæŒ‡é’ˆï¼‰

#### BusyBox

busyboxåœ¨fsimgç›®å½•ä¸‹åˆ›å»ºäº†`/usr/bin`çš„ç›®å½•ï¼Œåœ¨PA3.5â€œå±•ç¤ºä½ çš„æ‰¹å¤„ç†ç³»ç»Ÿâ€ntermä¸­çš„`setenv()`é‡Œæ·»åŠ ä¸Šè¿™ä¸ªè·¯å¾„å³å¯ã€‚

åœ¨ä¹‹å`execvp()`ä¸­ä¼šä¾æ¬¡åœ¨PATHä¸­çš„è·¯å¾„ä¸­å¯»æ‰¾æ–‡ä»¶ä»¥è·å¾—å®Œæ•´è·¯å¾„ï¼Œå¦‚æœç³»ç»Ÿè°ƒç”¨å‘ç°æ‰¾ä¸åˆ°å°±åº”è¯¥è¿”å›`-2`ï¼Œè®©`execvp()`ä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªPATHä¸­çš„è·¯å¾„ï¼Œæ‰€ä»¥åœ¨nanosçš„ç³»ç»Ÿè°ƒç”¨`sys_execve`ä¸­æå‰åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚

## 4.3

[å—å¤§ä¿®æ­£çš„Intel 80386æ‰‹å†Œ](https://github.com/NJU-ProjectN/i386-manual)

> [!NOTE]
> i386ä¸æ˜¯ä¸€ä¸ª32ä½çš„å¤„ç†å™¨å—, ä¸ºä»€ä¹ˆè¡¨é¡¹ä¸­çš„åŸºåœ°å€ä¿¡æ¯åªæœ‰20ä½, è€Œä¸æ˜¯32ä½?
>
> å› ä¸ºå¯ä»¥ä¿è¯é¡µè¡¨åœ°å€ä½äº4Kçš„æ•´æ•°å€å¤„ï¼Œæ‰€ä»¥åªéœ€è¦å­˜å‰20ä½å°±è¡Œã€‚

> [!NOTE]
> `pa = (pg_table[va >> 10] & ~0x3ff) | (va & 0x3ff);`
>
> é¡µè¡¨å¤§å°ä¸º1KBï¼Œé¡µå†…åœ°å€10ä½ï¼Œ`pg_table[va >> 10]`æ˜¯ä»pg_tableä¸­å–å‡ºè™šæ‹Ÿåœ°å€vaå¯¹åº”çš„é¡µè¡¨çš„ç‰©ç†åœ°å€ï¼Œ`& ~0x3ff`æ˜¯å¿½ç•¥ä½10ä½ï¼Œ`(va & 0x3ff)`æ˜¯å–å‡ºè™šæ‹Ÿåœ°å€vaçš„é¡µå†…åœ°å€ï¼ˆä½10ä½ï¼‰ï¼Œ`|`ç»“åˆåçš„å°±æ˜¯è™šæ‹Ÿåœ°å€vaå¯¹åº”çš„çœŸå®ç‰©ç†åœ°å€ã€‚

### åœ¨åˆ†é¡µæœºåˆ¶ä¸Šè¿è¡ŒNanos-lite

ç¡¬ä»¶è½¯ä»¶ååŒå¼€å‘çš„ä»»åŠ¡ï¼šnanosåœ¨åˆå§‹åŒ–è¿›ç¨‹æ—¶ï¼Œåˆ°å†…å­˜ä¸­çš„é¡µè¡¨é‡Œå†™å…¥å®ƒè®¾è®¡çš„è™šæ‹Ÿ->ç‰©ç†çš„æ˜ å°„ï¼ˆå†™pteï¼‰ã€‚è¿è¡Œæ—¶cpuå°±ç”¨â€œsatpå¯„å­˜å™¨æä¾›çš„ä¸€çº§é¡µè¡¨ç‰©ç†åœ°å€â€ä¸â€œéœ€è¦è®¿é—®çš„vaddrè™šæ‹Ÿåœ°å€â€ï¼Œåˆ°å¤šçº§é¡µè¡¨é‡Œä¸€å±‚å±‚åœ°æŸ¥pteï¼ŒæŸ¥åˆ°æœ€ç»ˆçš„ç‰©ç†åœ°å€åè¯»å‡ºå³å¯ã€‚åŒæ–¹å…±åŒéµå¾ªä¸€å¥—åˆ†é¡µè§„èŒƒï¼Œä¹Ÿå°±æ˜¯RISC-Vä¸­è§„å®šçš„Sv32ã€‚

ç¡¬ä»¶ï¼š

0. riscvçš„TLBå±äºç¡¬ä»¶éƒ¨åˆ†ï¼Œï¼ˆå’Œcacheä¸€æ ·ï¼‰nemué‡Œæˆ‘ä»¬å¯ä»¥ä¸å®ç°
1. `isa_mmu_check`ä¸ç”¨ç®¡æ˜¯å¦ä¸ºS-Modeï¼Œnemué‡Œä½œä¸ºM-Modeä¹Ÿè¦æåˆ†é¡µï¼Œä¹Ÿä¸ç”¨ç®¡`MMU_FAIL`çš„æƒ…å†µï¼Œæ‰€ä»¥å°±æ ¹æ®satpçš„MODEä½è¿”å›æ˜¯å¦å¼€å¯åˆ†é¡µæœºåˆ¶ï¼ˆæ“ä½œç³»ç»Ÿè°ƒç”¨AMä¸­çš„`vme_init`ï¼Œé‡Œé¢`set_satp(kas.ptr)`å¼€å¯åˆ†é¡µæœºåˆ¶ï¼‰
2. riscvæŒ‡ä»¤å’Œæ•°æ®ä¸¥æ ¼å¯¹é½ï¼Œæ‰€ä»¥ä¸ä¼šåœ¨è¯»å–æ—¶å‡ºç°è·¨é¡µçš„æƒ…å†µï¼Œæ‰€ä»¥åªéœ€è¦åœ¨`vaddr_xxx`å‡½æ•°ä¸­é€šè¿‡`isa_mmu_check`åˆ¤æ–­ä¸ºéœ€è¦åˆ†é¡µè½¬æ¢åï¼Œç›´æ¥è°ƒç”¨`paddr_xxx(isa_mmu_translate(addr, len, xxx), len, data)`å³å¯
3. `isa_mmu_translate`ä¸­ç›´æ¥æŒ‰ç…§æ‰‹å†Œé‡Œâ€œ11.3.2. Virtual Address Translation Processâ€è¿™ä¸€ç« èŠ‚çš„æ­¥éª¤å†™å³å¯ï¼ˆå¯ä»¥ç”¨`goto`å’¯ï¼ï¼‰ã€‚è®°å¾—åˆ¤æ–­è¦panicçš„åœ°æ–¹ã€‚å¯ä»¥ç•¥è¿‡å¯¹pteä¸­çš„`r` `w` `u` `a` `d`ä½çš„æ£€æŸ¥ï¼Œè¿™äº›ä¸ç”¨åšã€‚ï¼ˆå®é™…ä¸Šç­‰ä¼šä½ åœ¨`vme.c:map()`çš„å®ç°é‡Œå¯ä»¥ä¸åˆ›å»º4MBçš„superpageï¼Œæ‰€ä»¥`isa_mmu_translate`çš„è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸€äº›æ­¥éª¤ï¼‰

è½¯ä»¶ï¼šç›®å‰`vme_init`ä¸­æŠŠ`NEMU_PADDR_SPACE`é‡Œçš„æ‰€æœ‰åœ°å€éƒ½åˆ†é…åˆ°é¡µï¼Œå·²ç»å»ºç«‹äº†ä¸€ä¸ªå†…æ ¸é¡µè¡¨`kas`ï¼Œä¸€ä¸ªä¸€çº§é¡µè¡¨æœ€å¤§ç©ºé—´`1K*1K*4KB=4GB`ï¼Œå®Œå…¨è¶³å¤Ÿæ˜ å°„è¿™äº›ã€‚`map()`é‡Œæ ¹æ®ä¼ å…¥çš„`va`ï¼Œåœ¨ä¸€çº§é¡µè¡¨`as->ptr`ä¸­`va`å¯¹åº”çš„ä½ç½®æŸ¥æ‰¾äºŒçº§é¡µè¡¨ï¼Œè‹¥ä¸å­˜åœ¨å°±åœ¨`pgalloc_usr(PGSIZE)`æ–°å»ºä¸€ä¸ªäºŒçº§é¡µè¡¨ï¼Œå†åˆ°äºŒçº§é¡µè¡¨`va`å¯¹åº”çš„PTEä¸­ç›´æ¥å†™å…¥`pa`å³å¯ã€‚

> [!TIP]
> æœ‰å¾ˆå¤šbitã€åœ°å€çš„æ“ä½œï¼Œä¸€ä¸ªä¸å°å¿ƒå°±ä¼šå¯¼è‡´nanoså’Œnemuä¸¤è¾¹å‘ç°PTEä¸åŒ¹é…ï¼Œéœ€è¦å¾ˆé•¿æ—¶é—´çš„debugæ‰èƒ½æ‰¾åˆ°é”™è¯¯ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆå®¹æ˜“ç²—å¿ƒå¤§æ„å•Šâ€¦â€¦
>
> æœ€ç»ˆï¼Œå…³é—­å£°å¡çš„åŠŸèƒ½åï¼ˆåˆ°`libminiSDL`æŠŠaudioçš„å®ç°å…¨éƒ¨æ³¨é‡Šæ‰ï¼‰ï¼Œå³å¯åœ¨è¿è¡Œå†…æ ¸çº¿ç¨‹`hello_fun`çš„åŒæ—¶ï¼Œå¼€å¯`menu`ã€å¹¶è¿›å…¥`nterm`ã€è¾“å…¥`pal --skip`ï¼Œæ— å£°åœ°è·‘ä»™å‰‘ã€‚
>
> å…¶å®ä¿®ç†å£°å¡å¾ˆç®€å•ï¼Œæ‰¾åˆ°é—®é¢˜æ‰€åœ¨ååªç”¨æ·»åŠ ä¸€è¡Œå³å¯ï¼ˆæç¤ºï¼šNEMU_PADDR_SPACEä¸­æ˜¯ä¸æ˜¯å°‘äº†è°ï¼Ÿï¼‰

> [!TIP]
> ç›®å‰åœ¨å †åŒº`[_heap_start, 0x83000000]`é€šè¿‡ç”³è¯·é¡µ`pg_alloc`ï¼Œåˆ›å»ºäº†ä¸€çº§å†…æ ¸é¡µè¡¨ï¼Œå¹¶æŒ‡å‘äº†è®¸å¤šåˆ›å»ºçš„äºŒçº§é¡µè¡¨ï¼Œå¹¶è®©äºŒçº§é¡µè¡¨ä¸­çš„PTEæŒ‡å‘äº†å„ä¸ªâ€œé¡µâ€ã€‚è¿™äº›â€œé¡µâ€å¹¶ä¸æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œå› ä¸ºä½œä¸ºå†…æ ¸ï¼Œæœ‰æƒåˆ©è®¿é—®åˆ°ä»»ä½•åœ°å€ï¼Œè¿™é‡Œæ˜¯åœ¨åˆ†é¡µæœºåˆ¶ä¸Šè®©PTEèƒ½è¦†ç›–åˆ°æ‰€æœ‰å†…å­˜ç©ºé—´`pmem[0x80000000, 0x88000000]`ä¸å¤–è®¾ç©ºé—´`[0xa0000000, 0xa1010000]`ï¼ˆ`NEMU_PADDR_SPACE`æŒ‡æ´¾çš„å‡ ä¸ªç©ºé—´ï¼‰ï¼Œä½œ`è™šæ‹Ÿ==ç‰©ç†`çš„æ’ç­‰æ˜ å°„ã€‚
>
> ï¼ˆæ‰€å¹¸è¿™äº›é¡µè¡¨å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œåªè®©å †ç”Ÿé•¿åˆ°`0x82F72000`çš„ä½å€¼ï¼Œè¿˜æ²¡å¨èƒåˆ°`0x83000000`å¾€ä¸Šçš„è¿›ç¨‹ç©ºé—´ã€‚ä¸è¿‡åé¢é©¬ä¸Šå°±å¯ä»¥è®©ç”¨æˆ·è¿›ç¨‹ä»`0x83000000`æ»šè›‹ï¼Œä¹–ä¹–å¡è¿›ä¸€ä¸ªä¸€ä¸ªç”³è¯·å‡ºæ¥çš„é¡µä¸­ï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒè¿™ä¸ªé™åˆ¶äº†ï¼‰
>
> ç°åœ¨çš„å†…å­˜ï¼š
>
> ```
>                 ğŸ‘† IOE
> IOE:            0xA0000000
> PMEM_END:       0x88000000
>                 ğŸ‘† Process Heap
>                    |=_=|? malloc() in navy
> Process _end(brk)
> Process bss
>                 ğŸ‘† Process code, data
> Process:        0x83000000
>                 ğŸ‘† Kernel Heap (page tables, process stack)
>                    |=_=|? new_page() in nanos, pg_alloc() in am
> _heap_start:    0x82F4F000
> _stack_pointer: 0x82F4F000
>                 ğŸ‘‡ Kernel Stack (size == 0x8000)
> _stack_top:     0x82F47000
> pcb
> lut[128]:       0x82F1D8C8
> _pmem_start:    0x80000000
> ```

- è¿™é‡Œnativeç¯å¢ƒæ²¡æ³•è·‘hello_fun+menuï¼Œä½†èƒ½è·‘hello_fun+hello_funâ“ä½†åšåˆ°PA4.3çš„åé¢nativeå°±èƒ½è·‘äº†

### è®©DiffTestæ”¯æŒåˆ†é¡µæœºåˆ¶

TODO

### åœ¨åˆ†é¡µæœºåˆ¶ä¸Šè¿è¡Œç”¨æˆ·è¿›ç¨‹

`make ARCH=riscv32-nemu update VME=1`ä¹‹åéƒ½è¦ç”¨è¿™ä¸ªå»æ›´æ–°fsimgï¼Œè®©navyç¨‹åºçš„è™šæ‹Ÿåœ°å€ä»`0x40000000`å¼€å§‹

PCBä¸­çš„AddressSpaceæ˜¯æ¯ä¸ªè¿›ç¨‹çš„ä»£ç ã€æ•°æ®æ®µçš„åœ°å€ç©ºé—´ï¼Œè¿˜åŒ…å«ä¸€çº§é¡µè¡¨çš„åœ°å€ã€‚å› ä¸ºä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥æ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦ä¸€ä»½è‡ªå·±çš„AddressSpaceã€‚é‚£kaså±äºè°â“

`context_uload`çš„è¿‡ç¨‹
1. `protect()` åˆå§‹åŒ–è¿›ç¨‹çš„AddressSpaceï¼Œæ–°å»ºä¸€çº§é¡µè¡¨å¹¶å°†åœ°å€è®°å½•åœ¨AddressSpaceä¸­
2. `loader()` å°†ç¨‹åºçš„ä»£ç ã€æ•°æ®è£…å…¥ä¸€ä¸ªä¸ªå †ä¸Šç”³è¯·å‡ºæ¥çš„ç‰©ç†é¡µpageä¸­ï¼Œè°ƒç”¨`map()`ç¼–å†™ä¸€çº§ã€äºŒçº§é¡µè¡¨é¡¹
  > æ³¨æ„ï¼šSegmentèµ·å§‹çš„è™šæ‹Ÿåœ°å€ä¸ä¸€å®šæ˜¯å¯¹é½çš„ï¼ŒbssåŒºåŸŸä¹Ÿä¸ä¸€å®šåªæœ‰ä¸€é¡µã€‚loaderå®ç°ä¸æ­£ç¡®ï¼Œå°†ä¼šå¯¼è‡´ä¸‹ä¸€èŠ‚é‡åˆ°éå¸¸å¥‡æ€ªçš„bug
3. åˆå§‹åŒ–PCBä¸­çš„åˆå§‹Contextï¼Œå°†`pcb->cp`æŒ‡å‘å®ƒ
4. åœ¨å †ä¸Šç”³è¯·32KBçš„ç©ºé—´ä½œä¸ºåˆå§‹æ ˆï¼Œä»¤å…¶ä½äºè¿›ç¨‹AddressSpaceçš„å°¾éƒ¨ï¼ˆè®¾å…¶è™šæ‹Ÿåœ°å€ä¸º`[0x80000000 - 8*PGSIZE, 0x80000000]`ï¼‰ï¼Œè°ƒç”¨`map()`ç¼–å†™ä¸€çº§ã€äºŒçº§é¡µè¡¨é¡¹ã€‚æœ€åå¡«å…¥åˆå§‹æ ˆçš„å‚æ•°string areaã€argvã€envp...
5. `pcb->cp->GPRx = åˆå§‹æ ˆé¡¶`

è¿›ç¨‹åˆ‡æ¢çš„è¿‡ç¨‹å¤šäº†â€œä¿å­˜ã€æ¢å¤satpï¼ˆä¸€çº§é¡µè¡¨åœ°å€ï¼‰â€çš„æ“ä½œ

å…¶ä»–çš„è§£é‡Šéƒ½å†™åœ¨ä»£ç çš„æ³¨é‡Šé‡Œäº†ï¼Œè¿™é‡Œä¸é‡è¿°äº†

> [!TIP]
> åˆ°ç°åœ¨è¿›ç¨‹çš„ä»£ç ã€æ•°æ®æ®µï¼Œä»¥åŠè¿›ç¨‹çš„å‡½æ•°æ ˆï¼Œéƒ½æ¬å®¶åˆ°äº†åŠ¨æ€åˆ†é…çš„é¡µä¸­ï¼Œè€Œå †åŒºè¿˜æ²¡æœ‰ï¼Œæ‰€ä»¥åŒ…å«`malloc`çš„navyç¨‹åºéƒ½æ— æ³•è¿è¡Œ

> [!TIP]
> nativeçš„`map()`è¦æ±‚`va`å’Œ`pa`å¯¹é½é¡µï¼Œè€Œæˆ‘çš„å®ç°ä¸­ä¸è¦æ±‚ï¼Œæ‰€ä»¥å¯ä»¥åœ¨nativeçš„`map()`æ·»åŠ `va = (void *)((uintptr_t)va & (~0xfff));`ï¼Œè¿™æ ·åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨`map()`æ—¶å°±ä¸ç”¨é¡¾è™‘`va`äº†

### è®©DiffTestæ”¯æŒåˆ†é¡µæœºåˆ¶(2)

TODO

### åœ¨åˆ†é¡µæœºåˆ¶ä¸Šè¿è¡Œä»™å‰‘å¥‡ä¾ ä¼ 

> ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„bugï¼Œdummyé‡Œ`printf`ä¸€ä¸‹ï¼Œlibcé‡Œè°ƒç”¨`_sbrk`ä¼ å…¥çš„addrç«Ÿç„¶æ¯”`0xB0000000`è¿˜å¤§ï¼Œæ— æ³•ç†è§£æ— æ³•æ’æŸ¥çš„bugâ€¦â€¦æœ€åè¿˜æ˜¯å¯¹æ¯”äº†å…¶ä»–äººçš„ä»£ç ï¼Œå‘ç°ä¹‹å‰ä¸€èŠ‚`loader()`çš„åˆ†é¡µè£…å…¥å†™çš„ä¸å¯¹ï¼Œå¾—è®¤çœŸå†™å•Šï¼ï¼ˆä¸»è¦æ˜¯ä¸Šä¸€èŠ‚å†™å®Œåç¼ºå°‘æµ‹è¯•ï¼Œnavyçš„é‚£äº›testå¤§å¤šéƒ½åŒ…å«`printf`ï¼Œè€Œæœ‰`printf`å°±å¾—è°ƒç”¨`malloc`ï¼Œå°±æ²¡æ³•æµ‹è¯•ï¼‰
> 
> ```c
> // é”™è¯¯ä»£ç ç¤ºä¾‹
> int offset = 0;
> while (offset + PGSIZE < phdr.p_memsz) {
>   void *page = new_page(1);
>   memset(page, 0, PGSIZE);
>   map(&(pcb->as), (void *)phdr.p_vaddr + offset, page, MMAP_READ | MMAP_WRITE);
>   fs_read(fd, page, PGSIZE);
>   offset += PGSIZE;
> }
> void *page = new_page(1);
> memset(page, 0, PGSIZE);
> map(&(pcb->as), (void *)phdr.p_vaddr + offset, page, MMAP_READ | MMAP_WRITE);
> fs_read(fd, page, phdr.p_memsz - offset);
> ```
> 
> é‡åˆ°è¿™æ ·çš„ä¸€ä¸ªSegmentï¼Œä¼šç›´æ¥è·³è¿‡whileï¼Œåˆ°æœ€ä¸‹é¢æˆäº†`fs_read(fd, page, 0x008d8);`ï¼Œå¯èƒ½ä¼šæŠŠåƒåœ¾å€¼è¯»åˆ°bssä¸­ï¼š
> ```
> Type  Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
> LOAD  0x007000 0x40007000 0x40007000 0x0089c 0x008d8 RW  0x1000
> ```
> 
> 
> è¿˜æœ‰è¿™ç§Segmentï¼Œä¼šç›´æ¥è·³è¿‡whileï¼Œåˆ°æœ€ä¸‹é¢æˆäº†`fs_read(fd, page, 0x008d8);`ï¼Œæ›´æ˜¯ç¦»è°±äº†ï¼š
> ```
> Type  Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
> LOAD  0x015000 0x40015000 0x40015000 0x00ae4 0x01d34 RW  0x1000
> ```

`max_brk`å¯ä»¥åœ¨`loader()`ä¸­åˆå§‹åŒ–

> [!NOTE]
> nativeçš„VMEå®ç°ï¼šå°è¯•é˜…è¯»nativeçš„VMEå®ç°, ä½ å‘ç°nativeæ˜¯å¦‚ä½•å®ç°VMEçš„? ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·åš?
>
> TODO

> [!NOTE]
>  å¯ä»¥åœ¨ç”¨æˆ·æ ˆé‡Œé¢åˆ›å»ºç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡å—? ucontext()çš„è¡Œä¸ºæ˜¯åœ¨å†…æ ¸æ ˆkstackä¸­åˆ›å»ºç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡. æˆ‘ä»¬æ˜¯å¦å¯ä»¥å¯¹ucontext()çš„è¡Œä¸ºè¿›è¡Œä¿®æ”¹, è®©å®ƒåœ¨ç”¨æˆ·æ ˆä¸Šåˆ›å»ºç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡? ä¸ºä»€ä¹ˆ?
>
> å¯ä»¥ï¼Œåæ­£ä¹‹å‰çš„spä¹Ÿæ˜¯ç»è¿‡ä¸¤æ¬¡è·³è½¬ï¼ˆç¬¬ä¸€æ¬¡è·³åˆ°`pcb->cp`å»è¯»å–åˆå§‹Contextï¼Œç¬¬äºŒæ¬¡è·³åˆ°åˆå§‹æ ˆçš„æ ˆé¡¶ï¼‰ï¼ŒæŠŠåˆå§‹Contextæ”¾åˆ°ç”¨æˆ·è¿›ç¨‹æ ˆä¸­ï¼Œåªä¸è¿‡å°±æ˜¯æŠŠç¬¬ä¸€æ¬¡spçš„è·³è½¬å¼•å¯¼åˆ°`ustack.end - sizeof(Context)`å¤„ï¼Œç„¶ååœ¨`context_uload`ä¸­éœ€è¦åœ¨`Context`ä¸‹é¢ç»§ç»­æ”¾å…¥åˆå§‹åŒ–å‚æ•°ï¼Œæ„é€ åˆå§‹æ ˆã€‚
> ```
>   |               |
>   +---------------+ <---- ustack.end
>   |    Context    |
>   +---------------+ <---- pcb->cp
>   |    åˆå§‹åŒ–å‚æ•°   |
>   +---------------+ <---- cp->GPRx
>   |               |
> ```

ç°åœ¨çš„å†…å­˜åˆ†å¸ƒï¼Œæœ‰äº†åˆ†é¡µåå˜å¾—å¤šä¹ˆç®€æ´å•Šï¼ï¼
```
                ğŸ‘† IOE
IOE:            0xA0000000
PMEM_END:       0x88000000
                ğŸ‘† Kernel Heap (page tables, pages(process code, data, stack, heap))
                   |=_=|? new_page() in nanos, pg_alloc() in am
_heap_start:    0x82B2F000
_stack_pointer: 0x82B2F000
                ğŸ‘‡ Kernel Stack (size == 0x8000)
_stack_top:     0x82B27000
pcb
lut[128]:       0x82AFDDF0
_pmem_start:    0x80000000
```

### æ”¯æŒè™šå­˜ç®¡ç†çš„å¤šé“ç¨‹åº

å†…æ ¸çº¿ç¨‹hello_funçš„PCBå¹¶æ²¡æœ‰æŒ‡å‘ä»»ä½•ä¸€çº§é¡µè¡¨å•Šï¼Œåªæ˜¯ç”±äºç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨å¤åˆ¶äº†å†…æ ¸é¡µè¡¨ï¼ˆæ‰€æœ‰è™šæ‹Ÿåœ°å€ç©ºé—´éƒ½ä¼šåŒ…å«å†…æ ¸æ˜ å°„ï¼‰ï¼Œè€Œä¸”åœ¨`__am_switch`ä¸­åªåœ¨`c->pdir!=NULL`æ—¶æ‰ä¿®æ”¹`satp`ï¼Œäºæ˜¯hello_funä¾¿å€Ÿç”¨äº†ç”¨æˆ·è¿›ç¨‹çš„ä¸€çº§é¡µè¡¨â€¦â€¦è¿™æ ·åšæ˜¯å› ä¸ºæ²¡æœ‰è®¾è®¡ä¿æŠ¤æœºåˆ¶ï¼Ÿ

è€Œä¸”ç°åœ¨ç”¨æˆ·è¿›ç¨‹æ ˆä¸Šä¼šç”Ÿé•¿å‡ºç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œè€Œä¸€èˆ¬çš„æ“ä½œç³»ç»Ÿåœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶åº”è¯¥è½¬å…¥â€œå†…æ ¸æ€â€ï¼Œåœ¨ç”¨æˆ·è¿›ç¨‹è®¿é—®ä¸åˆ°çš„åœ°å€ç©ºé—´ï¼Œè¿è¡Œä¸€ä¸ªæ‰€å±äºè¯¥è¿›ç¨‹çš„å†…æ ¸æ ˆï¼ˆç­‰åˆ°åé¢PA4.4å°±ä¼šä¸ºç”¨æˆ·è¿›ç¨‹å®ç°â€œç”¨æˆ·æ ˆä¸å†…æ ¸æ ˆâ€çš„åˆ‡æ¢äº†ï¼‰

åˆ°ç°åœ¨å·²ç»å¯ä»¥å¹¶å‘è¿è¡Œpalå’Œhelloä¸¤ä¸ªç”¨æˆ·è¿›ç¨‹äº†ï¼

> [!NOTE]
> è®©Nanos-liteåŠ è½½ä»™å‰‘å¥‡ä¾ ä¼ å’Œhelloè¿™ä¸¤ä¸ªç”¨æˆ·è¿›ç¨‹; æˆ–è€…æ˜¯åŠ è½½NTermå’Œhelloå†…æ ¸çº¿ç¨‹, ç„¶åä»NTermå¯åŠ¨ä»™å‰‘å¥‡ä¾ ä¼ , ä½ åº”è¯¥ä¼šåœ¨è¿è¡Œçš„æ—¶å€™è§‚å¯Ÿåˆ°é”™è¯¯. å°è¯•åˆ†æè¿™ä¸€é”™è¯¯çš„åŸå› , å¹¶æ€»ç»“ä¸ºäº†æ”¯æŒè¿™ä¸€åŠŸèƒ½, æˆ‘ä»¬éœ€è¦æ»¡è¶³ä»€ä¹ˆæ ·çš„æ¡ä»¶. è¿™å¯ä»¥è¯´æ˜¯ä¸€å‘¨ç›®æœ€éš¾çš„ä¸€é“æ€è€ƒé¢˜äº†, è™½ç„¶æˆ‘ä»¬ä¼šåœ¨PA4çš„æœ€åç»™å‡ºåˆ†æ, å–œæ¬¢æŒ‘æˆ˜çš„åŒå­¦ä»ç„¶å¯ä»¥åœ¨è¿™é‡Œå°è¯•ç‹¬ç«‹æ€è€ƒ: å¦‚æœä½ èƒ½ç‹¬ç«‹è§£å†³è¿™ä¸ªé—®é¢˜, è¯´æ˜ä½ å¯¹è®¡ç®—æœºç³»ç»Ÿçš„ç†è§£å¯ä»¥è¯´æ˜¯ç›¸å½“äº†å¾—äº†.
>
> æˆ‘æ²¡æœ‰é‡åˆ°ä»»ä½•é—®é¢˜ã€‚è§£é‡Šè§[PA4.4](#å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆçš„åˆ‡æ¢)

> [!TIP]
> å®ç°åˆ†é¡µåftraceåœ¨navyç¨‹åºä¸­ä¾æ—§å¯ä»¥ä½¿ç”¨ã€‚å› ä¸º`pc`ï¼ˆä¼ å…¥`ftrace_log`çš„åœ°å€ï¼‰æ˜¯æœªç»è¿‡mmuç¿»è¯‘çš„è™šæ‹Ÿåœ°å€ï¼ˆåªæœ‰åœ¨`vaddr_read`å’Œ`vaddr_write`æ—¶æ‰ä¼šç”¨mmuç¿»è¯‘ï¼‰ï¼Œåˆšå¥½å¯ä»¥å¯¹åº”åˆ°elfä¸­çš„ä¿¡æ¯ã€‚

## 4.4

ä¹‹å‰çš„è¿›ç¨‹åˆ‡æ¢é çš„æ˜¯è¿›ç¨‹è‡ªè§‰è¿›è¡Œ`yield()`è¿›è¡Œé€€è®©CPUçš„ä½¿ç”¨æƒï¼Œä¸å¤Ÿä¸¥è‹›ï¼Œè¿˜æ˜¯è¦ç”¨å¤–éƒ¨çš„ç‰©ç†ç›‘ç£è€…â€”â€”æ—¶é’Ÿã€‚

æ¯10msçš„æ—¶é’Ÿä¿¡å·æ˜¯é€šè¿‡`/nemu/src/device/alarm.c`å®ç°çš„ï¼ˆè¿™ä¸œè¥¿åœ¨PA2.5çš„æ–‡æ¡£ä¸­æè¿‡ä¸€å˜´ï¼‰ï¼Œåˆ©ç”¨`<signal.h>`åº“å®ç°å®šæ—¶å¬å”¤`alarm_sig_handler`ã€‚

å¤„äºå…³ä¸­æ–­çš„éƒ¨åˆ†ï¼š
- ecallï¼ˆnavyä¸­çš„`_syscall_`ä¸amä¸­çš„`yield()`ï¼‰åˆ°mretçš„é˜¶æ®µ
- æ—¶é’Ÿä¸­æ–­åˆ°mretçš„é˜¶æ®µ

nanosè¿è¡Œä¸¤ä¸ªç”¨æˆ·è¿›ç¨‹çš„è¿‡ç¨‹ï¼š
1. nanosçš„`main()`åˆå§‹åŒ–é˜¶æ®µï¼Œå…¨ç¨‹å¤„äºå…³ä¸­æ–­ï¼šä»…åœ¨nemuå¼€æœº`init_isa()`ä¸­è®¾ç½®è¿‡`mstatus`ä¸º0x1800
2. nanosçš„`main()`åˆå§‹åŒ–ç»“æŸï¼Œ`yield()->ecall`ï¼Œå…³ä¸­æ–­ï¼Œ`__am_asm_trap`ä¿å­˜nanoså†…æ ¸åˆå§‹åŒ–çº¿ç¨‹çš„Contextï¼ˆæ°¸è¿œä¸ä¼šå†å›åˆ°è¿™é‡Œï¼Œæ°¸è¿œä¸ä¼šè¢«ä½¿ç”¨äº†ï¼‰ï¼Œ`__am_irq_handle->do_event->schedule`ï¼Œè·å¾—åˆ°è¿›ç¨‹0çš„åˆå§‹Contextåœ°å€`pcb[0]->cp`ï¼Œå›åˆ°`__am_irq_handle`è®¾ç½®satpä¸€çº§é¡µè¡¨åœ°å€ï¼Œå›åˆ°`__am_asm_trap`è®©`sp`è·³è½¬åˆ°`pcb[0]->cp`ï¼Œæ¢å¤Contextï¼Œæœ€åmretè®©pcè·³è½¬åˆ°entryï¼Œå¼€ä¸­æ–­ï¼Œæ‰§è¡Œç¬¬ä¸€å¥æŒ‡ä»¤`mv sp, a0`è®©spå†æ¬¡è·³è½¬åˆ°ç”¨æˆ·æ ˆæ ˆé¡¶ï¼Œæ¥ç€å°±å¼€å§‹äº†è¿›ç¨‹0çš„å‡½æ•°æ ˆäººç”Ÿï¼Œcall_mainè·å¾—ä¼ å…¥çš„å‚æ•°ï¼Œmainâ€¦â€¦
3. è¿›ç¨‹0å¤§çº¦è¿è¡Œäº†10msï¼Œæ—¶é’Ÿä¸­æ–­ï¼Œå…³ä¸­æ–­ï¼Œ`__am_asm_trap`ä¿å­˜è¿›ç¨‹0çš„Contextï¼Œ`__am_irq_handle->do_event->schedule`ï¼Œè·å¾—åˆ°è¿›ç¨‹1çš„åˆå§‹Contextåœ°å€`pcb[1]->cp`ï¼Œå›åˆ°`__am_irq_handle`è®¾ç½®satpä¸€çº§é¡µè¡¨åœ°å€ï¼Œå›åˆ°`__am_asm_trap`è®©`sp`è·³è½¬åˆ°`pcb[1]->cp`ï¼Œä¹‹ååŒä¸Š
4. å¾ªç¯å¾€å¤

è¿™é‡Œå¯¹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æè¿°æ¯”è¾ƒç®€ç•¥ï¼Œä¹‹å‰åœ¨[Nanos-Liteçš„ä¸Šä¸‹æ–‡åˆ‡æ¢](#Nanos-Liteçš„ä¸Šä¸‹æ–‡åˆ‡æ¢)æœ‰æ›´è¯¦ç»†çš„æè¿°ã€‚

> [TIP]
> åˆ°è¿™é‡Œå¯ä»¥å»é™¤nanosä¸­æ‰€æœ‰çš„`yield()`ï¼ˆé™¤äº†`main()`ã€`SYS_yield`å’Œ`sys_execve()`ä¸­çš„ï¼‰
>
> å¯ä»¥åˆ©ç”¨æ—¶é’Ÿä¸­æ–­ï¼Œå¹¶å‘åœ°è¿è¡Œä¸¤ä¸ªç”¨æˆ·è¿›ç¨‹äº†ï¼šhello+pal

> [!NOTE]
> ä¸­æ–­å’Œç”¨æˆ·è¿›ç¨‹åˆå§‹åŒ–ï¼šæˆ‘ä»¬çŸ¥é“, ç”¨æˆ·è¿›ç¨‹ä»Navyçš„_startå¼€å§‹è¿è¡Œ, å¹¶ä¸”åœ¨_startä¸­è®¾ç½®æ­£ç¡®çš„æ ˆæŒ‡é’ˆ. å¦‚æœåœ¨ç”¨æˆ·è¿›ç¨‹è®¾ç½®æ­£ç¡®çš„æ ˆæŒ‡é’ˆä¹‹å‰å°±åˆ°æ¥äº†ä¸­æ–­, æˆ‘ä»¬çš„ç³»ç»Ÿè¿˜èƒ½å¤Ÿæ­£ç¡®åœ°è¿›è¡Œä¸­æ–­å¤„ç†å—?
>
> ä¸å¯èƒ½åœ¨â€œç”¨æˆ·è¿›ç¨‹è®¾ç½®æ­£ç¡®çš„æ ˆæŒ‡é’ˆä¹‹å‰å°±åˆ°å‘ç”Ÿä¸­æ–­â€ï¼Œå› ä¸ºmretå¼€å¯ä¸­æ–­åï¼Œè‡³å°‘ä¼šè¿è¡Œä¸€å¥æŒ‡ä»¤æ‰å¯èƒ½å‘ç”Ÿæ—¶é’Ÿä¸­æ–­ï¼Œè€Œç¬¬ä¸€å¥æŒ‡ä»¤å°±æ˜¯`mv sp, a0`è®¾ç½®æ­£ç¡®çš„æ ˆæŒ‡é’ˆã€‚
>
> è€Œå¦‚æœåœ¨è¿è¡Œå®Œè¿™å¥æŒ‡ä»¤åå‘ç”Ÿäº†ä¸­æ–­ï¼Œä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œåæ­£trapé‡Œå¹¶ä¸ä¼šå¯¹`sp`ä¹‹ä¸Šçš„å†…å­˜ï¼ˆé‚£äº›ä¼ å…¥çš„å‚æ•°ï¼‰è¿›è¡Œä¿®æ”¹ï¼Œmretå›æ¥åå½“ç„¶å¯ä»¥ç»§ç»­æ­£å¸¸è¿è¡Œ

### åŸºäºæ—¶é—´ç‰‡çš„è¿›ç¨‹è°ƒåº¦

è®©palæ¯é‡åˆ°`schedule()` 25æ¬¡ï¼Œæ‰è®©å‡ºCPU 1æ¬¡ï¼Œå¤šå¤šéœ¸å CPUã€‚

### å†…æ ¸æ ˆå’Œç”¨æˆ·æ ˆçš„åˆ‡æ¢

> [!NOTE]
> ä¸ºä»€ä¹ˆç›®å‰ä¸æ”¯æŒå¹¶å‘æ‰§è¡Œå¤šä¸ªç”¨æˆ·è¿›ç¨‹?
>
> ä¸å­˜åœ¨çš„é—®é¢˜ã€‚å¦‚æœä¼ å…¥`__am_irq_handle`çš„`Context*`ä»¥åŠ`user_handler`çš„è¿”å›å€¼`Context*`æ˜¯è™šæ‹Ÿåœ°å€ï¼Œæ‰ä¼šæœ‰æ–‡æ¡£é‡Œè¯´çš„é—®é¢˜ã€‚ä½†æˆ‘è¿™é‡Œçš„ç°å®æ˜¯ï¼Œè¿™äº›éƒ½æ˜¯åˆ†é¡µåçš„ç‰©ç†é¡µé‡Œçš„ç‰©ç†åœ°å€ã€‚

> [!NOTE]
> æ‰“ç ´å¾ªç¯ä¾èµ–çš„æ–¹æ³•ï¼šå°†åœ°å€ç©ºé—´æè¿°ç¬¦æŒ‡é’ˆå­˜æ”¾åœ¨PCBä¸­, å¹¶åœ¨VMEä¸­æ·»åŠ ä¸€ä¸ªæ–°API switch_addrspace(), ä»æ­£ç¡®æ€§æ¥è€ƒè™‘, è¿™ä¸€æ–¹æ¡ˆæ˜¯å¦å¯è¡Œ?
>
> åº”è¯¥å¯ä»¥å§ã€‚ä½†åé¢è¿˜æ˜¯è¦å®ç°ç”¨æˆ·æ ˆä¸å†…æ ¸æ ˆçš„åˆ‡æ¢ï¼ŒæŠŠä¿å­˜çš„Contextå­˜å…¥åˆ°å†…æ ¸æ ˆä¸­ï¼Œç”¨è¿™ç§æ–¹æ³•è®©`Context*`ä½äºå†…æ ¸ç©ºé—´ï¼Œæ‰€ä»¥å°±ä¸è€ƒè™‘è¿™ç§æ–¹æ¡ˆäº†ã€‚

æ¥ä¸‹æ¥ï¼Œä¸æ˜¯ä¸ºäº†â€œæ”¯æŒå¹¶å‘æ‰§è¡Œå¤šä¸ªç”¨æˆ·è¿›ç¨‹â€ï¼ˆè¿™ä¸ªå·²ç»å®ç°äº†ï¼‰ï¼Œè€Œæ˜¯ä¸ºäº†å®ç°ç”¨æˆ·æ ˆï¼ˆç”¨æˆ·æ€ï¼‰å’Œå†…æ ¸æ ˆï¼ˆå†…æ ¸æ€ï¼‰çš„åˆ‡æ¢ï¼Œè¦åœ¨ç³»ç»Ÿè°ƒç”¨ã€è¿›ç¨‹åˆ‡æ¢æ—¶ï¼ŒæŠŠè¿™éƒ¨åˆ†çš„å‡½æ•°æ ˆæ”¾åœ¨å†…æ ¸ç©ºé—´ï¼ˆPCBï¼‰ä¸­ã€‚

> [!NOTE]
>  ç”¨æˆ·æ€å’Œæ ˆæŒ‡é’ˆï¼šä¸€èˆ¬æ¥è¯´, å¤„ç†å™¨çš„ç‰¹æƒçº§ä¹Ÿæ˜¯ä¸€ç§çŠ¶æ€. æˆ‘ä»¬æ˜¯å¦å¯ä»¥é€šè¿‡æ ˆæŒ‡é’ˆçš„å€¼æ¥åˆ¤æ–­å½“å‰ä½äºç”¨æˆ·æ€è¿˜æ˜¯å†…æ ¸æ€?
>
> - ä»ç‰©ç†åœ°å€æ¥è¯´ï¼šå¦‚æœ`sp`å¤§äº`_heap_start`ï¼Œåˆ™è¡¨æ˜åœ¨ç”¨æˆ·è¿›ç¨‹åœ¨å †ä¸Šç”³è¯·çš„é¡µé‡Œï¼Œæ˜¯ç”¨æˆ·è¿›ç¨‹çš„æ ˆã€‚å¦‚æœå°äº`_heap_start`ï¼Œåˆ™è¦ä¹ˆæ˜¯æœ€åˆæ“ä½œç³»ç»Ÿçš„æ ˆ`[_stack_pointer, _stack_top]`ï¼Œè¦ä¹ˆæ˜¯PCBé‡Œçš„å†…æ ¸çº¿ç¨‹æ ˆã€‚
> - ä»è™šæ‹Ÿåœ°å€æ¥è¯´ï¼šä½äº`USER_SPACE RANGE(0x40000000, 0x80000000)`ä¸­çš„æ˜¯ç”¨æˆ·æ ˆï¼Œåä¹‹æ˜¯å†…æ ¸æ ˆ

å†…æ ¸æ ˆå°±æ˜¯PCBé‡Œçš„stackï¼ˆæ¯ä¸ªç”¨æˆ·è¿›ç¨‹/å†…æ ¸çº¿ç¨‹éƒ½åœ¨PCBé‡Œæ‹¥æœ‰è‡ªå·±çš„å†…æ ¸æ ˆï¼Œç”¨æˆ·è¿›ç¨‹è¿˜åœ¨å †ä¸Šçš„é¡µé‡Œæ‹¥æœ‰è‡ªå·±çš„ç”¨æˆ·æ ˆï¼‰ï¼Œä¸‹é¢çš„`ksp`æ˜¯`å½“å‰è¿›ç¨‹/çº¿ç¨‹çš„å†…æ ¸æ ˆé¡¶åœ°å€`çš„å…¨å±€å˜é‡ï¼ˆCPUä¸­çš„CSRå¯„å­˜å™¨ï¼‰ï¼Œä½œç”¨æ˜¯åœ¨å½“å‰è¿›ç¨‹çº¿ç¨‹è¦trapæ—¶ï¼Œæä¾›å†…æ ¸æ ˆé¡¶åœ°å€ï¼Œè®©ä¿å­˜Contextã€ç³»ç»Ÿè°ƒç”¨ç­‰å‡½æ•°æ ˆéƒ½å‘ç”Ÿåœ¨å†…æ ¸æ ˆä¸­ã€‚åªéœ€è¦è®°å½•`å½“å‰è¿›ç¨‹/çº¿ç¨‹çš„å†…æ ¸æ ˆé¡¶åœ°å€`å°±è¶³å¤Ÿäº†ï¼Œå› ä¸ºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹æ—¶ï¼Œ`ksp`ä¹Ÿä¼šéšä¹‹å˜åŒ–ã€‚

å¯¹äºæ–°å»ºè¿›ç¨‹/çº¿ç¨‹çš„æ“ä½œï¼Œåœ¨`__am_asm_trap`ä¸­â€œæ¢å¤â€åˆå§‹Contextçš„éƒ¨åˆ†ä¹Ÿå±äºå†…æ ¸æ ˆä¸Šçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¹‹å‰åœ¨[PA4.3](#åœ¨åˆ†é¡µæœºåˆ¶ä¸Šè¿è¡Œä»™å‰‘å¥‡ä¾ ä¼ )é‡Œâ€œåœ¨ç”¨æˆ·æ ˆä¸Šåˆ›å»ºç”¨æˆ·è¿›ç¨‹ä¸Šä¸‹æ–‡â€çš„å·¥ä½œç™½åšäº†ï¼Œç°åœ¨è¿˜æ˜¯è¦æŠŠåˆå§‹Contextæ”¾åœ¨PCBçš„æ ˆé‡Œã€‚

```c
// TIP: æ‰€è°“çš„å…¨å±€å˜é‡ï¼Œå°±æ˜¯CPUä¸­çš„CSRå¯„å­˜å™¨
ebreak or æ—¶é’Ÿä¸­æ–­
__am_asm_trap {
  if (æ€ is ç”¨æˆ·æ€) { // ä»ç”¨æˆ·è¿›ç¨‹ï¼ˆpalï¼‰è¿›å…¥CTE
    Context.usp = $sp; // è¿›å…¥trapæ—¶ï¼Œspä¾æ—§åœ¨ç”¨æˆ·æ ˆçš„æ ˆé¡¶ã€‚å› ä¸ºè¿›å…¥trapåspä¼šè·³è½¬åˆ°å†…æ ¸æ ˆï¼Œæ‰€ä»¥è¿™é‡Œè¦ç”¨Contextä¿å­˜ï¼Œç­‰é€€å‡ºtrapæ—¶ç”¨äºæ¢å¤
    $sp = ksp; // spè·³è½¬åˆ°ç”¨æˆ·è¿›ç¨‹å¯¹åº”çš„å†…æ ¸æ ˆï¼Œkspæ˜¯å…¨å±€å˜é‡
  }
  else { // ä»å†…æ ¸çº¿ç¨‹ï¼ˆhello_funï¼‰è¿›å…¥CTE
    // ä»¥åè‹¥æ˜¯ä»ç”¨æˆ·è¿›ç¨‹åˆ‡æ¢å›å†…æ ¸çº¿ç¨‹ï¼Œspå¹¶ä¸ç”¨è·³è½¬
    // ç°åœ¨spä¹Ÿä¸ç”¨è·³è½¬åˆ°å…¶ä»–åœ°æ–¹
  }
  Context.nextæ€ = æ€; // æ¯ä¸ªè¿›ç¨‹/çº¿ç¨‹å„è‡ªåœ¨trapä¹‹ååº”è¯¥æ¢å¤çš„æ€

  // save context
  // ...

  __am_irq_handle(c); // å¯èƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå¯èƒ½æ˜¯Context Switchï¼ˆç”¨æˆ·è¿›ç¨‹å†…æ ¸çº¿ç¨‹é—´ï¼Œéšæ„åˆ‡æ¢ï¼‰
  // å¦‚æœæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œspä¸å˜
  // å¦‚æœæ˜¯Context Switchï¼Œspè·³è½¬ä¸ºå¦ä¸€ä¸ªè¿›ç¨‹/çº¿ç¨‹æ ˆçš„spï¼Œä½†ä¸ç®¡æ˜¯å•¥ï¼Œç°åœ¨spéƒ½åªä¼šåœ¨å†…æ ¸æ ˆä¸­
  //   Context Switchçš„ç‰¹æ®Šæƒ…å†µ: åˆå§‹åŒ–è¿›ç¨‹/çº¿ç¨‹ï¼Œspåœ¨å†…æ ¸æ ˆåˆå§‹Contextçš„ä¸‹æ–¹

  // restore context
  // ...

  æ€ = Context.nextæ€; // æ¥ä¸‹æ¥trapå‡ºå»åº”è¯¥å˜æˆä»€ä¹ˆæ€
  if (æ€ == ç”¨æˆ·æ€) { // æ¥ä¸‹æ¥è¿è¡Œç”¨æˆ·è¿›ç¨‹
    ksp = $sp; // å…¨å±€å˜é‡kspè®°å½•å½“å‰å†…æ ¸æ ˆçš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯¥ç”¨æˆ·è¿›ç¨‹ä¸‹ä¸€æ¬¡è¿›å…¥CTEåspåº”è¯¥è·³è½¬å»çš„ä½ç½®
    $sp = Context.usp; // spè·³è½¬å›å„è‡ªå¯¹åº”çš„ç”¨æˆ·æ ˆ
  }
  else { // æ¥ä¸‹æ¥è¿è¡Œå†…æ ¸çº¿ç¨‹
    // ä¸ç”¨æ›´æ”¹kspï¼Œè¿™æ˜¯ç»™ç”¨æˆ·è¿›ç¨‹ç”¨çš„
    // spä¸éœ€è¦è·³è½¬
  }
}
```

å…³äºCTEé‡å…¥
- ç”¨æˆ·è¿›ç¨‹è¿›è¡Œ`_syscall_(yield)`ä¼š`ecall`ä¸¤æ¬¡çš„ç°è±¡ï¼Œåœ¨[PA3.3ç³»ç»Ÿè°ƒç”¨](#ç³»ç»Ÿè°ƒç”¨)ä¸­è§£é‡Šè¿‡ã€‚ä¸Šè¿°çš„ä»£ç åœ¨`yield()`ç¬¬äºŒæ¬¡è¿›å…¥`__am_asm_trap`æ—¶ï¼Œ`æ€`ä¾æ—§ä¸º`ç”¨æˆ·æ€`ï¼Œå¯¼è‡´å†ä¸€æ¬¡`$sp = ksp`ï¼Œä¹‹å‰ä¸€æ¬¡ä¿å­˜çš„Contextä»¥åŠä¹‹å‰çš„å­˜çš„å†…æ ¸å‡½æ•°æ ˆå°±ä¼šè¢«è¦†å†™ã€‚
- æˆ‘ä»¬ä¸æ¶‰åŠä¸­æ–­åµŒå¥—çš„é—®é¢˜

æ‰€ä»¥è¦åœ¨è¿›å…¥`__am_asm_trap`åæŠŠ`æ€`è®¾ç½®ä¸º`å†…æ ¸æ€`

```c
ebreak or æ—¶é’Ÿä¸­æ–­
__am_asm_trap {
  if (æ€ is ç”¨æˆ·æ€) {
    Context.usp = $sp;
    $sp = ksp;
  }

  Context.nextæ€ = æ€;

  æ€ = å†…æ ¸æ€; // support re-entry of CTE

  // save context
  // ...

  __am_irq_handle(c);

  // restore context
  // ...

  æ€ = Context.nextæ€;
  if (æ€ == ç”¨æˆ·æ€) {
    ksp = $sp;
    $sp = Context.usp;
  }
}
```

ä¸€äº›ç®€åŒ–ï¼Œç”¨`ksp == 0`æ¥ä»£è¡¨å½“å‰çš„`æ€`ï¼š
- è‹¥å½“å‰ä½äºç”¨æˆ·æ€, åˆ™kspçš„å€¼ä¸ºå†…æ ¸æ ˆçš„æ ˆåº•
- è‹¥å½“å‰ä½äºå†…æ ¸æ€, åˆ™kspçš„å€¼ä¸º0

è¿˜æœ‰å°±æ˜¯Contexté‡Œçš„`sp`åœ°æ–¹ä¸€ç›´æ²¡æœ‰ç”¨è¿‡ï¼ˆå›é¡¾[ä¿å­˜ä¸Šä¸‹æ–‡](#ä¿å­˜ä¸Šä¸‹æ–‡)ï¼‰ï¼Œè¿™é‡Œå°±å¯ä»¥æŠŠ`Context.usp`è®¾ç½®åˆ°`sp`å¤„

```c
ebreak or æ—¶é’Ÿä¸­æ–­
__am_asm_trap {
  Context.sp = $sp; // spæ˜¯è¿›å…¥trapæ—¶è¿›ç¨‹/çº¿ç¨‹çš„æ ˆé¡¶ï¼ŒContext.spä¿å­˜è¿™ä¸ªå€¼ï¼Œåœ¨é€€å‡ºtrapæ—¶è®©spæ¢å¤è¿™ä¸ªå€¼
  if (ksp != 0) {
    $sp = ksp;
  }

  Context.nextæ€ = (ksp == 0 ? å†…æ ¸æ€ : ç”¨æˆ·æ€);

  ksp = 0;

  // save context
  // ...

  __am_irq_handle(c);

  // restore context
  // ...

  if (Context.nextæ€ == ç”¨æˆ·æ€) {
    ksp = $sp;
  }
  $sp = Context.sp; // spæ¢å¤ä¸ºè¿›ç¨‹/çº¿ç¨‹çš„æ ˆé¡¶ï¼ˆè‹¥æ˜¯ä»__am_irq_handleæ–°å»ºè¿›ç¨‹/çº¿ç¨‹å‡ºæ¥çš„ï¼Œåˆ™Context.spæ˜¯åœ¨kcontext()/ucontext()è®¾ç½®çš„å€¼ï¼‰
}
```

> The mscratch register is an MXLEN-bit read/write register dedicated for use by machine mode. Typically, it is used to hold a pointer to a machine-mode hart-local context space and swapped with a user register upon entry to an M-mode trap handler.
>
> è¿™ä¸ª`mscratch`å¯„å­˜å™¨å°±æ˜¯ä¸ºäº†å­˜å†…æ ¸æ ˆåœ°å€çš„

è¿™ä¸ªä»»åŠ¡è¦åœ¨`trap.S`ä¸­å†™å¾ˆå¤šæŒ‡ä»¤ï¼Œææ¸…æ¥šæ‰€æœ‰ç»†èŠ‚åå†å»å†™ã€‚è°¢å¤©è°¢åœ°ï¼Œä¸€éè¿‡ï¼ŒçœŸä¸æ•¢æƒ³è±¡å‡ºé”™ååœ¨ä¸€å †æ±‡ç¼–ä»£ç ä¸­æ‰¾bugçš„ç—›è‹¦â€¦â€¦

å†™å®Œåè¿è¡Œèµ·æ¥å…¶å®è·Ÿä¹‹å‰æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œè¦éªŒè¯çš„è¯ï¼Œå°±åœ¨`__am_irq_handle`çš„å¼€å¤´æˆ–è€…`schedule`é‡Œæ‰“å°`Context*`ï¼Œå‘ç°ç¡®å®åœ¨`_stack_pointer`ä¹‹ä¸‹çš„æ•°æ®åŒºï¼š

```
_stack_pointer: 0x829F4000
pcb+2:          0x829DB000
pcb[1]->cp:     0x829DAF70
pcb+1:          0x829D3000
pcb[0]->cp:     0x829D2F70
pcb:            0x829CB000
```

## 4.5

### å±•ç¤ºä½ çš„è®¡ç®—æœºç³»ç»Ÿ

åˆ‡æ¢åˆ°å¦ä¸€ä¸ªå‰å°è¿›ç¨‹å¹¶ä¸ä¼šåˆ·æ–°å…¨å±ï¼Œæ¯•ç«Ÿè¿™å¹¶ä¸æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸åº”è¯¥å…³å¿ƒçš„äº‹æƒ…

å¾ˆå¥‡æ€ªï¼ŒåŠ è½½ä¸¤ä¸ªpalåå¿«é€Ÿåˆ‡æ¢è¿™ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¼šå‡ºç°`address (0xa1075300) is out of bound at pc = 0x800023fc`çš„é”™è¯¯ï¼Œæ˜¯åœ¨`find_mapid_by_addr()`æ‰¾ä¸åˆ°fbæ‰€å±çš„mapï¼Ÿï¼Ÿï¼Ÿæ€ä¹ˆå¯èƒ½æ‰¾ä¸åˆ°â“

### è¿è¡ŒONScripteræ¨¡æ‹Ÿå™¨

TODO

## å¿…ç­”é¢˜

- åˆ†æ—¶å¤šä»»åŠ¡çš„å…·ä½“è¿‡ç¨‹ è¯·ç»“åˆä»£ç , è§£é‡Šåˆ†é¡µæœºåˆ¶å’Œç¡¬ä»¶ä¸­æ–­æ˜¯å¦‚ä½•æ”¯æ’‘ä»™å‰‘å¥‡ä¾ ä¼ å’Œhelloç¨‹åºåœ¨æˆ‘ä»¬çš„è®¡ç®—æœºç³»ç»Ÿ(Nanos-lite, AM, NEMU)ä¸­åˆ†æ—¶è¿è¡Œçš„.
  æˆ‘åˆæ‡’å¾—å›ç­”äº†ã€‚åªè¦æ¯è¡Œä»£ç ã€æ¯å¥æŒ‡ä»¤ï¼Œä¸€æ­¥ä¸€æ­¥æ¨æ¼”ï¼Œå°±èƒ½è§£é‡Šè¿™ä¸ªé—®é¢˜ï¼Œè¯¦ç»†çš„è§£é‡Šå‰é¢éƒ½å·²ç»å†™è¿‡äº†ã€‚
- ç†è§£è®¡ç®—æœºç³»ç»Ÿ å°è¯•åœ¨Linuxä¸­ç¼–å†™å¹¶è¿è¡Œä»¥ä¸‹ç¨‹åº:
  ```c
  int main() {
    char *p = "abc";
    p[0] = 'A';
    return 0;
  }
  ```
  ä½ ä¼šçœ‹åˆ°ç¨‹åºå› ä¸ºå¾€åªè¯»å­—ç¬¦ä¸²è¿›è¡Œå†™å…¥è€Œè§¦å‘äº†æ®µé”™è¯¯. è¯·ä½ æ ¹æ®å­¦ä¹ çš„çŸ¥è¯†å’Œå·¥å…·, ä»ç¨‹åº, ç¼–è¯‘å™¨, é“¾æ¥å™¨, è¿è¡Œæ—¶ç¯å¢ƒ, æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ç­‰è§†è§’åˆ†æ"å­—ç¬¦ä¸²çš„å†™ä¿æŠ¤æœºåˆ¶æ˜¯å¦‚ä½•å®ç°çš„". æ¢å¥è¯è¯´, ä¸Šè¿°ç¨‹åºåœ¨æ‰§è¡Œp[0] = 'A'çš„æ—¶å€™, è®¡ç®—æœºç³»ç»Ÿç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆè€Œå¼•å‘æ®µé”™è¯¯? è®¡ç®—æœºç³»ç»Ÿåˆæ˜¯å¦‚ä½•ä¿è¯æ®µé”™è¯¯ä¼šå‘ç”Ÿ? å¦‚ä½•ä½¿ç”¨åˆé€‚çš„å·¥å…·æ¥è¯æ˜ä½ çš„æƒ³æ³•?

  TODO

# äºŒå‘¨ç›®é—®é¢˜

- 1.2 å¦‚æœæ²¡æœ‰å¯„å­˜å™¨, è®¡ç®—æœºè¿˜å¯ä»¥å·¥ä½œå—? å¦‚æœå¯ä»¥, è¿™ä¼šå¯¹ç¡¬ä»¶æä¾›çš„ç¼–ç¨‹æ¨¡å‹æœ‰ä»€ä¹ˆå½±å“å‘¢?
  å°±ç®—ä½ æ˜¯äºŒå‘¨ç›®æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜, ä½ ä¹Ÿæœ‰å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡å¬åˆ°"ç¼–ç¨‹æ¨¡å‹"è¿™ä¸ªæ¦‚å¿µ. ä¸è¿‡å¦‚æœä¸€å‘¨ç›®çš„æ—¶å€™ä½ å·²ç»ä»”ç»†åœ°é˜…è¯»è¿‡ISAæ‰‹å†Œ, ä½ ä¼šè®°å¾—ç¡®å®æœ‰è¿™ä¹ˆä¸ªæ¦‚å¿µ. æ‰€ä»¥, å¦‚æœæƒ³çŸ¥é“ä»€ä¹ˆæ˜¯ç¼–ç¨‹æ¨¡å‹, RTFMå§.
- 1.3 å¯¹äºGNU/Linuxä¸Šçš„ä¸€ä¸ªç¨‹åº, æ€ä¹ˆæ ·æ‰ç®—å¼€å§‹? æ€ä¹ˆæ ·æ‰ç®—æ˜¯ç»“æŸ? å¯¹äºåœ¨NEMUä¸­è¿è¡Œçš„ç¨‹åº, é—®é¢˜çš„ç­”æ¡ˆåˆæ˜¯ä»€ä¹ˆå‘¢?
- 1.4 æˆ‘ä»¬åœ¨è¡¨è¾¾å¼æ±‚å€¼ä¸­çº¦å®š, æ‰€æœ‰è¿ç®—éƒ½æ˜¯æ— ç¬¦å·è¿ç®—. ä½ çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™æ ·çº¦å®šå—? å¦‚æœè¿›è¡Œæœ‰ç¬¦å·è¿ç®—, æœ‰å¯èƒ½ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜?
- 1.6 å¦‚æœä½ åœ¨è¿è¡Œç¨å¤§ä¸€äº›çš„ç¨‹åº(å¦‚microbench)çš„æ—¶å€™ä½¿ç”¨æ–­ç‚¹, ä½ ä¼šå‘ç°è®¾ç½®æ–­ç‚¹ä¹‹åä¼šæ˜æ˜¾åœ°é™ä½NEMUæ‰§è¡Œç¨‹åºçš„æ•ˆç‡. æ€è€ƒä¸€ä¸‹è¿™æ˜¯ä¸ºä»€ä¹ˆ? æœ‰ä»€ä¹ˆæ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜å—?
ä¸æ­¤ç›¸å…³çš„é—®é¢˜è¿˜æœ‰: NEMUä¸­ä¸ºä»€ä¹ˆè¦æœ‰nemu_trap? ä¸ºä»€ä¹ˆè¦æœ‰monitor?
- 1.6 [How debuggers work](https://eli.thegreenplace.net/2011/01/23/how-debuggers-work-part-1/)
- 2.3 ä¸ºä»€ä¹ˆè¦æœ‰AMï¼Ÿæ“ä½œç³»ç»Ÿä¹Ÿæœ‰è‡ªå·±çš„è¿è¡Œæ—¶ç¯å¢ƒ. AMå’Œæ“ä½œç³»ç»Ÿæä¾›çš„è¿è¡Œæ—¶ç¯å¢ƒæœ‰ä»€ä¹ˆä¸åŒå‘¢? ä¸ºä»€ä¹ˆä¼šæœ‰è¿™äº›ä¸åŒ?
  
  è§[å…³äºAM](#å…³äºAM)
- 2.5 è¯»am-kernelsä¸­çš„LiteNES
- 3.1 ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿ?
- 3.2 è¿™äº›ç¨‹åºçŠ¶æ€(x86çš„eflags, cs, eip; mips32çš„epc, status, cause; riscv32çš„mepc, mstatus, mcause)å¿…é¡»ç”±ç¡¬ä»¶æ¥ä¿å­˜å—? èƒ½å¦é€šè¿‡è½¯ä»¶æ¥ä¿å­˜? ä¸ºä»€ä¹ˆ?
- 4.2 å®ç°åŸºäºPIEçš„loader
- 4.4 æˆ‘ä»¬åœ¨PA3ä¸­çŸ¥é“printf()ä¼šé€šè¿‡malloc()ç”³è¯·ç¼“å†²åŒº, è€Œmalloc()åˆå¯èƒ½ä¼šæ‰§è¡Œ_sbrk(), é€šè¿‡SYS_brké™·å…¥å†…æ ¸; åœ¨ä¸Šä¸€ä¸ªé˜¶æ®µä¸­, æˆ‘ä»¬å®ç°äº†æ”¯æŒåˆ†é¡µæœºåˆ¶çš„mm_brk(), åœ¨å¿…è¦çš„æ—¶å€™å®ƒä¼šé€šè¿‡new_page()ç”³è¯·ä¸€é¡µ. è€Œä»™å‰‘å’Œhelloç”¨æˆ·è¿›ç¨‹éƒ½ä¼šè°ƒç”¨printf(), ä½¿å¾—å®ƒä»¬å¯èƒ½ä¼šå¹¶å‘æ‰§è¡ŒSYS_brk. æ€è€ƒä¸€ä¸‹, ç›®å‰Nanos-liteçš„è®¾è®¡ä¼šå¯¼è‡´å¹¶å‘bugå—? ä¸ºä»€ä¹ˆ?

  ä¸ä¼šã€‚æˆ‘ä»¬çš„æ—¶é’Ÿä¸­æ–­åæ˜¯å…³ä¸­æ–­çš„ï¼Œåªæœ‰ç­‰ç¬¬ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨å®Œ`printf()`ï¼Œæ‰ä¼šå¼€ä¸­æ–­ï¼Œæ‰å¯èƒ½é€šè¿‡æ—¶é’Ÿä¸­æ–­åˆ‡æ¢ç¬¬äºŒä¸ªè¿›ç¨‹é‡Œè¿›è¡Œ`printf()`ã€‚

TODO:
- note.mdä¸­æ£€æŸ¥æ‰€æœ‰æåˆ°â€œæ“ä½œç³»ç»Ÿâ€çš„è¯­å¥ä¸¥è°¨æ€§
- æ•´ç†é‚£äº›é«˜çº§çš„cè¯­è¨€ç”¨æ³•åˆ°ç¬”è®°
- çœ‹çœ‹åˆ«äººçš„SDL Audioå®ç°
- æ‰€æœ‰çš„å°é—®å·â“
- æ‰€æœ‰çš„TODO
- ç½‘é¡µè½¬æ¢ä¸ºmdï¼Œæ–‡æ¡£é‡Œçš„åšäº‹æ–¹æ³•å’ŒåŸåˆ™
